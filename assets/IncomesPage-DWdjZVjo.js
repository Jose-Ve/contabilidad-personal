import{r as n,a as g,j as s}from"./index-BnMz-dVJ.js";import{u as Be,F as qe}from"./index.esm-BOEet2oi.js";import{A as He,C as be}from"./AccountSelector-CoiZYhMJ.js";import{f as Ke}from"./accounts-62zbDqcc.js";const fe=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Xe=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),pe=o=>{if(!o)return"";const d=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(o);if(!d)return new Date(o).toLocaleDateString("es-NI");const[,b,u,N]=d;return new Date(Number(b),Number(u)-1,Number(N)).toLocaleDateString("es-NI")},Ze=o=>{if(!o)return"";const[d,b]=o.split("-"),u=new Date(Number(d),Number(b)-1,1),N=Xe.format(u);return N.charAt(0).toUpperCase()+N.slice(1)},z=36.7,ae=o=>`${o??""}`.toUpperCase()==="NIO",Je=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],Qe=Je.reduce((o,d)=>(o[d.value]=d.label,o),{}),F=10;function as(){const[o,d]=n.useState([]),[b,u]=n.useState([]),[N,B]=n.useState(!0),[ne,r]=n.useState(null),[m,A]=n.useState({from:"",to:"",category_id:""}),[T,I]=n.useState("list"),[q,te]=n.useState(!1),[O,C]=n.useState(null),[h,ye]=n.useState([]),[f,H]=n.useState(null),[xe,K]=n.useState(!1),[P,oe]=n.useState(!1),[S,X]=n.useState(null),[Z,U]=n.useState(""),[y,ce]=n.useState(!1),[x,J]=n.useState(null),[_e,Q]=n.useState(!1),[D,ie]=n.useState(!1),[R,_]=n.useState(null),[j,$]=n.useState(1),[V,W]=n.useState(null),re=n.useRef(!1),je=n.useCallback(async()=>{try{const e=await g("/categories?type=income");u(e??[])}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudieron cargar las categor√≠as";r(a)}},[]),v=n.useCallback(()=>({amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}),[]),le=Be({defaultValues:v()}),{register:w,handleSubmit:Ne,reset:M,watch:Ce,setValue:me,formState:{isSubmitting:Y}}=le,de=Ce("source"),Se=n.useCallback(({source:e,account:a})=>{e==="bank"&&a?(_(a),me("currency",a.currency,{shouldValidate:!0,shouldDirty:!0})):_(null)},[me]);n.useEffect(()=>{de!=="bank"&&_(null)},[de]);const De=R?.currency??null,E=n.useCallback(async(e={})=>{B(!0);try{const a=new URLSearchParams;e.from&&a.set("from",e.from),e.to&&a.set("to",e.to),e.category_id&&a.set("category_id",e.category_id);const[t,i]=await Promise.all([g(`/incomes${a.toString()?`?${a.toString()}`:""}`),g("/categories?type=income")]);d(t??[]),u(i??[]),r(null),$(1)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudieron cargar los ingresos";r(t)}finally{B(!1)}},[]);n.useEffect(()=>{re.current||(re.current=!0,E(m))},[m,E]);const ue=n.useCallback(e=>{const a=v();return e?{...a,amount:e.amount!==null&&e.amount!==void 0?`${e.amount}`:a.amount,currency:e.currency??a.currency,source:e.source??a.source,account_id:e.source==="bank"?e.account_id??"":"",date:e.date?e.date.slice(0,10):a.date,category_id:e.category_id?`${e.category_id}`:"",note:e.note??""}:a},[v]),he=n.useCallback(()=>{W(null),_(null),M(v()),r(null)},[v,M,r]),ve=n.useCallback(e=>{if(!e)return;W(e.id);const a=ue(e);M(a,{keepDirty:!1,keepTouched:!1}),_(e.source==="bank"?e.account??null:null),I("add"),r(null)},[ue,M,I,r,_]),Ee=async e=>{const a=!!V;try{const t=e.source==="bank"&&e.account_id||null,c=(e.source==="bank"&&R&&R.id===t?R:null)?.currency??e.currency,l={amount:Number(e.amount),currency:c,source:e.source,account_id:t,date:e.date,category_id:e.category_id||null,note:e.note??null};a?await g(`/incomes/${V}`,{method:"PUT",body:l}):await g("/incomes",{method:"POST",body:l}),M(v()),_(null),W(null),await E(m),I("list")}catch(t){console.error(t);const i=t.payload?.message??t.message??(a?"No se pudo actualizar el ingreso":"No se pudo registrar el ingreso");r(i)}},ke=n.useCallback(e=>{H(e),K(!0)},[]),Fe=n.useCallback(()=>{P||(K(!1),H(null))},[P]),Ie=n.useCallback(async()=>{if(f){oe(!0);try{await g(`/incomes/${f.id}`,{method:"DELETE"}),d(e=>e.filter(a=>a.id!==f.id)),K(!1),H(null)}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudo eliminar el ingreso";r(a)}finally{oe(!1)}}},[f]),$e=n.useCallback(e=>{X(e.id),U(e.name??"")},[]),we=n.useCallback(()=>{y||(X(null),U(""))},[y]),Me=n.useCallback(async()=>{if(!S)return;const e=Z.trim();if(e.length<2){r("El nombre debe tener al menos 2 caracteres.");return}ce(!0);try{await g(`/categories/${S}`,{method:"PUT",body:{name:e,type:"income"}}),u(a=>a.map(t=>t.id===S?{...t,name:e}:t)),d(a=>a.map(t=>t.category_id===S?{...t,category_name:e}:t)),X(null),U(""),r(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";r(t)}finally{ce(!1)}},[Z,S]),Le=n.useCallback(e=>{J(e),Q(!0)},[]),Ae=n.useCallback(()=>{D||(Q(!1),J(null))},[D]),Te=n.useCallback(async()=>{if(x){ie(!0);try{await g(`/categories/${x.id}`,{method:"DELETE"}),u(e=>e.filter(a=>a.id!==x.id)),d(e=>e.map(a=>a.category_id===x.id?{...a,category_id:null,category_name:null}:a)),Q(!1),J(null),r(null)}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudo eliminar la categor√≠a";r(a)}finally{ie(!1)}}},[x]),k=n.useMemo(()=>o.reduce((e,a)=>{const t=Number(a.amount??0),i=ae(a.currency),c=i?t/z:t,l=i?t:t*z;e.usd+=c,e.nio+=l;const p=a.source==="bank"?"bank":"cash";return e[p].usd+=c,e[p].nio+=l,e},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),ge=n.useMemo(()=>{if(!o.length)return[];const e=new Map;for(const a of o){if(!a?.date)continue;const t=a.date.slice(0,7);e.has(t)||e.set(t,{usd:0,nio:0,count:0});const i=e.get(t),c=Number(a.amount??0),l=ae(a.currency),p=l?c/z:c,ze=l?c:c*z;i.usd+=p,i.nio+=ze,i.count+=1}return Array.from(e.entries()).map(([a,t])=>({month:a,label:Ze(a),usd:t.usd,nio:t.nio,count:t.count})).sort((a,t)=>a.month<t.month?1:-1)},[o]);n.useEffect(()=>{!m.from&&!m.to&&!m.category_id&&ye(ge)},[ge,m]),n.useEffect(()=>{if(!h.length){C(null);return}C(e=>e&&h.some(a=>a.month===e)?e:h[0].month)},[h]),n.useEffect(()=>{if(!o.length){$(1);return}const e=Math.max(1,Math.ceil(o.length/F));$(a=>!Number.isFinite(a)||a<1?1:a>e?e:a)},[o]);const G=n.useMemo(()=>O?h.find(e=>e.month===O)??null:null,[h,O]),ee=n.useMemo(()=>Math.max(1,Math.ceil(o.length/F)),[o]),Oe=n.useMemo(()=>{if(!o.length)return[];const e=(j-1)*F;return o.slice(e,e+F)},[j,o]),Pe=o.length?(j-1)*F+1:0,Ue=o.length?Math.min(o.length,j*F):0,Re=n.useMemo(()=>h.map(e=>({value:e.month,label:`${e.label} ¬∑ ${e.count} ${e.count===1?"mov.":"movs."}`})),[h]),se=n.useCallback(e=>{const{name:a,value:t}=e.target;A(i=>({...i,[a]:t})),(a==="from"||a==="to")&&C(null)},[A,C]),Ve=e=>{const[a,t]=e.split("-"),i=new Date(Number(a),Number(t)-1,1),c=new Date(Number(a),Number(t),0),l=i.toISOString().slice(0,10),p=c.toISOString().slice(0,10);return{from:l,to:p}},Ge=n.useCallback(e=>{const a=Ve(e),t={from:a.from,to:a.to,category_id:m.category_id};C(e),A(t),E(t)},[m.category_id,E,A]),L=!!V;return s.jsxs("section",{className:"incomes",children:[s.jsxs("header",{className:"incomes__header",children:[s.jsxs("div",{className:"incomes__heading",children:[s.jsx("h1",{children:"Ingresos"}),s.jsx("p",{children:"Consulta, registra y organiza tus ingresos."}),s.jsx("nav",{className:"incomes__tabs incomes__actions",children:[{id:"list",label:"Lista de ingresos",icon:"üìã"},{id:"add",label:"Agregar ingreso",icon:"‚ûï"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(e=>s.jsxs("button",{type:"button",onClick:()=>{e.id!=="add"&&V&&he(),I(e.id)},className:`incomes__tab ${T===e.id?"incomes__tab--active":""}`,children:[s.jsx("span",{"aria-hidden":!0,children:e.icon}),e.label]},e.id))})]}),s.jsxs("div",{className:"incomes__summary",children:[s.jsx("span",{className:"incomes__summary-label",children:"Total estimado"}),s.jsxs("strong",{className:"incomes__summary-value incomes__summary-value--nio",children:["C$",k.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),s.jsxs("strong",{className:"incomes__summary-value",children:["$",k.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),s.jsxs("span",{className:"incomes__summary-detail",children:["Cuenta bancaria: C$",k.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",k.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),s.jsxs("span",{className:"incomes__summary-detail",children:["Efectivo: C$",k.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",k.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),ne?s.jsx("p",{className:"incomes__error",children:ne}):null,T==="list"?s.jsxs("article",{className:"incomes-card",children:[s.jsx("header",{className:"incomes-card__header",children:s.jsxs("div",{className:"incomes-card__heading",children:[s.jsxs("h2",{children:[s.jsx("span",{role:"img","aria-hidden":!0,children:"üìë"}),"Lista de ingresos"]}),s.jsx("p",{children:"Filtra por fechas o categor√≠as para encontrar movimientos espec√≠ficos."})]})}),h.length>0?s.jsxs("section",{className:"incomes-monthly",children:[s.jsx("div",{className:"incomes-monthly__aside",children:s.jsxs("label",{className:"incomes-monthly__picker",children:[s.jsx("span",{children:"Mes y a√±o"}),s.jsx("select",{className:"incomes-monthly__select",value:O??"",onChange:e=>{const{value:a}=e.target;a&&Ge(a)},children:Re.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})}),s.jsx("div",{className:"incomes-monthly__summary",children:G?s.jsxs("div",{className:"incomes-monthly-total",children:[s.jsxs("span",{className:"incomes-monthly-total__label",children:["Total del mes seleccionado (",G.label,")"]}),s.jsxs("div",{className:"incomes-monthly-total__values",children:[s.jsxs("strong",{className:"incomes-monthly-total__amount incomes-monthly-total__amount--nio",children:["C$",fe(G.nio)]}),s.jsxs("strong",{className:"incomes-monthly-total__amount",children:["$",fe(G.usd)," USD"]})]})]}):s.jsx("p",{className:"incomes-card__placeholder incomes-monthly__placeholder",children:"Selecciona un mes para ver el resumen."})})]}):null,N?s.jsx("p",{className:"incomes-card__placeholder",children:"Cargando ingresos..."}):o.length===0?s.jsx("p",{className:"incomes-card__placeholder",children:"No hay ingresos registrados con los filtros actuales."}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"incomes-table__wrapper",children:s.jsxs("table",{className:"incomes-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Fecha"}),s.jsx("th",{children:"Monto"}),s.jsx("th",{children:"Origen"}),s.jsx("th",{children:"Categor√≠a"}),s.jsx("th",{children:"Nota"}),s.jsx("th",{className:"incomes-table__actions",children:"Acciones"})]})}),s.jsx("tbody",{children:Oe.map(e=>s.jsxs("tr",{children:[s.jsx("td",{children:pe(e.date)}),s.jsxs("td",{className:"incomes-table__amount",children:[ae(e.currency)?"C$":"$",Number(e.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),s.jsx("td",{children:e.source==="bank"?Ke(e.account)||"Cuenta bancaria":Qe[e.source??"cash"]}),s.jsx("td",{children:e.category_name??"Sin categor√≠a"}),s.jsx("td",{className:"incomes-table__note",children:e.note??"-"}),s.jsxs("td",{className:"incomes-table__actions",children:[s.jsx("button",{onClick:()=>ve(e),className:"incomes-table__edit",children:"Editar"}),s.jsx("button",{onClick:()=>ke(e),className:"incomes-table__delete",children:"Eliminar"})]})]},e.id))})]})}),s.jsxs("div",{className:"incomes-pagination",children:[s.jsxs("span",{className:"incomes-pagination__info",children:["Mostrando ",Pe,"-",Ue," de ",o.length," ingresos"]}),s.jsxs("div",{className:"incomes-pagination__controls",children:[s.jsx("button",{type:"button",className:"incomes-pagination__button",onClick:()=>$(e=>Math.max(1,e-1)),disabled:j===1,children:"Anterior"}),s.jsxs("span",{className:"incomes-pagination__status",children:["P√°gina ",j," de ",ee]}),s.jsx("button",{type:"button",className:"incomes-pagination__button",onClick:()=>$(e=>Math.min(ee,e+1)),disabled:j===ee||!o.length,children:"Siguiente"})]})]})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault(),C(null),E({...m})},className:"incomes-filters incomes-filters--footer",children:[s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Desde"}),s.jsx("input",{name:"from",type:"date",value:m.from,onChange:se,className:"incomes-input"})]}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Hasta"}),s.jsx("input",{name:"to",type:"date",value:m.to,onChange:se,className:"incomes-input"})]}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Categor√≠a"}),s.jsxs("select",{name:"category_id",value:m.category_id,onChange:se,className:"incomes-input",children:[s.jsx("option",{value:"",children:"Todas"}),b.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsx("button",{type:"submit",className:"incomes-button",children:"Aplicar filtros"})]})]}):null,T==="add"?s.jsx(qe,{...le,children:s.jsxs("form",{onSubmit:Ne(Ee),className:"incomes-card incomes-form",children:[s.jsxs("div",{className:"incomes-form__intro",children:[s.jsx("h2",{children:L?"Editar ingreso":"Registrar ingreso"}),s.jsx("p",{children:L?"Actualiza los datos del movimiento seleccionado.":"Completa el formulario para registrar un nuevo movimiento."})]}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Monto"}),s.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...w("amount"),className:"incomes-input"})]}),s.jsx(He,{sourceField:"source",accountField:"account_id",label:"Origen del ingreso",accountLabel:"Cuenta bancaria",fieldClass:"incomes-field",accountFieldClass:"incomes-field",sourceSelectClass:"incomes-input",accountSelectClass:"incomes-input",containerClass:"incomes-account-selector",onAccountChange:Se}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Moneda"}),s.jsxs("select",{...w("currency"),className:"incomes-input",disabled:!!De,children:[s.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),s.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Fecha"}),s.jsx("input",{type:"date",required:!0,...w("date"),className:"incomes-input"})]}),s.jsxs("label",{className:"incomes-field",children:[s.jsx("span",{children:"Categor√≠a"}),s.jsxs("select",{...w("category_id"),className:"incomes-input",children:[s.jsx("option",{value:"",children:"Sin categor√≠a"}),b.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("label",{className:"incomes-field incomes-field--full",children:[s.jsx("span",{children:"Nota"}),s.jsx("textarea",{rows:3,placeholder:"Detalles opcionales",...w("note"),className:"incomes-textarea"})]}),s.jsxs("div",{className:"incomes-form__actions",children:[s.jsx("button",{type:"submit",disabled:Y,className:"incomes-button incomes-button--primary",children:Y?L?"Guardando cambios...":"Guardando...":L?"Actualizar ingreso":"Guardar ingreso"}),L?s.jsx("button",{type:"button",className:"incomes-button incomes-button--ghost",disabled:Y,onClick:()=>{he(),I("list")},children:"Cancelar edici√≥n"}):null]})]})}):null,T==="category"?s.jsxs("section",{className:"incomes-card incomes-category",children:[s.jsxs("div",{className:"incomes-category__intro",children:[s.jsx("h2",{children:"Nueva categor√≠a de ingreso"}),s.jsx("p",{children:"Agrupa tus movimientos con categor√≠as creadas a medida."})]}),s.jsxs("form",{onSubmit:async e=>{e.preventDefault();const a=e.currentTarget,i=`${new FormData(a).get("name")??""}`.trim();if(i)try{te(!0);const c=await g("/categories",{method:"POST",body:{name:i,type:"income"}});a.reset(),c?u(l=>[c,...l.filter(p=>p.id!==c.id)]):await je(),r(null)}catch(c){console.error(c);const l=c.payload?.message??c.message??"No se pudo crear la categor√≠a";r(l)}finally{te(!1)}},className:"incomes-category__form",children:[s.jsxs("label",{className:"incomes-field incomes-category__field",children:[s.jsx("span",{children:"Nombre"}),s.jsx("input",{name:"name",type:"text",placeholder:"Salarios, ventas, freelance...",required:!0,className:"incomes-input"})]}),s.jsx("button",{type:"submit",disabled:q,className:`incomes-button incomes-button--primary ${q?"is-disabled":""}`,children:q?"Creando...":"Crear categor√≠a"})]}),s.jsxs("div",{className:"incomes-category__list",children:[s.jsxs("div",{className:"incomes-category__list-header",children:[s.jsx("h3",{children:"Mis categor√≠as"}),s.jsx("p",{children:"Administra los nombres que aparecen en tus ingresos y re√∫salos cuando los necesites."})]}),b.length===0?s.jsx("p",{className:"incomes-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):s.jsx("ul",{className:"incomes-category__items",children:b.map(e=>s.jsx("li",{className:"incomes-category__item",children:S===e.id?s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"text",value:Z,onChange:a=>U(a.target.value),className:"incomes-input incomes-category__input",autoFocus:!0}),s.jsxs("div",{className:"incomes-category__actions",children:[s.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--primary",onClick:Me,disabled:y,children:y?"Guardando‚Ä¶":"Guardar"}),s.jsx("button",{type:"button",className:"incomes-category__button",onClick:we,disabled:y,children:"Cancelar"})]})]}):s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"incomes-category__name",children:e.name}),s.jsxs("div",{className:"incomes-category__actions",children:[s.jsx("button",{type:"button",className:"incomes-category__button",onClick:()=>$e(e),disabled:y||D,children:"Editar"}),s.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--danger",onClick:()=>Le(e),disabled:y||D,children:"Eliminar"})]})]})},e.id))})]})]}):null,s.jsx(be,{open:xe,title:"Eliminar ingreso",message:f?`Eliminar√°s el ingreso del ${pe(f.date)} por ${f.currency==="NIO"?"C$":"$"}${Number(f.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:P?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:P,onConfirm:Ie,onCancel:Fe}),s.jsx(be,{open:_e,title:"Eliminar categor√≠a",message:x?`¬øDeseas eliminar la categor√≠a ‚Äú${x.name}‚Äù? Los ingresos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:D?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:D,onConfirm:Te,onCancel:Ae})]})}export{as as default};
