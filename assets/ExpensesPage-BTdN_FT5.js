import{r as n,a as p,j as s}from"./index-BnMz-dVJ.js";import{u as Be,F as qe}from"./index.esm-BOEet2oi.js";import{A as He,C as pe}from"./AccountSelector-CoiZYhMJ.js";import{f as Ke}from"./accounts-62zbDqcc.js";const he=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Xe=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),ge=o=>{if(!o)return"";const u=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(o);if(!u)return new Date(o).toLocaleDateString("es-NI");const[,h,m,r]=u;return new Date(Number(h),Number(m)-1,Number(r)).toLocaleDateString("es-NI")},Ze=o=>{if(!o)return"";const[u,h]=o.split("-"),m=new Date(Number(u),Number(h)-1,1),r=Xe.format(m);return r.charAt(0).toUpperCase()+r.slice(1)},G=36.7,ee=o=>`${o??""}`.toUpperCase()==="NIO",Je=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],Qe=Je.reduce((o,u)=>(o[u.value]=u.label,o),{}),k=10;function as(){const[o,u]=n.useState([]),[h,m]=n.useState([]),[r,F]=n.useState({from:"",to:"",category_id:""}),[be,se]=n.useState(!0),[ae,i]=n.useState(null),[A,$]=n.useState("list"),[z,ne]=n.useState(!1),[T,N]=n.useState(null),[x,fe]=n.useState([]),[g,B]=n.useState(null),[ye,q]=n.useState(!1),[O,te]=n.useState(!1),[C,H]=n.useState(null),[K,P]=n.useState(""),[f,oe]=n.useState(!1),[y,X]=n.useState(null),[_e,Z]=n.useState(!1),[S,le]=n.useState(!1),[U,_]=n.useState(null),[j,w]=n.useState(1),[V,J]=n.useState(null),re=n.useRef(!1),je=n.useCallback(async()=>{try{const e=await p("/categories?type=expense");m(e??[])}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudieron cargar las categor√≠as";i(a)}},[]),D=n.useCallback(()=>({amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}),[]),ce=Be({defaultValues:D()}),{register:M,handleSubmit:Ne,reset:I,watch:Ce,setValue:ie,formState:{isSubmitting:Q}}=ce,E=n.useCallback(async(e={})=>{se(!0);try{const a=new URLSearchParams;e.from&&a.set("from",e.from),e.to&&a.set("to",e.to),e.category_id&&a.set("category_id",e.category_id);const t=a.toString(),[c,l]=await Promise.all([p(`/expenses${t?`?${t}`:""}`),p("/categories?type=expense")]);u(c??[]),m(l??[]),i(null),w(1)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudieron cargar los gastos";i(t)}finally{se(!1)}},[]);n.useEffect(()=>{re.current||(re.current=!0,E(r))},[r,E]);const de=n.useCallback(e=>{const a=D();return e?{...a,amount:e.amount!==null&&e.amount!==void 0?`${e.amount}`:a.amount,currency:e.currency??a.currency,source:e.source??a.source,account_id:e.source==="bank"?e.account_id??"":"",date:e.date?e.date.slice(0,10):a.date,category_id:e.category_id?`${e.category_id}`:"",note:e.note??""}:a},[D]),ue=n.useCallback(()=>{J(null),_(null),I(D()),i(null)},[D,I,i]),Se=n.useCallback(e=>{if(!e)return;J(e.id);const a=de(e);I(a,{keepDirty:!1,keepTouched:!1}),_(e.source==="bank"?e.account??null:null),$("add"),i(null)},[de,I,$,i,_]),me=Ce("source"),De=n.useCallback(({source:e,account:a})=>{e==="bank"&&a?(_(a),ie("currency",a.currency,{shouldValidate:!0,shouldDirty:!0})):_(null)},[ie]);n.useEffect(()=>{me!=="bank"&&_(null)},[me]);const Ee=U?.currency??null,ve=async e=>{const a=!!V;try{const t=e.source==="bank"&&e.account_id||null,l=(e.source==="bank"&&U&&U.id===t?U:null)?.currency??e.currency,d={amount:Number(e.amount),currency:l,source:e.source,account_id:t,date:e.date,category_id:e.category_id||null,note:e.note||null};a?await p(`/expenses/${V}`,{method:"PUT",body:d}):await p("/expenses",{method:"POST",body:d}),I(D()),_(null),J(null),await E(r),$("list")}catch(t){console.error(t);const c=t.payload?.message??t.message??(a?"No se pudo actualizar el gasto":"No se pudo registrar el gasto");i(c)}},ke=n.useCallback(e=>{B(e),q(!0)},[]),Fe=n.useCallback(()=>{O||(q(!1),B(null))},[O]),$e=n.useCallback(async()=>{if(g){te(!0);try{await p(`/expenses/${g.id}`,{method:"DELETE"}),u(e=>e.filter(a=>a.id!==g.id)),q(!1),B(null)}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudo eliminar el gasto";i(a)}finally{te(!1)}}},[g]),we=n.useCallback(e=>{H(e.id),P(e.name??"")},[]),Me=n.useCallback(()=>{f||(H(null),P(""))},[f]),Ie=n.useCallback(async()=>{if(!C)return;const e=K.trim();if(e.length<2){i("El nombre debe tener al menos 2 caracteres.");return}oe(!0);try{await p(`/categories/${C}`,{method:"PUT",body:{name:e,type:"expense"}}),m(a=>a.map(t=>t.id===C?{...t,name:e}:t)),u(a=>a.map(t=>t.category_id===C?{...t,category_name:e}:t)),H(null),P(""),i(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";i(t)}finally{oe(!1)}},[K,C]),Le=n.useCallback(e=>{X(e),Z(!0)},[]),Ae=n.useCallback(()=>{S||(Z(!1),X(null))},[S]),Te=n.useCallback(async()=>{if(y){le(!0);try{await p(`/categories/${y.id}`,{method:"DELETE"}),m(e=>e.filter(a=>a.id!==y.id)),u(e=>e.map(a=>a.category_id===y.id?{...a,category_id:null,category_name:null}:a)),Z(!1),X(null),i(null)}catch(e){console.error(e);const a=e.payload?.message??e.message??"No se pudo eliminar la categor√≠a";i(a)}finally{le(!1)}}},[y]),v=n.useMemo(()=>o.reduce((e,a)=>{const t=Number(a.amount??0),c=ee(a.currency),l=c?t/G:t,d=c?t:t*G;e.usd+=l,e.nio+=d;const b=a.source==="bank"?"bank":"cash";return e[b].usd+=l,e[b].nio+=d,e},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),xe=n.useMemo(()=>{if(!o.length)return[];const e=new Map;for(const a of o){if(!a?.date)continue;const t=a.date.slice(0,7);e.has(t)||e.set(t,{usd:0,nio:0,count:0});const c=e.get(t),l=Number(a.amount??0),d=ee(a.currency),b=d?l/G:l,ze=d?l:l*G;c.usd+=b,c.nio+=ze,c.count+=1}return Array.from(e.entries()).map(([a,t])=>({month:a,label:Ze(a),usd:t.usd,nio:t.nio,count:t.count})).sort((a,t)=>a.month<t.month?1:-1)},[o]);n.useEffect(()=>{!r.from&&!r.to&&!r.category_id&&fe(xe)},[xe,r]),n.useEffect(()=>{if(!x.length){N(null);return}N(e=>e&&x.some(a=>a.month===e)?e:x[0].month)},[x]),n.useEffect(()=>{if(!o.length){w(1);return}const e=Math.max(1,Math.ceil(o.length/k));w(a=>!Number.isFinite(a)||a<1?1:a>e?e:a)},[o]);const R=n.useMemo(()=>T?x.find(e=>e.month===T)??null:null,[x,T]),W=n.useMemo(()=>Math.max(1,Math.ceil(o.length/k)),[o]),Oe=n.useMemo(()=>{if(!o.length)return[];const e=(j-1)*k;return o.slice(e,e+k)},[j,o]),Pe=o.length?(j-1)*k+1:0,Ue=o.length?Math.min(o.length,j*k):0,Ve=n.useMemo(()=>x.map(e=>({value:e.month,label:`${e.label} ¬∑ ${e.count} ${e.count===1?"mov.":"movs."}`})),[x]),Y=n.useCallback(e=>{const{name:a,value:t}=e.target;F(c=>({...c,[a]:t})),(a==="from"||a==="to")&&N(null)},[F,N]),Re=e=>{const[a,t]=e.split("-"),c=new Date(Number(a),Number(t)-1,1),l=new Date(Number(a),Number(t),0),d=c.toISOString().slice(0,10),b=l.toISOString().slice(0,10);return{from:d,to:b}},Ge=n.useCallback(e=>{const a=Re(e),t={from:a.from,to:a.to,category_id:r.category_id};N(e),F(t),E(t)},[r.category_id,E,F]),L=!!V;return s.jsxs("section",{className:"expenses",children:[s.jsxs("header",{className:"expenses__header",children:[s.jsxs("div",{className:"expenses__heading",children:[s.jsx("h1",{children:"Gastos"}),s.jsx("p",{children:"Controla tus egresos diarios y clasif√≠calos f√°cilmente."}),s.jsx("nav",{className:"expenses__tabs expenses__actions",children:[{id:"list",label:"Lista de gastos",icon:"üìã"},{id:"add",label:"Agregar gasto",icon:"‚ûñ"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(e=>s.jsxs("button",{type:"button",onClick:()=>{e.id!=="add"&&V&&ue(),$(e.id)},className:`expenses__tab ${A===e.id?"expenses__tab--active":""}`,children:[s.jsx("span",{"aria-hidden":!0,children:e.icon}),e.label]},e.id))})]}),s.jsxs("div",{className:"expenses__summary",children:[s.jsx("span",{className:"expenses__summary-label",children:"Total estimado"}),s.jsxs("strong",{className:"expenses__summary-value expenses__summary-value--nio",children:["C$",v.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),s.jsxs("strong",{className:"expenses__summary-value",children:["$",v.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),s.jsxs("span",{className:"expenses__summary-detail",children:["Cuenta bancaria: C$",v.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",v.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),s.jsxs("span",{className:"expenses__summary-detail",children:["Efectivo: C$",v.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",v.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),ae?s.jsx("p",{className:"expenses__error",children:ae}):null,A==="list"?s.jsxs("article",{className:"expenses-card",children:[s.jsx("header",{className:"expenses-card__header",children:s.jsxs("div",{className:"expenses-card__heading",children:[s.jsxs("h2",{children:[s.jsx("span",{role:"img","aria-hidden":!0,children:"üí≥"}),"Lista de gastos"]}),s.jsx("p",{children:"Visualiza tus egresos y verifica el estado de tus categor√≠as."})]})}),x.length>0?s.jsxs("section",{className:"expenses-monthly",children:[s.jsx("div",{className:"expenses-monthly__aside",children:s.jsxs("label",{className:"expenses-monthly__picker",children:[s.jsx("span",{children:"Mes y a√±o"}),s.jsx("select",{className:"expenses-monthly__select",value:T??"",onChange:e=>{const{value:a}=e.target;a&&Ge(a)},children:Ve.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})}),s.jsx("div",{className:"expenses-monthly__summary",children:R?s.jsxs("div",{className:"expenses-monthly-total",children:[s.jsxs("span",{className:"expenses-monthly-total__label",children:["Total del mes seleccionado (",R.label,")"]}),s.jsxs("div",{className:"expenses-monthly-total__values",children:[s.jsxs("strong",{className:"expenses-monthly-total__amount expenses-monthly-total__amount--nio",children:["C$",he(R.nio)]}),s.jsxs("strong",{className:"expenses-monthly-total__amount",children:["$",he(R.usd)," USD"]})]})]}):s.jsx("p",{className:"expenses-card__placeholder expenses-monthly__placeholder",children:"Selecciona un mes para ver el resumen."})})]}):null,be?s.jsx("p",{className:"expenses-card__placeholder",children:"Cargando gastos..."}):o.length===0?s.jsx("p",{className:"expenses-card__placeholder",children:"No hay gastos registrados con los filtros actuales."}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"expenses-table__wrapper",children:s.jsxs("table",{className:"expenses-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Fecha"}),s.jsx("th",{children:"Monto"}),s.jsx("th",{children:"Origen"}),s.jsx("th",{children:"Categor√≠a"}),s.jsx("th",{children:"Nota"}),s.jsx("th",{className:"expenses-table__actions",children:"Acciones"})]})}),s.jsx("tbody",{children:Oe.map(e=>s.jsxs("tr",{children:[s.jsx("td",{children:ge(e.date)}),s.jsxs("td",{className:"expenses-table__amount",children:[ee(e.currency)?"C$":"$",Number(e.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),s.jsx("td",{children:e.source==="bank"?Ke(e.account)||"Cuenta bancaria":Qe[e.source??"cash"]}),s.jsx("td",{children:e.category_name??"Sin categor√≠a"}),s.jsx("td",{className:"expenses-table__note",children:e.note??"-"}),s.jsxs("td",{className:"expenses-table__actions",children:[s.jsx("button",{onClick:()=>Se(e),className:"expenses-table__edit",children:"Editar"}),s.jsx("button",{onClick:()=>ke(e),className:"expenses-table__delete",children:"Eliminar"})]})]},e.id))})]})}),s.jsxs("div",{className:"expenses-pagination",children:[s.jsxs("span",{className:"expenses-pagination__info",children:["Mostrando ",Pe,"-",Ue," de ",o.length," gastos"]}),s.jsxs("div",{className:"expenses-pagination__controls",children:[s.jsx("button",{type:"button",className:"expenses-pagination__button",onClick:()=>w(e=>Math.max(1,e-1)),disabled:j===1,children:"Anterior"}),s.jsxs("span",{className:"expenses-pagination__status",children:["P√°gina ",j," de ",W]}),s.jsx("button",{type:"button",className:"expenses-pagination__button",onClick:()=>w(e=>Math.min(W,e+1)),disabled:j===W||!o.length,children:"Siguiente"})]})]})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault(),N(null),E({...r})},className:"expenses-filters expenses-filters--footer",children:[s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Desde"}),s.jsx("input",{name:"from",type:"date",value:r.from,onChange:Y,className:"expenses-input"})]}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Hasta"}),s.jsx("input",{name:"to",type:"date",value:r.to,onChange:Y,className:"expenses-input"})]}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Categor√≠a"}),s.jsxs("select",{name:"category_id",value:r.category_id,onChange:Y,className:"expenses-input",children:[s.jsx("option",{value:"",children:"Todas"}),h.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsx("button",{type:"submit",className:"expenses-button",children:"Aplicar filtros"})]})]}):null,A==="add"?s.jsx(qe,{...ce,children:s.jsxs("form",{onSubmit:Ne(ve),className:"expenses-card expenses-form",children:[s.jsxs("div",{className:"expenses-form__intro",children:[s.jsx("h2",{children:L?"Editar gasto":"Registrar gasto"}),s.jsx("p",{children:L?"Actualiza la informaci√≥n del gasto seleccionado.":"Incluye gastos operativos, pagos recurrentes y compras puntuales."})]}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Monto"}),s.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...M("amount"),className:"expenses-input"})]}),s.jsx(He,{sourceField:"source",accountField:"account_id",label:"Origen del gasto",accountLabel:"Cuenta bancaria",fieldClass:"expenses-field",accountFieldClass:"expenses-field",sourceSelectClass:"expenses-select",accountSelectClass:"expenses-select",containerClass:"expenses-account-selector",onAccountChange:De}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Moneda"}),s.jsxs("select",{...M("currency"),className:"expenses-select",disabled:!!Ee,children:[s.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),s.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Fecha"}),s.jsx("input",{type:"date",required:!0,...M("date"),className:"expenses-input"})]}),s.jsxs("label",{className:"expenses-field",children:[s.jsx("span",{children:"Categor√≠a"}),s.jsxs("select",{...M("category_id"),className:"expenses-select",children:[s.jsx("option",{value:"",children:"Sin categor√≠a"}),h.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("label",{className:"expenses-field expenses-field--full",children:[s.jsx("span",{children:"Nota"}),s.jsx("textarea",{rows:3,placeholder:"Describe el gasto",...M("note"),className:"expenses-textarea"})]}),s.jsxs("div",{className:"expenses-form__actions",children:[s.jsx("button",{type:"submit",disabled:Q,className:"expenses-button expenses-button--primary",children:Q?L?"Guardando cambios...":"Guardando...":L?"Actualizar gasto":"Guardar gasto"}),L?s.jsx("button",{type:"button",className:"expenses-button expenses-button--ghost",disabled:Q,onClick:()=>{ue(),$("list")},children:"Cancelar edici√≥n"}):null]})]})}):null,A==="category"?s.jsxs("section",{className:"expenses-card expenses-category",children:[s.jsxs("div",{className:"expenses-category__intro",children:[s.jsx("h2",{children:"Nueva categor√≠a de gasto"}),s.jsx("p",{children:"Clasifica tus egresos para obtener reportes m√°s claros."})]}),s.jsxs("form",{onSubmit:async e=>{e.preventDefault();const a=e.currentTarget,c=`${new FormData(a).get("name")??""}`.trim();if(c)try{ne(!0);const l=await p("/categories",{method:"POST",body:{name:c,type:"expense"}});a.reset(),l?m(d=>[l,...d.filter(b=>b.id!==l.id)]):await je(),i(null)}catch(l){console.error(l);const d=l.payload?.message??l.message??"No se pudo crear la categor√≠a";i(d)}finally{ne(!1)}},className:"expenses-category__form",children:[s.jsxs("label",{className:"expenses-field expenses-category__field",children:[s.jsx("span",{children:"Nombre"}),s.jsx("input",{name:"name",type:"text",placeholder:"Servicios, suministros, renta...",required:!0,className:"expenses-input"})]}),s.jsx("button",{type:"submit",disabled:z,className:`expenses-button expenses-button--primary ${z?"is-disabled":""}`,children:z?"Creando...":"Crear categor√≠a"})]}),s.jsxs("div",{className:"expenses-category__list",children:[s.jsxs("div",{className:"expenses-category__list-header",children:[s.jsx("h3",{children:"Mis categor√≠as"}),s.jsx("p",{children:"Administra la lista que usas al registrar tus gastos."})]}),h.length===0?s.jsx("p",{className:"expenses-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):s.jsx("ul",{className:"expenses-category__items",children:h.map(e=>s.jsx("li",{className:"expenses-category__item",children:C===e.id?s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"text",value:K,onChange:a=>P(a.target.value),className:"expenses-input expenses-category__input",autoFocus:!0}),s.jsxs("div",{className:"expenses-category__actions",children:[s.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--primary",onClick:Ie,disabled:f,children:f?"Guardando‚Ä¶":"Guardar"}),s.jsx("button",{type:"button",className:"expenses-category__button",onClick:Me,disabled:f,children:"Cancelar"})]})]}):s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"expenses-category__name",children:e.name}),s.jsxs("div",{className:"expenses-category__actions",children:[s.jsx("button",{type:"button",className:"expenses-category__button",onClick:()=>we(e),disabled:f||S,children:"Editar"}),s.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--danger",onClick:()=>Le(e),disabled:f||S,children:"Eliminar"})]})]})},e.id))})]})]}):null,s.jsx(pe,{open:ye,title:"Eliminar gasto",message:g?`Eliminar√°s el gasto del ${ge(g.date)} por ${g.currency==="NIO"?"C$":"$"}${Number(g.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:O?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:O,onConfirm:$e,onCancel:Fe}),s.jsx(pe,{open:_e,title:"Eliminar categor√≠a",message:y?`¬øDeseas eliminar la categor√≠a ‚Äú${y.name}‚Äù? Los gastos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:S?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:S,onConfirm:Te,onCancel:Ae})]})}export{as as default};
