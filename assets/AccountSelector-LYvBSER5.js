import{j as a,r as s,a as V,b as Z}from"./index-CYuisF0z.js";import{u as F,a as aa}from"./index.esm-JPGs0xX-.js";import{f as R,A as ea,g as z,b as na}from"./accounts-62zbDqcc.js";function ta({open:f,title:i,message:y,confirmLabel:v="Aceptar",cancelLabel:k="Cancelar",confirmDisabled:x=!1,onConfirm:N,onCancel:c}){return f?a.jsx("div",{className:"confirm-dialog__overlay",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-dialog-title",children:a.jsxs("div",{className:"confirm-dialog__content",children:[a.jsx("div",{className:"confirm-dialog__header",children:a.jsx("h3",{id:"confirm-dialog-title",className:"confirm-dialog__title",children:i})}),a.jsx("p",{className:"confirm-dialog__message",children:y}),a.jsxs("div",{className:"confirm-dialog__actions",children:[a.jsx("button",{type:"button",className:"confirm-dialog__button confirm-dialog__button--secondary",onClick:c,disabled:x,children:k}),a.jsx("button",{type:"button",className:"confirm-dialog__button confirm-dialog__button--primary",onClick:N,disabled:x,children:v})]})]})}):null}const G={bank_institution:"BAC",institution_name:"",currency:"NIO",initial_balance:""};function sa({open:f,onClose:i,accounts:y=[],onCreated:v,onUpdated:k,onDeleted:x}){const{register:N,handleSubmit:c,watch:M,reset:j,formState:{isSubmitting:o}}=F({defaultValues:G}),[E,d]=s.useState(null),[l,S]=s.useState(null),[t,r]=s.useState(!1),[m,b]=s.useState(null),A=M("bank_institution"),O=s.useMemo(()=>[...y].sort((e,u)=>{const U=R(e)||e?.name||"",D=R(u)||u?.name||"";return U.localeCompare(D,"es",{sensitivity:"base"})}),[y]),_=s.useCallback(()=>{S(null),j(G),d(null),b(null)},[j]),g=s.useCallback(e=>{e&&(S(e),j({bank_institution:e.bank_institution??"BAC",institution_name:e.bank_institution==="Otro"?e.institution_name??"":"",currency:e.currency??"NIO",initial_balance:e.initial_balance===null||e.initial_balance===void 0?"":`${Number(e.initial_balance)}`}),d(null))},[j]),$=s.useCallback(async()=>{if(m){d(null),r(!0);try{await V(`/accounts/${m.id}`,{method:"DELETE"}),x?.(m.id),r(!1),b(null),l?.id===m.id&&_()}catch(e){console.error(e);const u=e.payload?.message??e.message??"No se pudo eliminar la cuenta bancaria.";d(u),r(!1)}}},[m,l,x,_]);if(s.useEffect(()=>{f||(_(),b(null))},[f,_]),!f||typeof document>"u")return null;const I=async e=>{d(null);const u=e.bank_institution==="Otro"?e.institution_name?.trim()??"":null;if(e.bank_institution==="Otro"&&!u){d("Indica el nombre del banco.");return}const D=`${(e.bank_institution==="Otro"?u:z(e.bank_institution)??e.bank_institution)??""}`.trim(),B={bank_institution:e.bank_institution,institution_name:u,currency:e.currency,name:D||z(e.bank_institution)||e.bank_institution,initial_balance:e.initial_balance===""||e.initial_balance===null||Number.isNaN(Number(e.initial_balance))?null:Number(e.initial_balance)};try{if(l){const T=await V(`/accounts/${l.id}`,{method:"PUT",body:B})??{...l,...B,id:l.id};k?.(T),d(null),_()}else{const h=await V("/accounts",{method:"POST",body:B});v?.(h),j({...G,bank_institution:h?.bank_institution??"BAC",currency:h?.currency??"NIO"}),d(null)}}catch(h){console.error(h);const T=l?"No se pudo actualizar la cuenta bancaria.":"No se pudo crear la cuenta bancaria.",w=h.payload?.message??h.message??T;d(w)}};return Z.createPortal(a.jsxs("div",{className:"account-modal",role:"dialog","aria-modal":"true",children:[a.jsx("div",{className:"account-modal__backdrop",onClick:()=>{o||i?.()}}),a.jsxs("div",{className:"account-modal__content",children:[a.jsxs("header",{className:"account-modal__header",children:[a.jsx("h2",{children:l?"Editar cuenta bancaria":"Crear cuenta bancaria"}),a.jsx("button",{type:"button",className:"account-modal__close",onClick:()=>{!o&&!t&&i?.()},children:"Cerrar"})]}),a.jsxs("div",{className:"account-modal__body",children:[a.jsxs("section",{className:"account-modal__panel",children:[a.jsx("p",{className:"account-modal__description",children:"Gestiona tus cuentas para asociar cada movimiento a la institución y moneda correcta."}),a.jsxs("form",{onSubmit:c(I),className:"account-modal__form",children:[a.jsxs("label",{className:"account-modal__field",children:[a.jsx("span",{children:"Institución"}),a.jsx("select",{...N("bank_institution"),className:"account-modal__input",children:ea.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),A==="Otro"?a.jsxs("label",{className:"account-modal__field",children:[a.jsx("span",{children:"Nombre del banco"}),a.jsx("input",{type:"text",placeholder:"Ingresa el nombre del banco",...N("institution_name",{required:"Indica el nombre del banco."}),className:"account-modal__input",required:!0})]}):null,a.jsxs("label",{className:"account-modal__field",children:[a.jsx("span",{children:"Moneda"}),a.jsxs("select",{...N("currency"),className:"account-modal__input",children:[a.jsx("option",{value:"NIO",children:"Córdoba nicaragüense (C$)"}),a.jsx("option",{value:"USD",children:"Dólar estadounidense ($)"})]})]}),a.jsxs("label",{className:"account-modal__field",children:[a.jsx("span",{children:"Saldo inicial (opcional)"}),a.jsx("input",{type:"number",step:"0.01",min:"0",placeholder:"0.00",...N("initial_balance"),className:"account-modal__input"})]}),E?a.jsx("p",{className:"account-modal__error",children:E}):null,a.jsxs("div",{className:"account-modal__actions",children:[a.jsx("button",{type:"button",className:"account-modal__button",onClick:()=>{!o&&!t&&i?.()},disabled:o||t,children:"Cancelar"}),l?a.jsx("button",{type:"button",className:"account-modal__button account-modal__button--danger",onClick:()=>{!o&&!t&&b(l)},disabled:o||t,children:t?"Eliminando…":"Eliminar"}):null,a.jsx("button",{type:"submit",className:"account-modal__button account-modal__button--primary",disabled:o||t,children:o?"Guardando…":l?"Actualizar":"Guardar cuenta"})]})]})]}),a.jsxs("aside",{className:"account-modal__aside",children:[a.jsxs("div",{className:"account-modal__manage-header",children:[a.jsx("h3",{children:"Cuentas registradas"}),a.jsx("button",{type:"button",className:"account-modal__manage-new",onClick:()=>{!o&&!t&&_()},disabled:o||t,children:"Nueva"})]}),O.length?a.jsx("ul",{className:"account-modal__list",children:O.map(e=>{const u=l?.id===e.id;return a.jsx("li",{children:a.jsxs("button",{type:"button",className:`account-modal__list-item${u?" is-active":""}`,onClick:()=>{!o&&!t&&g(e)},disabled:o||t,children:[a.jsx("span",{className:"account-modal__list-name",children:R(e)||e.name||"Sin nombre"}),a.jsx("span",{className:"account-modal__list-meta",children:e.currency??"N/A"})]})},e.id)})}):a.jsx("p",{className:"account-modal__list-empty",children:"Aún no registras cuentas."})]})]})]}),a.jsx(ta,{open:!!m,title:"Eliminar cuenta bancaria",message:"Esta acción eliminará la cuenta seleccionada y dejará sin asignar los movimientos relacionados. ¿Deseas continuar?",confirmLabel:t?"Eliminando…":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:t,onCancel:()=>{t||b(null)},onConfirm:()=>{t||$()}})]}),document.body)}const la=[{value:"cash",label:"Efectivo"},{value:"bank",label:"Cuenta bancaria"}];function oa({sourceField:f,accountField:i,label:y,accountLabel:v,fieldClass:k,accountFieldClass:x,containerClass:N,onAccountChange:c,sourceSelectClass:M,accountSelectClass:j,requiredAccountMessage:o="Selecciona la cuenta bancaria específica."}){const{register:E,watch:d,setValue:l,formState:{errors:S}}=aa(),t=d(f),r=d(i),[m,b]=s.useState([]),[A,O]=s.useState(!0),[_,g]=s.useState(null),[$,I]=s.useState(!1),e=s.useCallback(async()=>{g(null),O(!0);try{const n=await V("/accounts");b(Array.isArray(n)?n:[])}catch(n){console.error(n);const p=n.payload?.message??"No se pudieron cargar las cuentas bancarias.";g(p)}finally{O(!1)}},[]);s.useEffect(()=>{e()},[e]),s.useEffect(()=>{t!=="bank"&&r&&l(i,"",{shouldValidate:!0,shouldDirty:!0})},[t,r,i,l]);const u=s.useMemo(()=>r?m.find(n=>n.id===r)??null:null,[r,m]);s.useEffect(()=>{c&&c({source:t,accountId:t==="bank"&&r||null,account:t==="bank"?u:null})},[t,r,u,c]);const{onChange:U,onBlur:D,name:B,ref:h,...T}=E(f,{validate:n=>n?!0:"Selecciona el origen del movimiento."}),{onChange:w,onBlur:H,name:J,ref:K,...Q}=E(i,{validate:n=>t==="bank"?n?!0:o:!0}),L=s.useMemo(()=>m.map(n=>({...na(n),currency:n.currency})).sort((n,p)=>n.label.localeCompare(p.label,"es")),[m]),P=S?.[f]?.message,q=S?.[i]?.message,W=s.useCallback(n=>{b(p=>[n,...p.filter(C=>C.id!==n.id)]),l(i,n.id,{shouldValidate:!0,shouldDirty:!0}),g(null),I(!1),c&&c({source:"bank",accountId:n.id,account:n})},[i,c,l]),X=s.useCallback(n=>{b(p=>p.map(C=>C.id===n.id?n:C)),g(null),n.id===r&&(l(i,n.id,{shouldValidate:!0,shouldDirty:!0}),c&&c({source:"bank",accountId:n.id,account:n}))},[i,r,c,l]),Y=s.useCallback(n=>{b(p=>p.filter(C=>C.id!==n)),g(null),r===n&&(l(i,"",{shouldValidate:!0,shouldDirty:!0}),c&&c({source:"bank",accountId:null,account:null}))},[i,r,c,l]);return a.jsxs("div",{className:`account-selector ${N??""}`,children:[a.jsxs("label",{className:`account-selector__field ${k??""}`,children:[a.jsx("span",{children:y??"Cuenta"}),a.jsxs("select",{name:B,ref:h,...T,className:M,onChange:n=>{U(n)},onBlur:D,children:[a.jsx("option",{value:"",children:"Agregar origen"}),la.map(n=>a.jsx("option",{value:n.value,children:n.label},n.value))]}),P?a.jsx("small",{className:"field-error",children:P}):null]}),a.jsxs("div",{className:"account-selector__actions",children:[t==="bank"?a.jsx("div",{className:"account-selector__field field-wrapper",children:a.jsxs("label",{className:x??k,children:[a.jsx("span",{children:v??"Cuenta bancaria"}),a.jsxs("select",{name:J,ref:K,...Q,className:j??M,onChange:n=>{w(n)},onBlur:H,disabled:A&&L.length===0,children:[a.jsx("option",{value:"",children:A?"Cargando cuentas...":"Selecciona una cuenta"}),L.map(n=>a.jsx("option",{value:n.value,children:n.label},n.value))]}),q?a.jsx("small",{className:"field-error",children:q}):null,_?a.jsx("small",{className:"field-error",children:_}):null,t==="bank"&&!A&&L.length===0&&!_?a.jsx("small",{className:"account-selector__empty",children:"No tienes cuentas registradas todavía."}):null]})}):null,t==="bank"?a.jsxs("button",{type:"button",className:"account-selector__add",onClick:()=>I(!0),children:[a.jsx("span",{"aria-hidden":!0,children:"➕"})," Gestionar cuentas bancarias"]}):null]}),a.jsx(sa,{open:$,onClose:()=>I(!1),accounts:m,onCreated:W,onUpdated:X,onDeleted:Y})]})}export{oa as A,ta as C};
