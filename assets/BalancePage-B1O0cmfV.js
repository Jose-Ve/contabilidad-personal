import{r as t,s as O,m as C,j as s}from"./index-BnMz-dVJ.js";import{f as Y}from"./accounts-62zbDqcc.js";const D=36.7,a=(r,j="NIO")=>new Intl.NumberFormat("es-NI",{style:"currency",currency:j,maximumFractionDigits:2}).format(Number(r??0)),o=r=>Number(r??0)/D||0,q=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),F=new Date,J=new Date(F.getFullYear(),0,1).toISOString().slice(0,10),Q=F.toISOString().slice(0,10),R=r=>{if(!r)return"";const[j,i]=r.split("-"),B=new Date(Number(j),Number(i)-1,1),p=q.format(B);return p.charAt(0).toUpperCase()+p.slice(1)};function X(){const[r,j]=t.useState({from:J,to:Q}),[i,B]=t.useState({incomes:0,expenses:0,balance:0,balanceBreakdown:{total:0,bank:0,cash:0},series:[],accounts:[]}),[p,I]=t.useState(!1),[T,L]=t.useState(!1),[U,g]=t.useState(null),[f,z]=t.useState([]),A=t.useRef(!1),N=t.useRef(null),$=t.useCallback(e=>{const{name:l,value:c}=e.target;j(u=>({...u,[l]:c})),(l==="from"||l==="to")&&g(null)},[]),_=t.useCallback(async(e,{preserveMonths:l=!1}={})=>{I(!0);const c=e??r,d=(await O.auth.getSession()).data.session?.access_token;if(!d){I(!1);return}try{const h=new URLSearchParams(c),b=await fetch(`https://contabilidad-personal.onrender.com/balance?${h.toString()}`,{headers:{Authorization:`Bearer ${d}`}});if(!b.ok)throw new Error("No se pudo calcular el balance");const m=await b.json();if(B({incomes:m.incomes,expenses:m.expenses,balance:m.balance,balanceBreakdown:m.balanceBreakdown??{total:Number(m.balance??0),bank:0,cash:0},series:m.series??{},accounts:Array.isArray(m.accounts)?m.accounts:[]}),!l){const k=Array.isArray(m?.series?.byMonth)?m.series.byMonth.map(x=>{const S=Number(x.incomes??0),M=Number(x.expenses??0),E=S-M;return{month:x.month,label:R(x.month),incomesNio:S,incomesUsd:o(S),expensesNio:M,expensesUsd:o(M),netNio:E,netUsd:o(E)}}):[];z(k.sort((x,S)=>x.month<S.month?1:-1))}}catch(h){console.error(h)}finally{I(!1),L(!0)}},[r]),w=t.useCallback(()=>{N.current&&window.clearTimeout(N.current),N.current=window.setTimeout(()=>{N.current=null,_(void 0,{preserveMonths:!1})},300)},[_]);t.useEffect(()=>{A.current||(A.current=!0,_(r))},[r,_]),t.useEffect(()=>{const e=O.channel("balance-updates").on("postgres_changes",{event:"*",schema:"public",table:"incomes"},()=>{C(),w()}).on("postgres_changes",{event:"*",schema:"public",table:"expenses"},()=>{C(),w()}).on("postgres_changes",{event:"*",schema:"public",table:"transfers"},()=>{C(),w()}).subscribe();return()=>{N.current&&(window.clearTimeout(N.current),N.current=null),O.removeChannel(e)}},[w]),t.useEffect(()=>{if(!f.length){g(null);return}g(e=>e&&f.some(l=>l.month===e)?e:f[0].month)},[f]);const G=e=>{const[l,c]=e.split("-"),u=new Date(Number(l),Number(c)-1,1),d=new Date(Number(l),Number(c),0),h=u.toISOString().slice(0,10),b=d.toISOString().slice(0,10);return{from:h,to:b}},H=t.useCallback(e=>{const l=G(e),c={...r,from:l.from,to:l.to};g(e),j(c),_(c,{preserveMonths:!0})},[r,_]),n=t.useMemo(()=>{const e=c=>c&&typeof c=="object"?{total:Number(c.total??0),bank:Number(c.bank??0),cash:Number(c.cash??0)}:{total:Number(c??0),bank:0,cash:0},l=e(i.balanceBreakdown??{total:Number(i.balance??0)});return{incomes:e(i.incomes),expenses:e(i.expenses),balance:Number(i.balance??0),balanceBreakdown:l}},[i]),v=t.useMemo(()=>!Array.isArray(i.accounts)||i.accounts.length===0?[]:i.accounts.map((e,l)=>{const c=e.account_id??e.account?.id??`account-${l}`,u=Y(e.account)||"Cuenta bancaria",d=Number(e.incomes?.nio??e.incomes??0),h=Number(e.incomes?.usd??d/D),b=Number(e.expenses?.nio??e.expenses??0),m=Number(e.expenses?.usd??b/D),k=Number(e.net?.nio??e.net??d-b),x=Number(e.net?.usd??k/D);return{id:c,label:u,institution:e.account?.bank_institution==="Otro"?e.account?.institution_name??null:e.account?.bank_institution??null,currency:e.account?.currency??"NIO",incomes:{nio:d,usd:h},expenses:{nio:b,usd:m},net:{nio:k,usd:x}}}),[i.accounts]),y=t.useMemo(()=>{const e=i?.series?.byMonth??[];let l=0;return e.map(c=>{const u=Number(c.incomes??0),d=Number(c.expenses??0),h=u-d,b=l;return l+=h,{month:c.month,label:R(c.month),incomesNio:u,incomesUsd:o(u),expensesNio:d,expensesUsd:o(d),netNio:h,netUsd:o(h),carryInNio:b,carryInUsd:o(b),carryOutNio:l,carryOutUsd:o(l)}})},[i?.series]),P=t.useMemo(()=>U?y.filter(e=>e.month===U):y,[y,U]);return s.jsxs("section",{className:"balance",children:[s.jsxs("header",{className:"balance__header",children:[s.jsxs("div",{className:"balance__intro",children:[s.jsx("h1",{children:"Balance"}),s.jsx("p",{children:"Filtra por rango de fechas para comparar tus ingresos y gastos."})]}),s.jsxs("div",{className:"balance__overview",children:[s.jsx("span",{className:"balance__overview-label",children:"Balance general"}),s.jsx("strong",{className:`balance__overview-value ${n.balance>=0?"is-positive":"is-negative"}`,children:a(n.balance)}),s.jsxs("span",{className:"balance__overview-detail",children:["Ingresos: ",a(n.incomes.total)," (≈ ",a(o(n.incomes.total),"USD"),")"]}),s.jsxs("span",{className:"balance__overview-detail",children:["Gastos: ",a(n.expenses.total)," (≈ ",a(o(n.expenses.total),"USD"),")"]})]})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault(),g(null),_(r)},className:"balance-filters",children:[s.jsxs("label",{className:"balance-field",children:[s.jsx("span",{children:"Desde"}),s.jsx("input",{type:"date",name:"from",value:r.from,onChange:$,className:"balance-input"})]}),s.jsxs("label",{className:"balance-field",children:[s.jsx("span",{children:"Hasta"}),s.jsx("input",{type:"date",name:"to",value:r.to,onChange:$,className:"balance-input"})]}),s.jsx("button",{type:"submit",className:"balance-button",disabled:p,children:p?"Calculando...":"Aplicar filtros"})]}),p?s.jsx("p",{className:"balance__loading",children:"Calculando balance..."}):s.jsxs("div",{className:"balance-grid",children:[s.jsxs("article",{className:"balance-card",children:[s.jsx("p",{className:"balance-card__title",children:"Ingresos"}),s.jsx("p",{className:"balance-card__value is-positive",children:a(n.incomes.total)}),s.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(o(n.incomes.total),"USD")]}),s.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(n.incomes.bank)," (≈ ",a(o(n.incomes.bank),"USD"),")"]}),s.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(n.incomes.cash)," (≈ ",a(o(n.incomes.cash),"USD"),")"]}),v.length>0?s.jsx("ul",{className:"balance-card__accounts",children:v.map(e=>s.jsxs("li",{children:[s.jsx("span",{className:"balance-card__account-name",children:e.label}),s.jsxs("span",{children:[a(e.incomes.nio)," (≈ ",a(e.incomes.usd,"USD"),")"]})]},`${e.id}-incomes`))}):null]}),s.jsxs("article",{className:"balance-card",children:[s.jsx("p",{className:"balance-card__title",children:"Gastos"}),s.jsx("p",{className:"balance-card__value is-negative",children:a(n.expenses.total)}),s.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(o(n.expenses.total),"USD")]}),s.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(n.expenses.bank)," (≈ ",a(o(n.expenses.bank),"USD"),")"]}),s.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(n.expenses.cash)," (≈ ",a(o(n.expenses.cash),"USD"),")"]}),v.length>0?s.jsx("ul",{className:"balance-card__accounts",children:v.map(e=>s.jsxs("li",{children:[s.jsx("span",{className:"balance-card__account-name",children:e.label}),s.jsxs("span",{children:[a(e.expenses.nio)," (≈ ",a(e.expenses.usd,"USD"),")"]})]},`${e.id}-expenses`))}):null]}),s.jsxs("article",{className:"balance-card",children:[s.jsx("p",{className:"balance-card__title",children:"Resultado"}),s.jsx("p",{className:`balance-card__value ${n.balanceBreakdown.total>=0?"is-positive":"is-negative"}`,children:a(n.balanceBreakdown.total)}),s.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(o(n.balanceBreakdown.total),"USD")]}),s.jsxs("p",{className:"balance-card__detail",children:["Actualizado al ",new Date(r.to).toLocaleDateString()]}),s.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(n.balanceBreakdown.bank)," (≈ ",a(o(n.balanceBreakdown.bank),"USD"),")"]}),s.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(n.balanceBreakdown.cash)," (≈ ",a(o(n.balanceBreakdown.cash),"USD"),")"]}),v.length>0?s.jsx("ul",{className:"balance-card__accounts",children:v.map(e=>s.jsxs("li",{children:[s.jsx("span",{className:"balance-card__account-name",children:e.label}),s.jsxs("span",{className:e.net.nio>=0?"is-positive":"is-negative",children:[a(e.net.nio)," (≈ ",a(e.net.usd,"USD"),")"]})]},`${e.id}-net`))}):null]})]}),!p&&y.length>0?s.jsxs("section",{className:"balance-monthly",children:[s.jsxs("header",{className:"balance-monthly__header",children:[s.jsx("h2",{children:"Movimientos mensuales"}),s.jsx("p",{children:"Revisa cómo se comporta tu flujo de efectivo cada mes y cuánto saldo arrastras al siguiente."}),f.length>0?s.jsx("div",{className:"balance-monthly__selector",children:f.map(e=>s.jsxs("button",{type:"button",className:`balance-monthly__chip${e.month===U?" is-active":""}`,onClick:()=>H(e.month),children:[s.jsx("span",{className:"balance-monthly__chip-label",children:e.label}),s.jsxs("span",{className:"balance-monthly__chip-count",children:[e.netUsd>=0?"+":"",a(e.netNio)," (≈ ",a(e.netUsd,"USD"),")"]})]},e.month))}):null]}),s.jsx("div",{className:"balance-monthly__grid",children:P.map(e=>s.jsxs("article",{className:"balance-monthly__card",children:[s.jsx("h3",{children:e.label}),s.jsxs("dl",{className:"balance-monthly__details",children:[s.jsxs("div",{className:"balance-monthly__row",children:[s.jsx("dt",{children:"Saldo inicial"}),s.jsxs("dd",{className:`balance-monthly__number ${e.carryInUsd>=0?"is-positive":"is-negative"}`,children:[a(e.carryInNio)," (≈ ",a(e.carryInUsd,"USD"),")"]})]}),s.jsxs("div",{className:"balance-monthly__row",children:[s.jsx("dt",{children:"Ingresos"}),s.jsxs("dd",{className:"balance-monthly__number is-positive",children:[a(e.incomesNio)," (≈ ",a(e.incomesUsd,"USD"),")"]})]}),s.jsxs("div",{className:"balance-monthly__row",children:[s.jsx("dt",{children:"Gastos"}),s.jsxs("dd",{className:"balance-monthly__number is-negative",children:[a(e.expensesNio)," (≈ ",a(e.expensesUsd,"USD"),")"]})]}),s.jsxs("div",{className:"balance-monthly__row",children:[s.jsx("dt",{children:"Resultado del mes"}),s.jsxs("dd",{className:`balance-monthly__number ${e.netUsd>=0?"is-positive":"is-negative"}`,children:[a(e.netNio)," (≈ ",a(e.netUsd,"USD"),")"]})]}),s.jsxs("div",{className:"balance-monthly__row",children:[s.jsx("dt",{children:"Saldo arrastrado"}),s.jsxs("dd",{className:`balance-monthly__number ${e.carryOutUsd>=0?"is-positive":"is-negative"}`,children:[a(e.carryOutNio)," (≈ ",a(e.carryOutUsd,"USD"),")"]})]})]})]},e.month))})]}):null,!p&&T&&y.length===0?s.jsx("p",{className:"balance-monthly__empty",children:"Registra ingresos y gastos para ver cómo se comporta tu balance mensual."}):null]})}export{X as default};
