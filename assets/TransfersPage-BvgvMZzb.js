import{r as a,a as w,j as e}from"./index-CYuisF0z.js";import{u as le,F as ie}from"./index.esm-JPGs0xX-.js";import{A as Y,C as oe}from"./AccountSelector-LYvBSER5.js";import{f as ue}from"./accounts-62zbDqcc.js";const I={bank:"Cuenta bancaria",cash:"Efectivo"},de=[{value:"NIO",label:"CÃ³rdobas (NIO)"},{value:"USD",label:"DÃ³lares (USD)"}],z=t=>Number(t??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),G=t=>{if(!t)return"";const l=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(t);if(!l)return new Date(t).toLocaleDateString("es-NI");const[,p,f,i]=l;return new Date(Number(p),Number(f)-1,Number(i)).toLocaleDateString("es-NI")},H=(t=new Date)=>{const l=t.getFullYear(),p=String(t.getMonth()+1).padStart(2,"0"),f=String(t.getDate()).padStart(2,"0");return`${l}-${p}-${f}`};function J(t,l){return t==="cash"?I.cash:l?ue(l):I.bank}function pe(){const[t,l]=a.useState([]),[p,f]=a.useState(!0),[i,r]=a.useState(null),[D,x]=a.useState("list"),[y,o]=a.useState(null),[j,u]=a.useState(null),[d,F]=a.useState(null),[k,O]=a.useState(null),[K,M]=a.useState(!1),[E,R]=a.useState(!1),h=a.useCallback(()=>({amount:"",currency:"NIO",date:H(),source_type:"cash",source_account_id:"",destination_type:"bank",destination_account_id:"",note:""}),[]),c=le({defaultValues:h()}),{handleSubmit:Q,reset:m,watch:g,setValue:V,formState:{isSubmitting:$}}=c,A=g("source_type"),L=g("destination_type"),q=g("source_account_id"),P=g("destination_account_id"),B=g("currency"),_=a.useCallback(async()=>{f(!0);try{const s=await w("/transfers");l(s??[]),r(null)}catch(s){console.error(s);const n=s.payload?.message??s.message??"No se pudieron cargar las transferencias";r(n)}finally{f(!1)}},[]);a.useEffect(()=>{_()},[_]);const b=a.useMemo(()=>y?.currency??j?.currency??null,[y,j]);a.useEffect(()=>{if(!b){B||V("currency","NIO",{shouldDirty:!1,shouldValidate:!0});return}V("currency",b,{shouldDirty:!0,shouldValidate:!0})},[b,B,V]);const W=a.useCallback(({source:s,account:n})=>{o(s==="bank"&&n?n:null)},[]),X=a.useCallback(({source:s,account:n})=>{u(s==="bank"&&n?n:null)},[]);a.useEffect(()=>{A!=="bank"&&o(null)},[A]),a.useEffect(()=>{L!=="bank"&&u(null)},[L]);const N=a.useMemo(()=>!y||!j?!1:y.currency!==j.currency,[y,j]),S=a.useMemo(()=>A!=="bank"||L!=="bank"||!q||!P?!1:q===P,[q,P,A,L]);a.useEffect(()=>{!N&&i==="Las cuentas seleccionadas deben manejar la misma moneda."&&r(null)},[N,i]),a.useEffect(()=>{!S&&i==="Selecciona cuentas diferentes para origen y destino."&&r(null)},[S,i]);const U=a.useMemo(()=>t.reduce((s,n)=>{const T=n.currency??"NIO";return s[T]=(s[T]??0)+Number(n.amount??0),s},{}),[t]),Z=a.useCallback(s=>{x("create"),F(s),m({amount:s.amount!==void 0?String(s.amount):"",currency:s.currency??"NIO",date:s.date??H(),source_type:s.source_type??"cash",source_account_id:s.source_type==="bank"?s.source_account_id??"":"",destination_type:s.destination_type??"bank",destination_account_id:s.destination_type==="bank"?s.destination_account_id??"":"",note:s.note??""}),o(s.source_type==="bank"?s.source_account??null:null),u(s.destination_type==="bank"?s.destination_account??null:null),r(null)},[m]),v=a.useCallback(()=>{F(null),m(h()),o(null),u(null),r(null)},[h,m]),ee=a.useCallback(s=>{O(s),M(!0)},[]),se=a.useCallback(()=>{E||(M(!1),O(null))},[E]),ae=a.useCallback(async()=>{if(k){R(!0);try{await w(`/transfers/${k.id}`,{method:"DELETE"}),M(!1),O(null),r(null),d&&d.id===k.id&&v(),x("list"),await _()}catch(s){console.error(s);const n=s.payload?.message??s.message??"No se pudo eliminar la transferencia";r(n)}finally{R(!1)}}},[k,d,v,_]),C=!!d,ne=C?"Actualizar transferencia":"Registrar transferencia",te=C?"Cancelar ediciÃ³n":"Limpiar formulario",re=async s=>{if(S){r("Selecciona cuentas diferentes para origen y destino.");return}if(N){r("Las cuentas seleccionadas deben manejar la misma moneda.");return}try{const n={amount:Number(s.amount),currency:b??s.currency,date:s.date,source_type:s.source_type,source_account_id:s.source_type==="bank"&&s.source_account_id||null,destination_type:s.destination_type,destination_account_id:s.destination_type==="bank"&&s.destination_account_id||null,note:s.note?s.note.trim():null};d?await w(`/transfers/${d.id}`,{method:"PUT",body:n}):await w("/transfers",{method:"POST",body:n}),m(h()),o(null),u(null),r(null),F(null),x("list"),await _()}catch(n){console.error(n);const T=n.payload?.message??n.message??"No se pudo registrar la transferencia";r(T)}},ce=$||N||S;return e.jsxs("div",{className:"transfers-page",children:[e.jsxs("header",{className:"transfers-header",children:[e.jsxs("div",{className:"transfers-heading",children:[e.jsx("h1",{children:"Transferencias"}),e.jsx("p",{children:"Registra movimientos internos entre tus cuentas y consulta el historial."})]}),e.jsxs("div",{className:"transfers-actions",children:[e.jsxs("button",{type:"button",className:`transfers-tab${D==="list"?" transfers-tab--active":""}`,onClick:()=>{x("list"),r(null)},children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ“‹"}),"Historial"]}),e.jsxs("button",{type:"button",className:`transfers-tab${D==="create"?" transfers-tab--active":""}`,onClick:()=>{x("create"),C?v():(m(h()),o(null),u(null),r(null))},children:[e.jsx("span",{"aria-hidden":!0,children:"âž•"}),"Nueva transferencia"]})]})]}),Object.keys(U).length?e.jsx("section",{className:"transfers-summary",children:Object.entries(U).map(([s,n])=>e.jsxs("article",{className:"transfers-summary-card",children:[e.jsxs("span",{className:"transfers-summary-label",children:["Total registrado (",s,")"]}),e.jsxs("strong",{className:"transfers-summary-amount",children:[z(n)," ",s]})]},s))}):null,i?e.jsx("p",{className:"transfers-error",children:i}):null,e.jsxs("div",{className:"transfers-content",children:[D==="create"?e.jsx(ie,{...c,children:e.jsxs("form",{className:"transfers-form",onSubmit:Q(re),children:[C?e.jsx("div",{className:"transfers-form-banner",children:e.jsxs("span",{children:["Editando transferencia registrada el ",G(d?.date),"."]})}):null,e.jsxs("div",{className:"transfers-form-grid",children:[e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Monto"}),e.jsx("input",{type:"number",min:"0",step:"0.01",inputMode:"decimal",...c.register("amount",{required:"Ingresa el monto a transferir.",min:{value:.01,message:"El monto debe ser mayor que cero."}})}),c.formState.errors.amount?e.jsx("small",{className:"field-error",children:c.formState.errors.amount.message}):null]}),e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Fecha"}),e.jsx("input",{type:"date",...c.register("date",{required:"Selecciona la fecha de la transferencia."})}),c.formState.errors.date?e.jsx("small",{className:"field-error",children:c.formState.errors.date.message}):null]}),e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Moneda"}),e.jsxs("select",{...c.register("currency",{required:"Selecciona la moneda del movimiento."}),disabled:!!b,children:[e.jsx("option",{value:"",children:"Elige una moneda"}),de.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),c.formState.errors.currency?e.jsx("small",{className:"field-error",children:c.formState.errors.currency.message}):null,b?e.jsx("small",{className:"transfers-field__hint",children:"Moneda definida por la cuenta seleccionada."}):null]})]}),e.jsxs("div",{className:"transfers-selectors",children:[e.jsxs("div",{className:"transfers-selector",children:[e.jsx("h2",{children:"Cuenta de origen"}),e.jsx(Y,{sourceField:"source_type",accountField:"source_account_id",label:"Origen",accountLabel:"Cuenta bancaria origen",onAccountChange:W,containerClass:"transfers-account-selector"})]}),e.jsxs("div",{className:"transfers-selector",children:[e.jsx("h2",{children:"Cuenta de destino"}),e.jsx(Y,{sourceField:"destination_type",accountField:"destination_account_id",label:"Destino",accountLabel:"Cuenta bancaria destino",onAccountChange:X,containerClass:"transfers-account-selector",requiredAccountMessage:"Selecciona la cuenta bancaria de destino."})]})]}),N?e.jsx("p",{className:"transfers-warning",children:"Las cuentas de origen y destino deben compartir la misma moneda."}):null,S?e.jsx("p",{className:"transfers-warning",children:"No puedes transferir entre la misma cuenta bancaria."}):null,e.jsxs("label",{className:"transfers-field transfers-field--full",children:[e.jsx("span",{className:"transfers-field__label",children:"Nota (opcional)"}),e.jsx("textarea",{rows:3,placeholder:"Describe la transferencia para futuras referencias",...c.register("note",{maxLength:{value:255,message:"La nota no debe superar los 255 caracteres."}})}),c.formState.errors.note?e.jsx("small",{className:"field-error",children:c.formState.errors.note.message}):null]}),e.jsxs("div",{className:"transfers-form-actions",children:[e.jsx("button",{type:"submit",className:"transfers-submit",disabled:ce,children:$?"Guardando...":ne}),e.jsx("button",{type:"button",className:"transfers-cancel",onClick:()=>{C?v():(m(h()),o(null),u(null),r(null))},disabled:$,children:te})]})]})}):null,D==="list"?e.jsx("section",{className:"transfers-list",children:p?e.jsx("p",{className:"transfers-placeholder",children:"Cargando transferencias..."}):t.length?e.jsx("div",{className:"transfers-table-wrapper",children:e.jsxs("table",{className:"transfers-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:t.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:G(s.date)}),e.jsxs("td",{children:[e.jsx("span",{className:"transfers-table-label",children:I[s.source_type]??s.source_type}),s.source_type==="bank"&&s.source_account?e.jsx("span",{className:"transfers-table-account",children:J(s.source_type,s.source_account)}):null]}),e.jsxs("td",{children:[e.jsx("span",{className:"transfers-table-label",children:I[s.destination_type]??s.destination_type}),s.destination_type==="bank"&&s.destination_account?e.jsx("span",{className:"transfers-table-account",children:J(s.destination_type,s.destination_account)}):null]}),e.jsxs("td",{className:"transfers-table-amount",children:[e.jsx("strong",{children:z(s.amount)}),e.jsx("span",{children:s.currency})]}),e.jsx("td",{children:s.note||"â€”"}),e.jsxs("td",{className:"transfers-table-actions",children:[e.jsx("button",{type:"button",onClick:()=>Z(s),children:"Editar"}),e.jsx("button",{type:"button",onClick:()=>ee(s),children:"Eliminar"})]})]},s.id))})]})}):e.jsx("p",{className:"transfers-placeholder",children:"AÃºn no has registrado transferencias."})}):null]}),e.jsx(oe,{open:K,title:"Eliminar transferencia",message:"Esta acciÃ³n no se puede deshacer. Â¿Deseas eliminar la transferencia seleccionada?",confirmLabel:E?"Eliminando...":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:E,onConfirm:ae,onCancel:se})]})}export{pe as default};
