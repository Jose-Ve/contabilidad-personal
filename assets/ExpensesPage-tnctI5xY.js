import{r as t,a as b,j as e}from"./index-D38TlpaS.js";import{u as X}from"./index.esm-qAfggAJ1.js";const I=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),J=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),Q=o=>{if(!o)return"";const[m,N]=o.split("-"),S=new Date(Number(m),Number(N)-1,1),r=J.format(S);return r.charAt(0).toUpperCase()+r.slice(1)},v=36.7,T=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],W=T.reduce((o,m)=>(o[m.value]=m.label,o),{});function q(){const[o,m]=t.useState([]),[N,S]=t.useState([]),[r,w]=t.useState({from:"",to:"",category_id:""}),[A,$]=t.useState(!0),[O,x]=t.useState(null),[f,D]=t.useState("list"),[C,L]=t.useState(!1),[y,_]=t.useState(null),[c,R]=t.useState([]),k=t.useRef(!1),{register:h,handleSubmit:U,reset:P,formState:{isSubmitting:F}}=X({defaultValues:{amount:"",currency:"NIO",source:"bank",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),u=t.useCallback(async(s={})=>{$(!0);try{const a=new URLSearchParams;s.from&&a.set("from",s.from),s.to&&a.set("to",s.to),s.category_id&&a.set("category_id",s.category_id);const n=a.toString(),[l,i]=await Promise.all([b(`/expenses${n?`?${n}`:""}`),b("/categories?type=expense")]);m(l??[]),S(i??[]),x(null)}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudieron cargar los gastos";x(n)}finally{$(!1)}},[]);t.useEffect(()=>{k.current||(k.current=!0,u(r))},[r,u]);const V=async s=>{try{await b("/expenses",{method:"POST",body:{amount:Number(s.amount),currency:s.currency,source:s.source,date:s.date,category_id:s.category_id||null,note:s.note||null}}),P({amount:"",currency:s.currency,source:s.source,date:s.date,category_id:s.category_id,note:""}),await u(r),D("list")}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudo registrar el gasto";x(n)}},G=async s=>{if(window.confirm("¬øEliminar este gasto?"))try{await b(`/expenses/${s}`,{method:"DELETE"}),m(a=>a.filter(n=>n.id!==s))}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudo eliminar el gasto";x(n)}},p=t.useMemo(()=>o.reduce((s,a)=>{const n=Number(a.amount??0),l=a.currency==="NIO",i=l?n/v:n,d=l?n:n*v;s.usd+=i,s.nio+=d;const j=a.source==="bank"?"bank":"cash";return s[j].usd+=i,s[j].nio+=d,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),M=t.useMemo(()=>{if(!o.length)return[];const s=new Map;for(const a of o){if(!a?.date)continue;const n=a.date.slice(0,7);s.has(n)||s.set(n,{usd:0,nio:0,count:0});const l=s.get(n),i=Number(a.amount??0),d=a.currency==="NIO",j=d?i/v:i,K=d?i:i*v;l.usd+=j,l.nio+=K,l.count+=1}return Array.from(s.entries()).map(([a,n])=>({month:a,label:Q(a),usd:n.usd,nio:n.nio,count:n.count})).sort((a,n)=>a.month<n.month?1:-1)},[o]);t.useEffect(()=>{!r.from&&!r.to&&!r.category_id&&R(M)},[M,r]),t.useEffect(()=>{if(!c.length){_(null);return}_(s=>s&&c.some(a=>a.month===s)?s:c[0].month)},[c]);const g=t.useMemo(()=>y?c.find(s=>s.month===y)??null:null,[c,y]),B=t.useMemo(()=>c.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[c]),E=t.useCallback(s=>{const{name:a,value:n}=s.target;w(l=>({...l,[a]:n})),(a==="from"||a==="to")&&_(null)},[]),H=s=>{const[a,n]=s.split("-"),l=new Date(Number(a),Number(n)-1,1),i=new Date(Number(a),Number(n),0),d=l.toISOString().slice(0,10),j=i.toISOString().slice(0,10);return{from:d,to:j}},z=t.useCallback(s=>{const a=H(s),n={from:a.from,to:a.to,category_id:r.category_id};_(s),w(n),u(n)},[r.category_id,u]);return e.jsxs("section",{className:"expenses",children:[e.jsxs("header",{className:"expenses__header",children:[e.jsxs("div",{className:"expenses__heading",children:[e.jsx("h1",{children:"Gastos"}),e.jsx("p",{children:"Controla tus egresos diarios y clasif√≠calos f√°cilmente."}),e.jsx("nav",{className:"expenses__tabs expenses__actions",children:[{id:"list",label:"Lista de gastos",icon:"üìã"},{id:"add",label:"Agregar gasto",icon:"‚ûñ"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>D(s.id),className:`expenses__tab ${f===s.id?"expenses__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"expenses__summary",children:[e.jsx("span",{className:"expenses__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"expenses__summary-value expenses__summary-value--nio",children:["C$",p.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"expenses__summary-value",children:["$",p.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Cuenta bancaria: C$",p.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",p.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Efectivo: C$",p.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",p.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),O?e.jsx("p",{className:"expenses__error",children:O}):null,f==="list"?e.jsxs("article",{className:"expenses-card",children:[e.jsx("header",{className:"expenses-card__header",children:e.jsxs("div",{className:"expenses-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üí≥"}),"Lista de gastos"]}),e.jsx("p",{children:"Visualiza tus egresos y verifica el estado de tus categor√≠as."})]})}),e.jsxs("section",{className:`expenses-monthly${c.length>0?" expenses-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"expenses-monthly__info",children:[c.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Controla cu√°nto gastas cada mes y cu√°ntos movimientos registraste."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),_(null),u({...r})},className:"expenses-filters",children:[e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:r.from,onChange:E,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:r.to,onChange:E,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:r.category_id,onChange:E,className:"expenses-input",children:[e.jsx("option",{value:"",children:"Todas"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"expenses-button",children:"Aplicar filtros"})]})]}),c.length>0?e.jsxs("div",{className:"expenses-monthly__aside",children:[e.jsxs("label",{className:"expenses-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"expenses-monthly__select",value:y??"",onChange:s=>{const{value:a}=s.target;a&&z(a)},children:B.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),g?e.jsxs("article",{className:"expenses-monthly__card expenses-monthly__card--focus",children:[e.jsxs("div",{className:"expenses-monthly__card-header",children:[e.jsx("h4",{children:g.label}),e.jsxs("span",{className:"expenses-monthly__hint",children:[g.count," ",g.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"expenses-monthly__value expenses-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",I(g.nio)]})]}),e.jsxs("p",{className:"expenses-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",I(g.usd)]})]})]}):e.jsx("p",{className:"expenses-card__placeholder expenses-monthly__placeholder",children:"Selecciona un mes para ver el detalle."})]}):null]}),A?e.jsx("p",{className:"expenses-card__placeholder",children:"Cargando gastos..."}):o.length===0?e.jsx("p",{className:"expenses-card__placeholder",children:"No hay gastos registrados con los filtros actuales."}):e.jsx("div",{className:"expenses-table__wrapper",children:e.jsxs("table",{className:"expenses-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"expenses-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(s.date).toLocaleDateString()}),e.jsxs("td",{className:"expenses-table__amount",children:[s.currency==="NIO"?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:W[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"expenses-table__note",children:s.note??"-"}),e.jsx("td",{className:"expenses-table__actions",children:e.jsx("button",{onClick:()=>G(s.id),className:"expenses-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,f==="add"?e.jsxs("form",{onSubmit:U(V),className:"expenses-card expenses-form",children:[e.jsxs("div",{className:"expenses-form__intro",children:[e.jsx("h2",{children:"Registrar gasto"}),e.jsx("p",{children:"Incluye gastos operativos, pagos recurrentes y compras puntuales."})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...h("amount"),className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...h("currency"),className:"expenses-select",children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Origen del gasto"}),e.jsx("select",{...h("source"),className:"expenses-select",children:T.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...h("date"),className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...h("category_id"),className:"expenses-select",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"expenses-field expenses-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Describe el gasto",...h("note"),className:"expenses-textarea"})]}),e.jsx("button",{type:"submit",disabled:F,className:`expenses-button expenses-button--primary ${F?"is-disabled":""}`,children:F?"Guardando...":"Guardar gasto"})]}):null,f==="category"?e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const a=s.currentTarget,l=new FormData(a).get("name");if(l)try{L(!0),await b("/categories",{method:"POST",body:{name:l,type:"expense"}}),a.reset(),await u(r),D("list"),x(null)}catch(i){console.error(i);const d=i.payload?.message??i.message??"No se pudo crear la categor√≠a";x(d)}finally{L(!1)}},className:"expenses-card expenses-category",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Nueva categor√≠a de gasto"}),e.jsx("p",{children:"Clasifica tus egresos para obtener reportes m√°s claros."})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Servicios, suministros, renta...",required:!0,className:"expenses-input"})]}),e.jsx("button",{type:"submit",disabled:C,className:`expenses-button expenses-button--primary ${C?"is-disabled":""}`,children:C?"Creando...":"Crear categor√≠a"})]}):null]})}export{q as default};
