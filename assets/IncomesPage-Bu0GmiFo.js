import{r as n,a as y,j as e}from"./index-CYuisF0z.js";import{u as $e,F as we}from"./index.esm-JPGs0xX-.js";import{A as Ie,C as te}from"./AccountSelector-LYvBSER5.js";import{f as Le}from"./accounts-62zbDqcc.js";const oe=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Ae=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),ce=o=>{if(!o)return"";const l=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(o);if(!l)return new Date(o).toLocaleDateString("es-NI");const[,g,h,_]=l;return new Date(Number(g),Number(h)-1,Number(_)).toLocaleDateString("es-NI")},Oe=o=>{if(!o)return"";const[l,g]=o.split("-"),h=new Date(Number(l),Number(g)-1,1),_=Ae.format(h);return _.charAt(0).toUpperCase()+_.slice(1)},O=36.7,q=o=>`${o??""}`.toUpperCase()==="NIO",Te=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],Me=Te.reduce((o,l)=>(o[l.value]=l.label,o),{});function Ge(){const[o,l]=n.useState([]),[g,h]=n.useState([]),[_,T]=n.useState(!0),[H,m]=n.useState(null),[r,F]=n.useState({from:"",to:"",category_id:""}),[k,K]=n.useState("list"),[M,X]=n.useState(!1),[$,j]=n.useState(null),[d,ie]=n.useState([]),[p,U]=n.useState(null),[re,R]=n.useState(!1),[w,J]=n.useState(!1),[N,P]=n.useState(null),[V,I]=n.useState(""),[f,Q]=n.useState(!1),[b,G]=n.useState(null),[le,z]=n.useState(!1),[C,W]=n.useState(!1),[L,A]=n.useState(null),Y=n.useRef(!1),me=n.useCallback(async()=>{try{const s=await y("/categories?type=income");h(s??[])}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudieron cargar las categor√≠as";m(a)}},[]),Z=$e({defaultValues:{amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),{register:E,handleSubmit:de,reset:ue,watch:he,setValue:ee,formState:{isSubmitting:se}}=Z,ae=he("source"),ge=n.useCallback(({source:s,account:a})=>{s==="bank"&&a?(A(a),ee("currency",a.currency,{shouldValidate:!0,shouldDirty:!0})):A(null)},[ee]);n.useEffect(()=>{ae!=="bank"&&A(null)},[ae]);const pe=L?.currency??null,S=n.useCallback(async(s={})=>{T(!0);try{const a=new URLSearchParams;s.from&&a.set("from",s.from),s.to&&a.set("to",s.to),s.category_id&&a.set("category_id",s.category_id);const[t,c]=await Promise.all([y(`/incomes${a.toString()?`?${a.toString()}`:""}`),y("/categories?type=income")]);l(t??[]),h(c??[]),m(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudieron cargar los ingresos";m(t)}finally{T(!1)}},[]);n.useEffect(()=>{Y.current||(Y.current=!0,S(r))},[r,S]);const xe=async s=>{try{const a=s.source==="bank"&&s.account_id||null,c=(s.source==="bank"&&L&&L.id===a?L:null)?.currency??s.currency;await y("/incomes",{method:"POST",body:{amount:Number(s.amount),currency:c,source:s.source,account_id:a,date:s.date,category_id:s.category_id||null,note:s.note??null}}),ue({amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}),A(null),await S(r),K("list")}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo registrar el ingreso";m(t)}},ye=n.useCallback(s=>{U(s),R(!0)},[]),fe=n.useCallback(()=>{w||(R(!1),U(null))},[w]),be=n.useCallback(async()=>{if(p){J(!0);try{await y(`/incomes/${p.id}`,{method:"DELETE"}),l(s=>s.filter(a=>a.id!==p.id)),R(!1),U(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar el ingreso";m(a)}finally{J(!1)}}},[p]),_e=n.useCallback(s=>{P(s.id),I(s.name??"")},[]),je=n.useCallback(()=>{f||(P(null),I(""))},[f]),Ne=n.useCallback(async()=>{if(!N)return;const s=V.trim();if(s.length<2){m("El nombre debe tener al menos 2 caracteres.");return}Q(!0);try{await y(`/categories/${N}`,{method:"PUT",body:{name:s,type:"income"}}),h(a=>a.map(t=>t.id===N?{...t,name:s}:t)),l(a=>a.map(t=>t.category_id===N?{...t,category_name:s}:t)),P(null),I(""),m(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";m(t)}finally{Q(!1)}},[V,N]),Ce=n.useCallback(s=>{G(s),z(!0)},[]),Se=n.useCallback(()=>{C||(z(!1),G(null))},[C]),De=n.useCallback(async()=>{if(b){W(!0);try{await y(`/categories/${b.id}`,{method:"DELETE"}),h(s=>s.filter(a=>a.id!==b.id)),l(s=>s.map(a=>a.category_id===b.id?{...a,category_id:null,category_name:null}:a)),z(!1),G(null),m(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar la categor√≠a";m(a)}finally{W(!1)}}},[b]),D=n.useMemo(()=>o.reduce((s,a)=>{const t=Number(a.amount??0),c=q(a.currency),i=c?t/O:t,u=c?t:t*O;s.usd+=i,s.nio+=u;const x=a.source==="bank"?"bank":"cash";return s[x].usd+=i,s[x].nio+=u,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),ne=n.useMemo(()=>{if(!o.length)return[];const s=new Map;for(const a of o){if(!a?.date)continue;const t=a.date.slice(0,7);s.has(t)||s.set(t,{usd:0,nio:0,count:0});const c=s.get(t),i=Number(a.amount??0),u=q(a.currency),x=u?i/O:i,ke=u?i:i*O;c.usd+=x,c.nio+=ke,c.count+=1}return Array.from(s.entries()).map(([a,t])=>({month:a,label:Oe(a),usd:t.usd,nio:t.nio,count:t.count})).sort((a,t)=>a.month<t.month?1:-1)},[o]);n.useEffect(()=>{!r.from&&!r.to&&!r.category_id&&ie(ne)},[ne,r]),n.useEffect(()=>{if(!d.length){j(null);return}j(s=>s&&d.some(a=>a.month===s)?s:d[0].month)},[d]);const v=n.useMemo(()=>$?d.find(s=>s.month===$)??null:null,[d,$]),ve=n.useMemo(()=>d.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[d]),B=n.useCallback(s=>{const{name:a,value:t}=s.target;F(c=>({...c,[a]:t})),(a==="from"||a==="to")&&j(null)},[F,j]),Ee=s=>{const[a,t]=s.split("-"),c=new Date(Number(a),Number(t)-1,1),i=new Date(Number(a),Number(t),0),u=c.toISOString().slice(0,10),x=i.toISOString().slice(0,10);return{from:u,to:x}},Fe=n.useCallback(s=>{const a=Ee(s),t={from:a.from,to:a.to,category_id:r.category_id};j(s),F(t),S(t)},[r.category_id,S,F]);return e.jsxs("section",{className:"incomes",children:[e.jsxs("header",{className:"incomes__header",children:[e.jsxs("div",{className:"incomes__heading",children:[e.jsx("h1",{children:"Ingresos"}),e.jsx("p",{children:"Consulta, registra y organiza tus ingresos."}),e.jsx("nav",{className:"incomes__tabs incomes__actions",children:[{id:"list",label:"Lista de ingresos",icon:"üìã"},{id:"add",label:"Agregar ingreso",icon:"‚ûï"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>K(s.id),className:`incomes__tab ${k===s.id?"incomes__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"incomes__summary",children:[e.jsx("span",{className:"incomes__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"incomes__summary-value incomes__summary-value--nio",children:["C$",D.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"incomes__summary-value",children:["$",D.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Cuenta bancaria: C$",D.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",D.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Efectivo: C$",D.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",D.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),H?e.jsx("p",{className:"incomes__error",children:H}):null,k==="list"?e.jsxs("article",{className:"incomes-card",children:[e.jsx("header",{className:"incomes-card__header",children:e.jsxs("div",{className:"incomes-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üìë"}),"Lista de ingresos"]}),e.jsx("p",{children:"Filtra por fechas o categor√≠as para encontrar movimientos espec√≠ficos."})]})}),e.jsxs("section",{className:`incomes-monthly${d.length>0?" incomes-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"incomes-monthly__info",children:[d.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Consulta c√≥mo evolucionan tus ingresos y cu√°ntos movimientos registraste cada mes."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),j(null),S({...r})},className:"incomes-filters",children:[e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:r.from,onChange:B,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:r.to,onChange:B,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:r.category_id,onChange:B,className:"incomes-input",children:[e.jsx("option",{value:"",children:"Todas"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"incomes-button",children:"Aplicar filtros"})]})]}),d.length>0?e.jsxs("div",{className:"incomes-monthly__aside",children:[e.jsxs("label",{className:"incomes-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"incomes-monthly__select",value:$??"",onChange:s=>{const{value:a}=s.target;a&&Fe(a)},children:ve.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),v?e.jsxs("article",{className:"incomes-monthly__card incomes-monthly__card--focus",children:[e.jsxs("div",{className:"incomes-monthly__card-header",children:[e.jsx("h4",{children:v.label}),e.jsxs("span",{className:"incomes-monthly__hint",children:[v.count," ",v.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"incomes-monthly__value incomes-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",oe(v.nio)]})]}),e.jsxs("p",{className:"incomes-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",oe(v.usd)]})]})]}):e.jsx("p",{className:"incomes-card__placeholder incomes-monthly__placeholder",children:"Selecciona un mes para ver el resumen."})]}):null]}),_?e.jsx("p",{className:"incomes-card__placeholder",children:"Cargando ingresos..."}):o.length===0?e.jsx("p",{className:"incomes-card__placeholder",children:"No hay ingresos registrados con los filtros actuales."}):e.jsx("div",{className:"incomes-table__wrapper",children:e.jsxs("table",{className:"incomes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"incomes-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:ce(s.date)}),e.jsxs("td",{className:"incomes-table__amount",children:[q(s.currency)?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:s.source==="bank"?Le(s.account)||"Cuenta bancaria":Me[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"incomes-table__note",children:s.note??"-"}),e.jsx("td",{className:"incomes-table__actions",children:e.jsx("button",{onClick:()=>ye(s),className:"incomes-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,k==="add"?e.jsx(we,{...Z,children:e.jsxs("form",{onSubmit:de(xe),className:"incomes-card incomes-form",children:[e.jsxs("div",{className:"incomes-form__intro",children:[e.jsx("h2",{children:"Registrar ingreso"}),e.jsx("p",{children:"Completa el formulario para registrar un nuevo movimiento."})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...E("amount"),className:"incomes-input"})]}),e.jsx(Ie,{sourceField:"source",accountField:"account_id",label:"Origen del ingreso",accountLabel:"Cuenta bancaria",fieldClass:"incomes-field",accountFieldClass:"incomes-field",sourceSelectClass:"incomes-input",accountSelectClass:"incomes-input",containerClass:"incomes-account-selector",onAccountChange:ge}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...E("currency"),className:"incomes-input",disabled:!!pe,children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...E("date"),className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...E("category_id"),className:"incomes-input",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"incomes-field incomes-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Detalles opcionales",...E("note"),className:"incomes-textarea"})]}),e.jsx("button",{type:"submit",disabled:se,className:"incomes-button incomes-button--primary",children:se?"Guardando...":"Guardar ingreso"})]})}):null,k==="category"?e.jsxs("section",{className:"incomes-card incomes-category",children:[e.jsxs("div",{className:"incomes-category__intro",children:[e.jsx("h2",{children:"Nueva categor√≠a de ingreso"}),e.jsx("p",{children:"Agrupa tus movimientos con categor√≠as creadas a medida."})]}),e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const a=s.currentTarget,c=`${new FormData(a).get("name")??""}`.trim();if(c)try{X(!0);const i=await y("/categories",{method:"POST",body:{name:c,type:"income"}});a.reset(),i?h(u=>[i,...u.filter(x=>x.id!==i.id)]):await me(),m(null)}catch(i){console.error(i);const u=i.payload?.message??i.message??"No se pudo crear la categor√≠a";m(u)}finally{X(!1)}},className:"incomes-category__form",children:[e.jsxs("label",{className:"incomes-field incomes-category__field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Salarios, ventas, freelance...",required:!0,className:"incomes-input"})]}),e.jsx("button",{type:"submit",disabled:M,className:`incomes-button incomes-button--primary ${M?"is-disabled":""}`,children:M?"Creando...":"Crear categor√≠a"})]}),e.jsxs("div",{className:"incomes-category__list",children:[e.jsxs("div",{className:"incomes-category__list-header",children:[e.jsx("h3",{children:"Mis categor√≠as"}),e.jsx("p",{children:"Administra los nombres que aparecen en tus ingresos y re√∫salos cuando los necesites."})]}),g.length===0?e.jsx("p",{className:"incomes-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):e.jsx("ul",{className:"incomes-category__items",children:g.map(s=>e.jsx("li",{className:"incomes-category__item",children:N===s.id?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:V,onChange:a=>I(a.target.value),className:"incomes-input incomes-category__input",autoFocus:!0}),e.jsxs("div",{className:"incomes-category__actions",children:[e.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--primary",onClick:Ne,disabled:f,children:f?"Guardando‚Ä¶":"Guardar"}),e.jsx("button",{type:"button",className:"incomes-category__button",onClick:je,disabled:f,children:"Cancelar"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"incomes-category__name",children:s.name}),e.jsxs("div",{className:"incomes-category__actions",children:[e.jsx("button",{type:"button",className:"incomes-category__button",onClick:()=>_e(s),disabled:f||C,children:"Editar"}),e.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--danger",onClick:()=>Ce(s),disabled:f||C,children:"Eliminar"})]})]})},s.id))})]})]}):null,e.jsx(te,{open:re,title:"Eliminar ingreso",message:p?`Eliminar√°s el ingreso del ${ce(p.date)} por ${p.currency==="NIO"?"C$":"$"}${Number(p.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:w?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:w,onConfirm:be,onCancel:fe}),e.jsx(te,{open:le,title:"Eliminar categor√≠a",message:b?`¬øDeseas eliminar la categor√≠a ‚Äú${b.name}‚Äù? Los ingresos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:C?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:C,onConfirm:De,onCancel:Se})]})}export{Ge as default};
