import{d as S,r as f,s as p,j as e}from"./index-D38TlpaS.js";import{u as E}from"./index.esm-qAfggAJ1.js";const C="PASSWORD_RECOVERY";function V(){const s=S(),{register:i,handleSubmit:c,watch:h,formState:{errors:n}}=E({defaultValues:{password:"",confirmPassword:""}}),[l,t]=f.useState("checking"),[a,o]=f.useState(null),[w,x]=f.useState(!1),b=f.useMemo(()=>R(),[]);f.useEffect(()=>{let r=!0;(async()=>{const{data:d}=await p.auth.getSession();if(d.session){v(),r&&t("ready");return}if(!b){r&&(t("error"),o({variant:"error",message:"El enlace no es válido o ya fue utilizado. Solicita uno nuevo desde tu perfil."}));return}const{accessToken:y,refreshToken:N}=b;try{const{error:m}=await p.auth.setSession({access_token:y,refresh_token:N});if(m)throw m;v(),r&&t("ready")}catch(m){console.error("Error estableciendo sesión de recuperación",m),r&&(t("error"),o({variant:"error",message:m?.message??"No pudimos validar el enlace. Solicita uno nuevo desde tu perfil."}))}})();const{data:g}=p.auth.onAuthStateChange(d=>{r&&d===C&&(v(),t("ready"))});return()=>{r=!1,g.subscription.unsubscribe()}},[b]);const j=async r=>{x(!0),o(null);try{const{data:u,error:g}=await p.auth.updateUser({password:r.password});if(g)throw g;t("success"),o({variant:"success",message:"Tu contraseña se actualizó correctamente. Vamos a redirigirte al inicio de sesión."});const d=u?.user?.email??null;d?_(d):L(),await p.auth.signOut(),window.setTimeout(()=>{s("/login",{replace:!0})},3e3)}catch(u){console.error("Error actualizando contraseña",u),o({variant:"error",message:u?.message??"No pudimos actualizar tu contraseña. Intenta nuevamente."}),x(!1)}};if(l==="checking")return e.jsx("main",{className:"reset-page",children:e.jsxs("section",{className:"reset-card",children:[e.jsx("h1",{children:"Validando enlace…"}),e.jsx("p",{children:"Estamos verificando que tu enlace de recuperación sea válido."})]})});if(l==="error"&&a)return e.jsx("main",{className:"reset-page",children:e.jsxs("section",{className:"reset-card",children:[e.jsx("h1",{children:"Enlace no válido"}),e.jsx("p",{className:`reset-feedback reset-feedback--${a.variant}`,children:a.message}),e.jsx("button",{type:"button",className:"reset-button",onClick:()=>s("/login",{replace:!0}),children:"Volver al inicio de sesión"})]})});if(l==="success"&&a)return e.jsx("main",{className:"reset-page",children:e.jsxs("section",{className:"reset-card",children:[e.jsx("h1",{children:"Contraseña actualizada"}),e.jsx("p",{className:`reset-feedback reset-feedback--${a.variant}`,children:a.message}),e.jsx("button",{type:"button",className:"reset-button",onClick:()=>s("/login",{replace:!0}),children:"Ir a iniciar sesión"})]})});const k=h("password");return e.jsx("main",{className:"reset-page",children:e.jsxs("section",{className:"reset-card",children:[e.jsxs("header",{className:"reset-card__header",children:[e.jsx("h1",{children:"Crea una nueva contraseña"}),e.jsx("p",{children:"El enlace que recibiste es válido por una sola vez. Define tu nueva contraseña y continúa con tu cuenta."})]}),e.jsxs("form",{onSubmit:c(j),className:"reset-form",children:[e.jsxs("label",{className:"reset-field",children:[e.jsx("span",{children:"Nueva contraseña"}),e.jsx("input",{type:"password",autoComplete:"new-password",...i("password",{required:"La contraseña es obligatoria",minLength:{value:8,message:"Debe tener al menos 8 caracteres"}}),className:"reset-input",placeholder:"••••••••",disabled:w}),n.password?e.jsx("small",{className:"reset-error",children:n.password.message}):null]}),e.jsxs("label",{className:"reset-field",children:[e.jsx("span",{children:"Confirma tu contraseña"}),e.jsx("input",{type:"password",autoComplete:"new-password",...i("confirmPassword",{required:"Confirma tu contraseña",validate:r=>r===k||"Las contraseñas no coinciden"}),className:"reset-input",placeholder:"••••••••",disabled:w}),n.confirmPassword?e.jsx("small",{className:"reset-error",children:n.confirmPassword.message}):null]}),a&&a.variant==="error"?e.jsx("p",{className:`reset-feedback reset-feedback--${a.variant}`,children:a.message}):null,e.jsx("button",{type:"submit",className:"reset-button",disabled:w,children:w?"Guardando…":"Guardar nueva contraseña"})]})]})})}function R(){if(typeof window>"u")return null;const s=window.location.hash??"";if(!s.includes("access_token"))return null;const c=s.split("#").filter(Boolean).find(o=>o.includes("access_token="))??"";if(!c)return null;const h=c.includes("?")?c.split("?").pop()??"":c;if(!h)return null;const n=new URLSearchParams(h),l=n.get("access_token"),t=n.get("refresh_token"),a=n.get("type");return!l||!t||a!=="recovery"?null:{accessToken:l,refreshToken:t}}function v(){if(typeof window>"u")return;const s=`${window.location.origin}${window.location.pathname}#/reset-password`;window.history.replaceState({},document.title,s)}function _(s){typeof window>"u"||!s||window.localStorage.removeItem(`login-lock:${s.toLowerCase()}`)}function L(){if(typeof window>"u")return;const s=Object.keys(window.localStorage);for(const i of s)i.startsWith("login-lock:")&&window.localStorage.removeItem(i)}export{V as default};
