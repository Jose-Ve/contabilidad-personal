import{u as J,r,d as H,j as e,L as O,s as P,a as W}from"./index-D38TlpaS.js";import{u as X}from"./index.esm-qAfggAJ1.js";import{l as Y}from"./logo-TWH5c1sz.js";const R=3,G=300*1e3,i={attempts:0,lockedUntil:null};function re(){const{register:n,handleSubmit:t,formState:{errors:s,submitCount:u},watch:k}=X({mode:"onSubmit",reValidateMode:"onChange"}),{user:l}=J(),[h,c]=r.useState(null),[L,S]=r.useState(!1),[v,C]=r.useState(null),[_,T]=r.useState(0),[b,g]=r.useState(null),[w,$]=r.useState(!1),[f,p]=r.useState(()=>({...i})),[E,x]=r.useState(null),[A,D]=r.useState(!1),U=H(),d=k("email");r.useEffect(()=>{l&&!w&&U("/dashboard",{replace:!0})},[l,w,U]),r.useEffect(()=>{!l&&w&&$(!1)},[l,w]),r.useEffect(()=>{if(!d){p({...i}),x(null);return}const a=Z(d);p(a)},[d]);const j=f.lockedUntil?f.lockedUntil>Date.now():!1;if(r.useEffect(()=>{if(!f.lockedUntil){x(null);return}if(!j){p({...i}),d&&M(d),x(null);return}const a=()=>{const o=f.lockedUntil-Date.now();if(o<=0){p({...i}),d&&M(d),x(null);return}x(V(o))};a();const m=window.setInterval(a,1e3);return()=>window.clearInterval(m)},[f.lockedUntil,d,j]),r.useEffect(()=>{if(!b)return;const a=setTimeout(()=>{g(null)},5e3);return()=>clearTimeout(a)},[b]),l&&!w)return e.jsx("div",{style:{display:"grid",placeItems:"center",minHeight:"100vh",background:"radial-gradient(circle at top left, rgba(59, 130, 246, 0.25), transparent 55%), radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.2), transparent 60%), linear-gradient(180deg, #030712 0%, #02030a 100%)",color:"#e2e8f0"},children:e.jsx("p",{children:"Redirigiendo…"})});const z=async a=>{if(j){c(E?`Bloqueamos temporalmente el inicio de sesión por seguridad. Espera ${E} o restablece tu contraseña.`:"Bloqueamos temporalmente el inicio de sesión por seguridad. Solicita el reinicio de tu contraseña para continuar.");return}S(!0),c(null),g(null),v&&v!==a.email&&T(0),C(null);const{data:m,error:o}=await P.auth.signInWithPassword({email:a.email,password:a.password});if(o){const q=o.message?o.message.toLowerCase():"";let y=o.message;if(q.includes("invalid login credentials")){const I=Q(a.email,f);if(p(I.state),I.locked)y=`Ingresaste una contraseña incorrecta demasiadas veces. Espera ${V(I.remainingMs)} o restablece tu contraseña.`;else{const F=Math.max(R-I.state.attempts,0);y=F>0?`Contraseña incorrecta. Intentos restantes: ${F}.`:"Contraseña incorrecta."}}else q.includes("email not confirmed")&&(y="Debes confirmar tu correo para acceder. Revisa tu bandeja de entrada.",C(a.email));c(y),S(!1);return}if(m?.user?.app_metadata?.disabled===!0){$(!0),await P.auth.signOut(),c("Tu cuenta está desactivada por un administrador. Ponte en contacto para reactivarla."),S(!1);return}S(!1),C(null),T(0),M(a.email),p({...i}),U("/dashboard",{replace:!0})},K=async()=>{if(v){if(_>=2){g({message:"Parece que no ha llegado tu correo, vuelve a registrarte e ingresa bien tu correo.",variant:"warning"});return}try{await W("/register/resend",{method:"POST",body:{email:v}}),T(a=>a+1),g({message:"Te enviamos un nuevo correo de verificación. Revísalo en unos segundos.",variant:"success"})}catch(a){console.error("Error reenviando confirmación",a),g({message:a.message??"No pudimos reenviar el correo. Intenta más tarde.",variant:"error"})}}},B=async()=>{c(null),g(null);const a=d?.trim();if(!a){c("Ingresa tu correo para poder enviarte el enlace de recuperación.");return}try{D(!0);const m=`${window.location.origin}${window.location.pathname}#/reset-password`,{error:o}=await P.auth.resetPasswordForEmail(a,{redirectTo:m});if(o)throw o;g({message:"Te enviamos un enlace para restablecer tu contraseña. El correo puede tardar algunos minutos en llegar; revisa tu correo o carpeta de spam.",variant:"success"})}catch(m){console.error("Error solicitando reset desde login",m),c(m?.message??"No pudimos enviar el enlace. Intenta nuevamente en unos minutos.")}finally{D(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("main",{className:"login-page",children:[e.jsx("section",{className:"login-form",role:"main",children:e.jsxs("div",{className:"login-form__inner",children:[e.jsxs("header",{className:"login-form__header",children:[e.jsxs(O,{to:"/",className:"login-form__brand",children:[e.jsx("div",{className:"login-form__logo",children:e.jsx("img",{src:Y,alt:"Panel Contable"})}),e.jsx("span",{children:"Panel Contable"})]}),e.jsxs("div",{children:[e.jsx("h1",{children:"Inicia sesión"}),e.jsx("p",{children:"Administra tu tablero con seguridad reforzada y datos en vivo."})]})]}),e.jsxs("form",{onSubmit:t(z),className:"login-form__form",noValidate:!0,children:[e.jsxs("label",{className:"form-field",children:[e.jsx("span",{children:"Correo electrónico"}),e.jsx("input",{type:"email",placeholder:"tu@correo.com",required:!0,...n("email",{required:"El correo es obligatorio",pattern:{value:/^[^\s@]+@[^\s@]+\.(com|es|org|edu|gov|ni)$/i,message:"Usa un dominio válido (.com, .es, .org, .edu, .gov, .ni)"}}),className:"form-input"}),u>0&&s.email?e.jsx("small",{className:"form-feedback form-feedback--error",children:s.email.message}):null]}),e.jsxs("label",{className:"form-field",children:[e.jsx("span",{children:"Contraseña"}),e.jsx("input",{type:"password",placeholder:"••••••••",required:!0,...n("password",{required:"La contraseña es obligatoria"}),className:"form-input"}),u>0&&s.password?e.jsx("small",{className:"form-feedback form-feedback--error",children:s.password.message}):null]}),h?e.jsx("p",{className:"form-feedback form-feedback--error",children:h}):null,j?e.jsxs("div",{className:"login-lock-warning",children:[e.jsxs("p",{children:["Por seguridad bloqueamos el inicio de sesión durante unos minutos. ",E?`Tiempo restante: ${E}. `:"","Si olvidaste tu contraseña, puedes solicitar un enlace de recuperación."]}),e.jsx("button",{type:"button",className:"login-reset-button",onClick:B,disabled:A,children:A?"Enviando enlace…":"Enviar enlace para restablecer contraseña"})]}):null,v?e.jsxs("div",{className:"login-resend",children:[e.jsx("span",{children:"¿No encuentras el correo?"}),e.jsx("button",{type:"button",onClick:K,className:"login-resend__button",disabled:L,children:"Reenviar verificación"}),_>0&&_<3?e.jsxs("small",{children:["Intentos usados: ",_," de 2"]}):null]}):null,e.jsx("button",{type:"submit",disabled:L||j,className:"form-submit",children:L?"Ingresando…":"Entrar"})]}),e.jsxs("p",{className:"login-form__footer",children:["¿Aún no tienes cuenta? ",e.jsx(O,{to:"/register",className:"login-form__link",children:"Registrarte"})]})]})}),e.jsxs("section",{className:"login-visual","aria-hidden":"true",children:[e.jsx("div",{className:"login-visual__top",children:e.jsx("span",{children:"Acceso seguro"})}),e.jsx("div",{className:"login-visual__center",children:e.jsxs("div",{className:"login-glass",children:[e.jsx("div",{className:"login-glass__halo"}),e.jsxs("div",{className:"login-glass__content",children:[e.jsx("h2",{children:"Visibilidad inmediata"}),e.jsx("p",{children:"Administra tus finanzas con confianza. Nuestro panel intuitivo te ofrece una visión clara y en tiempo real de tus ingresos y gastos, permitiéndote tomar decisiones informadas al instante."})]})]})}),e.jsx("div",{className:"login-visual__footer",children:e.jsx("p",{children:"Panel Contable · Protección y claridad 24/7"})})]})]}),b?e.jsx("div",{className:`login-toast login-toast--${b.variant}`,children:b.message}):null]})}function Q(n,t){const s=t??i,u=Math.min((s.attempts??0)+1,R),k=u>=R,l=k?Date.now()+G:s.lockedUntil??null,h={attempts:u,lockedUntil:l};ee(n,h);const c=l?Math.max(l-Date.now(),0):null;return{state:h,locked:k,remainingMs:c}}function Z(n){if(!n||typeof window>"u")return i;try{const t=window.localStorage.getItem(N(n));if(!t)return i;const s=JSON.parse(t);return s.lockedUntil&&s.lockedUntil<=Date.now()?(window.localStorage.removeItem(N(n)),i):{attempts:Number.isFinite(s.attempts)?s.attempts:0,lockedUntil:Number.isFinite(s.lockedUntil)?s.lockedUntil:null}}catch(t){return console.warn("No pudimos leer el estado de bloqueo del login",t),i}}function ee(n,t){if(!(!n||typeof window>"u")){if(!t.attempts&&!t.lockedUntil){window.localStorage.removeItem(N(n));return}window.localStorage.setItem(N(n),JSON.stringify(t))}}function M(n){!n||typeof window>"u"||window.localStorage.removeItem(N(n))}function N(n){return`login-lock:${n.toLowerCase()}`}function V(n){const t=Math.max(Math.ceil(n/1e3),0),s=Math.floor(t/60),u=t%60;return s<=0?`${u} s`:`${s} min ${u.toString().padStart(2,"0")} s`}export{re as default};
