import{r as t,a as y,j as e}from"./index-DB_UKz0h.js";import{u as Ne}from"./index.esm-B3JwpmJa.js";import{C as Y}from"./ConfirmDialog-C3TphCV6.js";const Z=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Ce=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),ee=o=>{if(!o)return"";const l=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(o);if(!l)return new Date(o).toLocaleDateString("es-NI");const[,g,h,b]=l;return new Date(Number(g),Number(h)-1,Number(b)).toLocaleDateString("es-NI")},Se=o=>{if(!o)return"";const[l,g]=o.split("-"),h=new Date(Number(l),Number(g)-1,1),b=Ce.format(h);return b.charAt(0).toUpperCase()+b.slice(1)},L=36.7,se=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],De=se.reduce((o,l)=>(o[l.value]=l.label,o),{});function ke(){const[o,l]=t.useState([]),[g,h]=t.useState([]),[b,O]=t.useState(!0),[z,m]=t.useState(null),[r,F]=t.useState({from:"",to:"",category_id:""}),[k,q]=t.useState("list"),[T,B]=t.useState(!1),[$,j]=t.useState(null),[d,ae]=t.useState([]),[x,M]=t.useState(null),[ne,A]=t.useState(!1),[w,H]=t.useState(!1),[N,R]=t.useState(null),[U,I]=t.useState(""),[_,K]=t.useState(!1),[f,P]=t.useState(null),[te,G]=t.useState(!1),[C,X]=t.useState(!1),J=t.useRef(!1),oe=t.useCallback(async()=>{try{const s=await y("/categories?type=income");h(s??[])}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudieron cargar las categor√≠as";m(a)}},[]),{register:S,handleSubmit:ie,reset:ce,formState:{isSubmitting:Q}}=Ne({defaultValues:{amount:"",currency:"NIO",source:"bank",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),D=t.useCallback(async(s={})=>{O(!0);try{const a=new URLSearchParams;s.from&&a.set("from",s.from),s.to&&a.set("to",s.to),s.category_id&&a.set("category_id",s.category_id);const[n,c]=await Promise.all([y(`/incomes${a.toString()?`?${a.toString()}`:""}`),y("/categories?type=income")]);l(n??[]),h(c??[]),m(null)}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudieron cargar los ingresos";m(n)}finally{O(!1)}},[]);t.useEffect(()=>{J.current||(J.current=!0,D(r))},[r,D]);const re=async s=>{try{await y("/incomes",{method:"POST",body:{amount:Number(s.amount),currency:s.currency,source:s.source,date:s.date,category_id:s.category_id||null,note:s.note??null}}),ce({amount:"",currency:s.currency,source:s.source,date:s.date,category_id:s.category_id,note:""}),await D(r),q("list")}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudo registrar el ingreso";m(n)}},le=t.useCallback(s=>{M(s),A(!0)},[]),me=t.useCallback(()=>{w||(A(!1),M(null))},[w]),de=t.useCallback(async()=>{if(x){H(!0);try{await y(`/incomes/${x.id}`,{method:"DELETE"}),l(s=>s.filter(a=>a.id!==x.id)),A(!1),M(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar el ingreso";m(a)}finally{H(!1)}}},[x]),ue=t.useCallback(s=>{R(s.id),I(s.name??"")},[]),he=t.useCallback(()=>{_||(R(null),I(""))},[_]),ge=t.useCallback(async()=>{if(!N)return;const s=U.trim();if(s.length<2){m("El nombre debe tener al menos 2 caracteres.");return}K(!0);try{await y(`/categories/${N}`,{method:"PUT",body:{name:s,type:"income"}}),h(a=>a.map(n=>n.id===N?{...n,name:s}:n)),l(a=>a.map(n=>n.category_id===N?{...n,category_name:s}:n)),R(null),I(""),m(null)}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";m(n)}finally{K(!1)}},[U,N]),xe=t.useCallback(s=>{P(s),G(!0)},[]),pe=t.useCallback(()=>{C||(G(!1),P(null))},[C]),ye=t.useCallback(async()=>{if(f){X(!0);try{await y(`/categories/${f.id}`,{method:"DELETE"}),h(s=>s.filter(a=>a.id!==f.id)),l(s=>s.map(a=>a.category_id===f.id?{...a,category_id:null,category_name:null}:a)),G(!1),P(null),m(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar la categor√≠a";m(a)}finally{X(!1)}}},[f]),v=t.useMemo(()=>o.reduce((s,a)=>{const n=Number(a.amount??0),c=a.currency==="NIO",i=c?n/L:n,u=c?n:n*L;s.usd+=i,s.nio+=u;const p=a.source==="bank"?"bank":"cash";return s[p].usd+=i,s[p].nio+=u,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),W=t.useMemo(()=>{if(!o.length)return[];const s=new Map;for(const a of o){if(!a?.date)continue;const n=a.date.slice(0,7);s.has(n)||s.set(n,{usd:0,nio:0,count:0});const c=s.get(n),i=Number(a.amount??0),u=a.currency==="NIO",p=u?i/L:i,je=u?i:i*L;c.usd+=p,c.nio+=je,c.count+=1}return Array.from(s.entries()).map(([a,n])=>({month:a,label:Se(a),usd:n.usd,nio:n.nio,count:n.count})).sort((a,n)=>a.month<n.month?1:-1)},[o]);t.useEffect(()=>{!r.from&&!r.to&&!r.category_id&&ae(W)},[W,r]),t.useEffect(()=>{if(!d.length){j(null);return}j(s=>s&&d.some(a=>a.month===s)?s:d[0].month)},[d]);const E=t.useMemo(()=>$?d.find(s=>s.month===$)??null:null,[d,$]),_e=t.useMemo(()=>d.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[d]),V=t.useCallback(s=>{const{name:a,value:n}=s.target;F(c=>({...c,[a]:n})),(a==="from"||a==="to")&&j(null)},[F,j]),fe=s=>{const[a,n]=s.split("-"),c=new Date(Number(a),Number(n)-1,1),i=new Date(Number(a),Number(n),0),u=c.toISOString().slice(0,10),p=i.toISOString().slice(0,10);return{from:u,to:p}},be=t.useCallback(s=>{const a=fe(s),n={from:a.from,to:a.to,category_id:r.category_id};j(s),F(n),D(n)},[r.category_id,D,F]);return e.jsxs("section",{className:"incomes",children:[e.jsxs("header",{className:"incomes__header",children:[e.jsxs("div",{className:"incomes__heading",children:[e.jsx("h1",{children:"Ingresos"}),e.jsx("p",{children:"Consulta, registra y organiza tus ingresos."}),e.jsx("nav",{className:"incomes__tabs incomes__actions",children:[{id:"list",label:"Lista de ingresos",icon:"üìã"},{id:"add",label:"Agregar ingreso",icon:"‚ûï"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>q(s.id),className:`incomes__tab ${k===s.id?"incomes__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"incomes__summary",children:[e.jsx("span",{className:"incomes__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"incomes__summary-value incomes__summary-value--nio",children:["C$",v.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"incomes__summary-value",children:["$",v.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Cuenta bancaria: C$",v.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",v.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Efectivo: C$",v.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",v.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),z?e.jsx("p",{className:"incomes__error",children:z}):null,k==="list"?e.jsxs("article",{className:"incomes-card",children:[e.jsx("header",{className:"incomes-card__header",children:e.jsxs("div",{className:"incomes-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üìë"}),"Lista de ingresos"]}),e.jsx("p",{children:"Filtra por fechas o categor√≠as para encontrar movimientos espec√≠ficos."})]})}),e.jsxs("section",{className:`incomes-monthly${d.length>0?" incomes-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"incomes-monthly__info",children:[d.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Consulta c√≥mo evolucionan tus ingresos y cu√°ntos movimientos registraste cada mes."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),j(null),D({...r})},className:"incomes-filters",children:[e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:r.from,onChange:V,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:r.to,onChange:V,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:r.category_id,onChange:V,className:"incomes-input",children:[e.jsx("option",{value:"",children:"Todas"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"incomes-button",children:"Aplicar filtros"})]})]}),d.length>0?e.jsxs("div",{className:"incomes-monthly__aside",children:[e.jsxs("label",{className:"incomes-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"incomes-monthly__select",value:$??"",onChange:s=>{const{value:a}=s.target;a&&be(a)},children:_e.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),E?e.jsxs("article",{className:"incomes-monthly__card incomes-monthly__card--focus",children:[e.jsxs("div",{className:"incomes-monthly__card-header",children:[e.jsx("h4",{children:E.label}),e.jsxs("span",{className:"incomes-monthly__hint",children:[E.count," ",E.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"incomes-monthly__value incomes-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",Z(E.nio)]})]}),e.jsxs("p",{className:"incomes-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",Z(E.usd)]})]})]}):e.jsx("p",{className:"incomes-card__placeholder incomes-monthly__placeholder",children:"Selecciona un mes para ver el resumen."})]}):null]}),b?e.jsx("p",{className:"incomes-card__placeholder",children:"Cargando ingresos..."}):o.length===0?e.jsx("p",{className:"incomes-card__placeholder",children:"No hay ingresos registrados con los filtros actuales."}):e.jsx("div",{className:"incomes-table__wrapper",children:e.jsxs("table",{className:"incomes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"incomes-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:ee(s.date)}),e.jsxs("td",{className:"incomes-table__amount",children:[s.currency==="NIO"?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:De[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"incomes-table__note",children:s.note??"-"}),e.jsx("td",{className:"incomes-table__actions",children:e.jsx("button",{onClick:()=>le(s),className:"incomes-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,k==="add"?e.jsxs("form",{onSubmit:ie(re),className:"incomes-card incomes-form",children:[e.jsxs("div",{className:"incomes-form__intro",children:[e.jsx("h2",{children:"Registrar ingreso"}),e.jsx("p",{children:"Completa el formulario para registrar un nuevo movimiento."})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...S("amount"),className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...S("currency"),className:"incomes-input",children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Origen del ingreso"}),e.jsx("select",{...S("source"),className:"incomes-input",children:se.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...S("date"),className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...S("category_id"),className:"incomes-input",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),g.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"incomes-field incomes-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Detalles opcionales",...S("note"),className:"incomes-textarea"})]}),e.jsx("button",{type:"submit",disabled:Q,className:"incomes-button incomes-button--primary",children:Q?"Guardando...":"Guardar ingreso"})]}):null,k==="category"?e.jsxs("section",{className:"incomes-card incomes-category",children:[e.jsxs("div",{className:"incomes-category__intro",children:[e.jsx("h2",{children:"Nueva categor√≠a de ingreso"}),e.jsx("p",{children:"Agrupa tus movimientos con categor√≠as creadas a medida."})]}),e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const a=s.currentTarget,c=`${new FormData(a).get("name")??""}`.trim();if(c)try{B(!0);const i=await y("/categories",{method:"POST",body:{name:c,type:"income"}});a.reset(),i?h(u=>[i,...u.filter(p=>p.id!==i.id)]):await oe(),m(null)}catch(i){console.error(i);const u=i.payload?.message??i.message??"No se pudo crear la categor√≠a";m(u)}finally{B(!1)}},className:"incomes-category__form",children:[e.jsxs("label",{className:"incomes-field incomes-category__field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Salarios, ventas, freelance...",required:!0,className:"incomes-input"})]}),e.jsx("button",{type:"submit",disabled:T,className:`incomes-button incomes-button--primary ${T?"is-disabled":""}`,children:T?"Creando...":"Crear categor√≠a"})]}),e.jsxs("div",{className:"incomes-category__list",children:[e.jsxs("div",{className:"incomes-category__list-header",children:[e.jsx("h3",{children:"Mis categor√≠as"}),e.jsx("p",{children:"Administra los nombres que aparecen en tus ingresos y re√∫salos cuando los necesites."})]}),g.length===0?e.jsx("p",{className:"incomes-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):e.jsx("ul",{className:"incomes-category__items",children:g.map(s=>e.jsx("li",{className:"incomes-category__item",children:N===s.id?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:U,onChange:a=>I(a.target.value),className:"incomes-input incomes-category__input",autoFocus:!0}),e.jsxs("div",{className:"incomes-category__actions",children:[e.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--primary",onClick:ge,disabled:_,children:_?"Guardando‚Ä¶":"Guardar"}),e.jsx("button",{type:"button",className:"incomes-category__button",onClick:he,disabled:_,children:"Cancelar"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"incomes-category__name",children:s.name}),e.jsxs("div",{className:"incomes-category__actions",children:[e.jsx("button",{type:"button",className:"incomes-category__button",onClick:()=>ue(s),disabled:_||C,children:"Editar"}),e.jsx("button",{type:"button",className:"incomes-category__button incomes-category__button--danger",onClick:()=>xe(s),disabled:_||C,children:"Eliminar"})]})]})},s.id))})]})]}):null,e.jsx(Y,{open:ne,title:"Eliminar ingreso",message:x?`Eliminar√°s el ingreso del ${ee(x.date)} por ${x.currency==="NIO"?"C$":"$"}${Number(x.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:w?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:w,onConfirm:de,onCancel:me}),e.jsx(Y,{open:te,title:"Eliminar categor√≠a",message:f?`¬øDeseas eliminar la categor√≠a ‚Äú${f.name}‚Äù? Los ingresos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:C?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:C,onConfirm:ye,onCancel:pe})]})}export{ke as default};
