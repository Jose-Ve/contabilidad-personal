import{r as o,s as L,j as e}from"./index-DB_UKz0h.js";const T=36.7,a=(t,p="NIO")=>new Intl.NumberFormat("es-NI",{style:"currency",currency:p,maximumFractionDigits:2}).format(Number(t??0)),l=t=>Number(t??0)/T||0,z=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),k=new Date,G=new Date(k.getFullYear(),0,1).toISOString().slice(0,10),H=k.toISOString().slice(0,10),O=t=>{if(!t)return"";const[p,d]=t.split("-"),g=new Date(Number(p),Number(d)-1,1),m=z.format(g);return m.charAt(0).toUpperCase()+m.slice(1)};function Y(){const[t,p]=o.useState({from:G,to:H}),[d,g]=o.useState({incomes:0,expenses:0,balance:0,series:[]}),[m,S]=o.useState(!1),[C,E]=o.useState(!1),[v,_]=o.useState(null),[x,F]=o.useState([]),w=o.useRef(!1),I=o.useCallback(s=>{const{name:n,value:r}=s.target;p(h=>({...h,[n]:r})),(n==="from"||n==="to")&&_(null)},[]),j=o.useCallback(async(s,{preserveMonths:n=!1}={})=>{S(!0);const r=s??t,b=(await L.auth.getSession()).data.session?.access_token;if(!b){S(!1);return}try{const i=new URLSearchParams(r),u=await fetch(`https://contabilidad-personal.onrender.com/balance?${i.toString()}`,{headers:{Authorization:`Bearer ${b}`}});if(!u.ok)throw new Error("No se pudo calcular el balance");const U=await u.json();if(g(U),!n){const A=Array.isArray(U?.series?.byMonth)?U.series.byMonth.map(N=>{const f=Number(N.incomes??0),D=Number(N.expenses??0),M=f-D;return{month:N.month,label:O(N.month),incomesNio:f,incomesUsd:l(f),expensesNio:D,expensesUsd:l(D),netNio:M,netUsd:l(M)}}):[];F(A.sort((N,f)=>N.month<f.month?1:-1))}}catch(i){console.error(i)}finally{S(!1),E(!0)}},[t]);o.useEffect(()=>{w.current||(w.current=!0,j(t))},[t,j]),o.useEffect(()=>{if(!x.length){_(null);return}_(s=>s&&x.some(n=>n.month===s)?s:x[0].month)},[x]);const R=s=>{const[n,r]=s.split("-"),h=new Date(Number(n),Number(r)-1,1),b=new Date(Number(n),Number(r),0),i=h.toISOString().slice(0,10),u=b.toISOString().slice(0,10);return{from:i,to:u}},$=o.useCallback(s=>{const n=R(s),r={...t,from:n.from,to:n.to};_(s),p(r),j(r,{preserveMonths:!0})},[t,j]),c=o.useMemo(()=>{const s=n=>n&&typeof n=="object"?{total:Number(n.total??0),bank:Number(n.bank??0),cash:Number(n.cash??0)}:{total:Number(n??0),bank:0,cash:0};return{incomes:s(d.incomes),expenses:s(d.expenses),balance:Number(d.balance??0)}},[d]),y=o.useMemo(()=>{const s=d?.series?.byMonth??[];let n=0;return s.map(r=>{const h=Number(r.incomes??0),b=Number(r.expenses??0),i=h-b,u=n;return n+=i,{month:r.month,label:O(r.month),incomesNio:h,incomesUsd:l(h),expensesNio:b,expensesUsd:l(b),netNio:i,netUsd:l(i),carryInNio:u,carryInUsd:l(u),carryOutNio:n,carryOutUsd:l(n)}})},[d?.series]),B=o.useMemo(()=>v?y.filter(s=>s.month===v):y,[y,v]);return e.jsxs("section",{className:"balance",children:[e.jsxs("header",{className:"balance__header",children:[e.jsxs("div",{className:"balance__intro",children:[e.jsx("h1",{children:"Balance"}),e.jsx("p",{children:"Filtra por rango de fechas para comparar tus ingresos y gastos."})]}),e.jsxs("div",{className:"balance__overview",children:[e.jsx("span",{className:"balance__overview-label",children:"Balance general"}),e.jsx("strong",{className:`balance__overview-value ${c.balance>=0?"is-positive":"is-negative"}`,children:a(c.balance)}),e.jsxs("span",{className:"balance__overview-detail",children:["Ingresos: ",a(c.incomes.total)," (≈ ",a(l(c.incomes.total),"USD"),")"]}),e.jsxs("span",{className:"balance__overview-detail",children:["Gastos: ",a(c.expenses.total)," (≈ ",a(l(c.expenses.total),"USD"),")"]})]})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),_(null),j(t)},className:"balance-filters",children:[e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{type:"date",name:"from",value:t.from,onChange:I,className:"balance-input"})]}),e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{type:"date",name:"to",value:t.to,onChange:I,className:"balance-input"})]}),e.jsx("button",{type:"submit",className:"balance-button",disabled:m,children:m?"Calculando...":"Aplicar filtros"})]}),m?e.jsx("p",{className:"balance__loading",children:"Calculando balance..."}):e.jsxs("div",{className:"balance-grid",children:[e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Ingresos"}),e.jsx("p",{className:"balance-card__value is-positive",children:a(c.incomes.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(l(c.incomes.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(c.incomes.bank)," (≈ ",a(l(c.incomes.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(c.incomes.cash)," (≈ ",a(l(c.incomes.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Gastos"}),e.jsx("p",{className:"balance-card__value is-negative",children:a(c.expenses.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(l(c.expenses.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(c.expenses.bank)," (≈ ",a(l(c.expenses.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(c.expenses.cash)," (≈ ",a(l(c.expenses.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Resultado"}),e.jsx("p",{className:`balance-card__value ${c.balance>=0?"is-positive":"is-negative"}`,children:a(c.balance)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(l(c.balance),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Actualizado al ",new Date(t.to).toLocaleDateString()]})]})]}),!m&&y.length>0?e.jsxs("section",{className:"balance-monthly",children:[e.jsxs("header",{className:"balance-monthly__header",children:[e.jsx("h2",{children:"Movimientos mensuales"}),e.jsx("p",{children:"Revisa cómo se comporta tu flujo de efectivo cada mes y cuánto saldo arrastras al siguiente."}),x.length>0?e.jsx("div",{className:"balance-monthly__selector",children:x.map(s=>e.jsxs("button",{type:"button",className:`balance-monthly__chip${s.month===v?" is-active":""}`,onClick:()=>$(s.month),children:[e.jsx("span",{className:"balance-monthly__chip-label",children:s.label}),e.jsxs("span",{className:"balance-monthly__chip-count",children:[s.netUsd>=0?"+":"",a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]},s.month))}):null]}),e.jsx("div",{className:"balance-monthly__grid",children:B.map(s=>e.jsxs("article",{className:"balance-monthly__card",children:[e.jsx("h3",{children:s.label}),e.jsxs("dl",{className:"balance-monthly__details",children:[e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo inicial"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryInUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryInNio)," (≈ ",a(s.carryInUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Ingresos"}),e.jsxs("dd",{className:"balance-monthly__number is-positive",children:[a(s.incomesNio)," (≈ ",a(s.incomesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Gastos"}),e.jsxs("dd",{className:"balance-monthly__number is-negative",children:[a(s.expensesNio)," (≈ ",a(s.expensesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Resultado del mes"}),e.jsxs("dd",{className:`balance-monthly__number ${s.netUsd>=0?"is-positive":"is-negative"}`,children:[a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo arrastrado"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryOutUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryOutNio)," (≈ ",a(s.carryOutUsd,"USD"),")"]})]})]})]},s.month))})]}):null,!m&&C&&y.length===0?e.jsx("p",{className:"balance-monthly__empty",children:"Registra ingresos y gastos para ver cómo se comporta tu balance mensual."}):null]})}export{Y as default};
