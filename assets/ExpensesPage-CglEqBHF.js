import{r as n,a as y,j as e}from"./index-DB_UKz0h.js";import{u as Ne}from"./index.esm-B3JwpmJa.js";import{C as W}from"./ConfirmDialog-C3TphCV6.js";const Y=r=>Number(r??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Ce=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),Z=r=>{if(!r)return"";const c=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(r);if(!c)return new Date(r).toLocaleDateString("es-NI");const[,h,x,o]=c;return new Date(Number(h),Number(x)-1,Number(o)).toLocaleDateString("es-NI")},Se=r=>{if(!r)return"";const[c,h]=r.split("-"),x=new Date(Number(c),Number(h)-1,1),o=Ce.format(x);return o.charAt(0).toUpperCase()+o.slice(1)},w=36.7,ee=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],De=ee.reduce((r,c)=>(r[c.value]=c.label,r),{});function $e(){const[r,c]=n.useState([]),[h,x]=n.useState([]),[o,L]=n.useState({from:"",to:"",category_id:""}),[se,V]=n.useState(!0),[q,d]=n.useState(null),[E,z]=n.useState("list"),[I,B]=n.useState(!1),[F,v]=n.useState(null),[m,ae]=n.useState([]),[p,O]=n.useState(null),[te,T]=n.useState(!1),[$,H]=n.useState(!1),[f,M]=n.useState(null),[A,k]=n.useState(""),[_,K]=n.useState(!1),[b,R]=n.useState(null),[ne,U]=n.useState(!1),[j,X]=n.useState(!1),J=n.useRef(!1),re=n.useCallback(async()=>{try{const s=await y("/categories?type=expense");x(s??[])}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudieron cargar las categor√≠as";d(a)}},[]),{register:N,handleSubmit:le,reset:oe,formState:{isSubmitting:P}}=Ne({defaultValues:{amount:"",currency:"NIO",source:"bank",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),C=n.useCallback(async(s={})=>{V(!0);try{const a=new URLSearchParams;s.from&&a.set("from",s.from),s.to&&a.set("to",s.to),s.category_id&&a.set("category_id",s.category_id);const t=a.toString(),[i,l]=await Promise.all([y(`/expenses${t?`?${t}`:""}`),y("/categories?type=expense")]);c(i??[]),x(l??[]),d(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudieron cargar los gastos";d(t)}finally{V(!1)}},[]);n.useEffect(()=>{J.current||(J.current=!0,C(o))},[o,C]);const ie=async s=>{try{await y("/expenses",{method:"POST",body:{amount:Number(s.amount),currency:s.currency,source:s.source,date:s.date,category_id:s.category_id||null,note:s.note||null}}),oe({amount:"",currency:s.currency,source:s.source,date:s.date,category_id:s.category_id,note:""}),await C(o),z("list")}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo registrar el gasto";d(t)}},ce=n.useCallback(s=>{O(s),T(!0)},[]),de=n.useCallback(()=>{$||(T(!1),O(null))},[$]),me=n.useCallback(async()=>{if(p){H(!0);try{await y(`/expenses/${p.id}`,{method:"DELETE"}),c(s=>s.filter(a=>a.id!==p.id)),T(!1),O(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar el gasto";d(a)}finally{H(!1)}}},[p]),ue=n.useCallback(s=>{M(s.id),k(s.name??"")},[]),xe=n.useCallback(()=>{_||(M(null),k(""))},[_]),he=n.useCallback(async()=>{if(!f)return;const s=A.trim();if(s.length<2){d("El nombre debe tener al menos 2 caracteres.");return}K(!0);try{await y(`/categories/${f}`,{method:"PUT",body:{name:s,type:"expense"}}),x(a=>a.map(t=>t.id===f?{...t,name:s}:t)),c(a=>a.map(t=>t.category_id===f?{...t,category_name:s}:t)),M(null),k(""),d(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";d(t)}finally{K(!1)}},[A,f]),pe=n.useCallback(s=>{R(s),U(!0)},[]),ge=n.useCallback(()=>{j||(U(!1),R(null))},[j]),ye=n.useCallback(async()=>{if(b){X(!0);try{await y(`/categories/${b.id}`,{method:"DELETE"}),x(s=>s.filter(a=>a.id!==b.id)),c(s=>s.map(a=>a.category_id===b.id?{...a,category_id:null,category_name:null}:a)),U(!1),R(null),d(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar la categor√≠a";d(a)}finally{X(!1)}}},[b]),S=n.useMemo(()=>r.reduce((s,a)=>{const t=Number(a.amount??0),i=a.currency==="NIO",l=i?t/w:t,u=i?t:t*w;s.usd+=l,s.nio+=u;const g=a.source==="bank"?"bank":"cash";return s[g].usd+=l,s[g].nio+=u,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[r]),Q=n.useMemo(()=>{if(!r.length)return[];const s=new Map;for(const a of r){if(!a?.date)continue;const t=a.date.slice(0,7);s.has(t)||s.set(t,{usd:0,nio:0,count:0});const i=s.get(t),l=Number(a.amount??0),u=a.currency==="NIO",g=u?l/w:l,je=u?l:l*w;i.usd+=g,i.nio+=je,i.count+=1}return Array.from(s.entries()).map(([a,t])=>({month:a,label:Se(a),usd:t.usd,nio:t.nio,count:t.count})).sort((a,t)=>a.month<t.month?1:-1)},[r]);n.useEffect(()=>{!o.from&&!o.to&&!o.category_id&&ae(Q)},[Q,o]),n.useEffect(()=>{if(!m.length){v(null);return}v(s=>s&&m.some(a=>a.month===s)?s:m[0].month)},[m]);const D=n.useMemo(()=>F?m.find(s=>s.month===F)??null:null,[m,F]),_e=n.useMemo(()=>m.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[m]),G=n.useCallback(s=>{const{name:a,value:t}=s.target;L(i=>({...i,[a]:t})),(a==="from"||a==="to")&&v(null)},[]),be=s=>{const[a,t]=s.split("-"),i=new Date(Number(a),Number(t)-1,1),l=new Date(Number(a),Number(t),0),u=i.toISOString().slice(0,10),g=l.toISOString().slice(0,10);return{from:u,to:g}},fe=n.useCallback(s=>{const a=be(s),t={from:a.from,to:a.to,category_id:o.category_id};v(s),L(t),C(t)},[o.category_id,C]);return e.jsxs("section",{className:"expenses",children:[e.jsxs("header",{className:"expenses__header",children:[e.jsxs("div",{className:"expenses__heading",children:[e.jsx("h1",{children:"Gastos"}),e.jsx("p",{children:"Controla tus egresos diarios y clasif√≠calos f√°cilmente."}),e.jsx("nav",{className:"expenses__tabs expenses__actions",children:[{id:"list",label:"Lista de gastos",icon:"üìã"},{id:"add",label:"Agregar gasto",icon:"‚ûñ"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>z(s.id),className:`expenses__tab ${E===s.id?"expenses__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"expenses__summary",children:[e.jsx("span",{className:"expenses__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"expenses__summary-value expenses__summary-value--nio",children:["C$",S.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"expenses__summary-value",children:["$",S.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Cuenta bancaria: C$",S.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",S.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Efectivo: C$",S.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",S.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),q?e.jsx("p",{className:"expenses__error",children:q}):null,E==="list"?e.jsxs("article",{className:"expenses-card",children:[e.jsx("header",{className:"expenses-card__header",children:e.jsxs("div",{className:"expenses-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üí≥"}),"Lista de gastos"]}),e.jsx("p",{children:"Visualiza tus egresos y verifica el estado de tus categor√≠as."})]})}),e.jsxs("section",{className:`expenses-monthly${m.length>0?" expenses-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"expenses-monthly__info",children:[m.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Controla cu√°nto gastas cada mes y cu√°ntos movimientos registraste."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),v(null),C({...o})},className:"expenses-filters",children:[e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:o.from,onChange:G,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:o.to,onChange:G,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:o.category_id,onChange:G,className:"expenses-input",children:[e.jsx("option",{value:"",children:"Todas"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"expenses-button",children:"Aplicar filtros"})]})]}),m.length>0?e.jsxs("div",{className:"expenses-monthly__aside",children:[e.jsxs("label",{className:"expenses-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"expenses-monthly__select",value:F??"",onChange:s=>{const{value:a}=s.target;a&&fe(a)},children:_e.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),D?e.jsxs("article",{className:"expenses-monthly__card expenses-monthly__card--focus",children:[e.jsxs("div",{className:"expenses-monthly__card-header",children:[e.jsx("h4",{children:D.label}),e.jsxs("span",{className:"expenses-monthly__hint",children:[D.count," ",D.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"expenses-monthly__value expenses-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",Y(D.nio)]})]}),e.jsxs("p",{className:"expenses-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",Y(D.usd)]})]})]}):e.jsx("p",{className:"expenses-card__placeholder expenses-monthly__placeholder",children:"Selecciona un mes para ver el detalle."})]}):null]}),se?e.jsx("p",{className:"expenses-card__placeholder",children:"Cargando gastos..."}):r.length===0?e.jsx("p",{className:"expenses-card__placeholder",children:"No hay gastos registrados con los filtros actuales."}):e.jsx("div",{className:"expenses-table__wrapper",children:e.jsxs("table",{className:"expenses-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"expenses-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:r.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:Z(s.date)}),e.jsxs("td",{className:"expenses-table__amount",children:[s.currency==="NIO"?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:De[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"expenses-table__note",children:s.note??"-"}),e.jsx("td",{className:"expenses-table__actions",children:e.jsx("button",{onClick:()=>ce(s),className:"expenses-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,E==="add"?e.jsxs("form",{onSubmit:le(ie),className:"expenses-card expenses-form",children:[e.jsxs("div",{className:"expenses-form__intro",children:[e.jsx("h2",{children:"Registrar gasto"}),e.jsx("p",{children:"Incluye gastos operativos, pagos recurrentes y compras puntuales."})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...N("amount"),className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...N("currency"),className:"expenses-select",children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Origen del gasto"}),e.jsx("select",{...N("source"),className:"expenses-select",children:ee.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...N("date"),className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...N("category_id"),className:"expenses-select",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"expenses-field expenses-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Describe el gasto",...N("note"),className:"expenses-textarea"})]}),e.jsx("button",{type:"submit",disabled:P,className:`expenses-button expenses-button--primary ${P?"is-disabled":""}`,children:P?"Guardando...":"Guardar gasto"})]}):null,E==="category"?e.jsxs("section",{className:"expenses-card expenses-category",children:[e.jsxs("div",{className:"expenses-category__intro",children:[e.jsx("h2",{children:"Nueva categor√≠a de gasto"}),e.jsx("p",{children:"Clasifica tus egresos para obtener reportes m√°s claros."})]}),e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const a=s.currentTarget,i=`${new FormData(a).get("name")??""}`.trim();if(i)try{B(!0);const l=await y("/categories",{method:"POST",body:{name:i,type:"expense"}});a.reset(),l?x(u=>[l,...u.filter(g=>g.id!==l.id)]):await re(),d(null)}catch(l){console.error(l);const u=l.payload?.message??l.message??"No se pudo crear la categor√≠a";d(u)}finally{B(!1)}},className:"expenses-category__form",children:[e.jsxs("label",{className:"expenses-field expenses-category__field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Servicios, suministros, renta...",required:!0,className:"expenses-input"})]}),e.jsx("button",{type:"submit",disabled:I,className:`expenses-button expenses-button--primary ${I?"is-disabled":""}`,children:I?"Creando...":"Crear categor√≠a"})]}),e.jsxs("div",{className:"expenses-category__list",children:[e.jsxs("div",{className:"expenses-category__list-header",children:[e.jsx("h3",{children:"Mis categor√≠as"}),e.jsx("p",{children:"Administra la lista que usas al registrar tus gastos."})]}),h.length===0?e.jsx("p",{className:"expenses-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):e.jsx("ul",{className:"expenses-category__items",children:h.map(s=>e.jsx("li",{className:"expenses-category__item",children:f===s.id?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:A,onChange:a=>k(a.target.value),className:"expenses-input expenses-category__input",autoFocus:!0}),e.jsxs("div",{className:"expenses-category__actions",children:[e.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--primary",onClick:he,disabled:_,children:_?"Guardando‚Ä¶":"Guardar"}),e.jsx("button",{type:"button",className:"expenses-category__button",onClick:xe,disabled:_,children:"Cancelar"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"expenses-category__name",children:s.name}),e.jsxs("div",{className:"expenses-category__actions",children:[e.jsx("button",{type:"button",className:"expenses-category__button",onClick:()=>ue(s),disabled:_||j,children:"Editar"}),e.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--danger",onClick:()=>pe(s),disabled:_||j,children:"Eliminar"})]})]})},s.id))})]})]}):null,e.jsx(W,{open:te,title:"Eliminar gasto",message:p?`Eliminar√°s el gasto del ${Z(p.date)} por ${p.currency==="NIO"?"C$":"$"}${Number(p.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:$?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:$,onConfirm:me,onCancel:de}),e.jsx(W,{open:ne,title:"Eliminar categor√≠a",message:b?`¬øDeseas eliminar la categor√≠a ‚Äú${b.name}‚Äù? Los gastos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:j?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:j,onConfirm:ye,onCancel:ge})]})}export{$e as default};
