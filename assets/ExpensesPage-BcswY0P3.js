import{r as n,a as y,j as e}from"./index-CYuisF0z.js";import{u as $e,F as we}from"./index.esm-JPGs0xX-.js";import{A as Le,C as ne}from"./AccountSelector-LYvBSER5.js";import{f as Ie}from"./accounts-62zbDqcc.js";const te=r=>Number(r??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Oe=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),re=r=>{if(!r)return"";const i=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(r);if(!i)return new Date(r).toLocaleDateString("es-NI");const[,p,x,l]=i;return new Date(Number(p),Number(x)-1,Number(l)).toLocaleDateString("es-NI")},Ae=r=>{if(!r)return"";const[i,p]=r.split("-"),x=new Date(Number(i),Number(p)-1,1),l=Oe.format(x);return l.charAt(0).toUpperCase()+l.slice(1)},I=36.7,z=r=>`${r??""}`.toUpperCase()==="NIO",Te=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],Me=Te.reduce((r,i)=>(r[i.value]=i.label,r),{});function Ge(){const[r,i]=n.useState([]),[p,x]=n.useState([]),[l,O]=n.useState({from:"",to:"",category_id:""}),[oe,B]=n.useState(!0),[H,d]=n.useState(null),[E,K]=n.useState("list"),[A,X]=n.useState(!1),[F,D]=n.useState(null),[u,le]=n.useState([]),[h,T]=n.useState(null),[ce,M]=n.useState(!1),[k,J]=n.useState(!1),[_,U]=n.useState(null),[R,$]=n.useState(""),[b,Q]=n.useState(!1),[f,P]=n.useState(null),[ie,V]=n.useState(!1),[j,W]=n.useState(!1),[w,L]=n.useState(null),Y=n.useRef(!1),de=n.useCallback(async()=>{try{const s=await y("/categories?type=expense");x(s??[])}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudieron cargar las categor√≠as";d(a)}},[]),Z=$e({defaultValues:{amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),{register:v,handleSubmit:ue,reset:me,watch:xe,setValue:ee,formState:{isSubmitting:G}}=Z,N=n.useCallback(async(s={})=>{B(!0);try{const a=new URLSearchParams;s.from&&a.set("from",s.from),s.to&&a.set("to",s.to),s.category_id&&a.set("category_id",s.category_id);const t=a.toString(),[c,o]=await Promise.all([y(`/expenses${t?`?${t}`:""}`),y("/categories?type=expense")]);i(c??[]),x(o??[]),d(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudieron cargar los gastos";d(t)}finally{B(!1)}},[]);n.useEffect(()=>{Y.current||(Y.current=!0,N(l))},[l,N]);const se=xe("source"),pe=n.useCallback(({source:s,account:a})=>{s==="bank"&&a?(L(a),ee("currency",a.currency,{shouldValidate:!0,shouldDirty:!0})):L(null)},[ee]);n.useEffect(()=>{se!=="bank"&&L(null)},[se]);const he=w?.currency??null,ge=async s=>{try{const a=s.source==="bank"&&s.account_id||null,c=(s.source==="bank"&&w&&w.id===a?w:null)?.currency??s.currency;await y("/expenses",{method:"POST",body:{amount:Number(s.amount),currency:c,source:s.source,account_id:a,date:s.date,category_id:s.category_id||null,note:s.note||null}}),me({amount:"",currency:"NIO",source:"",account_id:"",date:new Date().toISOString().slice(0,10),category_id:"",note:""}),L(null),await N(l),K("list")}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo registrar el gasto";d(t)}},ye=n.useCallback(s=>{T(s),M(!0)},[]),be=n.useCallback(()=>{k||(M(!1),T(null))},[k]),fe=n.useCallback(async()=>{if(h){J(!0);try{await y(`/expenses/${h.id}`,{method:"DELETE"}),i(s=>s.filter(a=>a.id!==h.id)),M(!1),T(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar el gasto";d(a)}finally{J(!1)}}},[h]),_e=n.useCallback(s=>{U(s.id),$(s.name??"")},[]),je=n.useCallback(()=>{b||(U(null),$(""))},[b]),Ne=n.useCallback(async()=>{if(!_)return;const s=R.trim();if(s.length<2){d("El nombre debe tener al menos 2 caracteres.");return}Q(!0);try{await y(`/categories/${_}`,{method:"PUT",body:{name:s,type:"expense"}}),x(a=>a.map(t=>t.id===_?{...t,name:s}:t)),i(a=>a.map(t=>t.category_id===_?{...t,category_name:s}:t)),U(null),$(""),d(null)}catch(a){console.error(a);const t=a.payload?.message??a.message??"No se pudo actualizar la categor√≠a";d(t)}finally{Q(!1)}},[R,_]),Ce=n.useCallback(s=>{P(s),V(!0)},[]),Se=n.useCallback(()=>{j||(V(!1),P(null))},[j]),De=n.useCallback(async()=>{if(f){W(!0);try{await y(`/categories/${f.id}`,{method:"DELETE"}),x(s=>s.filter(a=>a.id!==f.id)),i(s=>s.map(a=>a.category_id===f.id?{...a,category_id:null,category_name:null}:a)),V(!1),P(null),d(null)}catch(s){console.error(s);const a=s.payload?.message??s.message??"No se pudo eliminar la categor√≠a";d(a)}finally{W(!1)}}},[f]),C=n.useMemo(()=>r.reduce((s,a)=>{const t=Number(a.amount??0),c=z(a.currency),o=c?t/I:t,m=c?t:t*I;s.usd+=o,s.nio+=m;const g=a.source==="bank"?"bank":"cash";return s[g].usd+=o,s[g].nio+=m,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[r]),ae=n.useMemo(()=>{if(!r.length)return[];const s=new Map;for(const a of r){if(!a?.date)continue;const t=a.date.slice(0,7);s.has(t)||s.set(t,{usd:0,nio:0,count:0});const c=s.get(t),o=Number(a.amount??0),m=z(a.currency),g=m?o/I:o,ke=m?o:o*I;c.usd+=g,c.nio+=ke,c.count+=1}return Array.from(s.entries()).map(([a,t])=>({month:a,label:Ae(a),usd:t.usd,nio:t.nio,count:t.count})).sort((a,t)=>a.month<t.month?1:-1)},[r]);n.useEffect(()=>{!l.from&&!l.to&&!l.category_id&&le(ae)},[ae,l]),n.useEffect(()=>{if(!u.length){D(null);return}D(s=>s&&u.some(a=>a.month===s)?s:u[0].month)},[u]);const S=n.useMemo(()=>F?u.find(s=>s.month===F)??null:null,[u,F]),ve=n.useMemo(()=>u.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[u]),q=n.useCallback(s=>{const{name:a,value:t}=s.target;O(c=>({...c,[a]:t})),(a==="from"||a==="to")&&D(null)},[]),Ee=s=>{const[a,t]=s.split("-"),c=new Date(Number(a),Number(t)-1,1),o=new Date(Number(a),Number(t),0),m=c.toISOString().slice(0,10),g=o.toISOString().slice(0,10);return{from:m,to:g}},Fe=n.useCallback(s=>{const a=Ee(s),t={from:a.from,to:a.to,category_id:l.category_id};D(s),O(t),N(t)},[l.category_id,N]);return e.jsxs("section",{className:"expenses",children:[e.jsxs("header",{className:"expenses__header",children:[e.jsxs("div",{className:"expenses__heading",children:[e.jsx("h1",{children:"Gastos"}),e.jsx("p",{children:"Controla tus egresos diarios y clasif√≠calos f√°cilmente."}),e.jsx("nav",{className:"expenses__tabs expenses__actions",children:[{id:"list",label:"Lista de gastos",icon:"üìã"},{id:"add",label:"Agregar gasto",icon:"‚ûñ"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>K(s.id),className:`expenses__tab ${E===s.id?"expenses__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"expenses__summary",children:[e.jsx("span",{className:"expenses__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"expenses__summary-value expenses__summary-value--nio",children:["C$",C.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"expenses__summary-value",children:["$",C.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Cuenta bancaria: C$",C.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",C.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"expenses__summary-detail",children:["Efectivo: C$",C.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",C.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),H?e.jsx("p",{className:"expenses__error",children:H}):null,E==="list"?e.jsxs("article",{className:"expenses-card",children:[e.jsx("header",{className:"expenses-card__header",children:e.jsxs("div",{className:"expenses-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üí≥"}),"Lista de gastos"]}),e.jsx("p",{children:"Visualiza tus egresos y verifica el estado de tus categor√≠as."})]})}),e.jsxs("section",{className:`expenses-monthly${u.length>0?" expenses-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"expenses-monthly__info",children:[u.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Controla cu√°nto gastas cada mes y cu√°ntos movimientos registraste."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),D(null),N({...l})},className:"expenses-filters",children:[e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:l.from,onChange:q,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:l.to,onChange:q,className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:l.category_id,onChange:q,className:"expenses-input",children:[e.jsx("option",{value:"",children:"Todas"}),p.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"expenses-button",children:"Aplicar filtros"})]})]}),u.length>0?e.jsxs("div",{className:"expenses-monthly__aside",children:[e.jsxs("label",{className:"expenses-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"expenses-monthly__select",value:F??"",onChange:s=>{const{value:a}=s.target;a&&Fe(a)},children:ve.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),S?e.jsxs("article",{className:"expenses-monthly__card expenses-monthly__card--focus",children:[e.jsxs("div",{className:"expenses-monthly__card-header",children:[e.jsx("h4",{children:S.label}),e.jsxs("span",{className:"expenses-monthly__hint",children:[S.count," ",S.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"expenses-monthly__value expenses-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",te(S.nio)]})]}),e.jsxs("p",{className:"expenses-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",te(S.usd)]})]})]}):e.jsx("p",{className:"expenses-card__placeholder expenses-monthly__placeholder",children:"Selecciona un mes para ver el detalle."})]}):null]}),oe?e.jsx("p",{className:"expenses-card__placeholder",children:"Cargando gastos..."}):r.length===0?e.jsx("p",{className:"expenses-card__placeholder",children:"No hay gastos registrados con los filtros actuales."}):e.jsx("div",{className:"expenses-table__wrapper",children:e.jsxs("table",{className:"expenses-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"expenses-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:r.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:re(s.date)}),e.jsxs("td",{className:"expenses-table__amount",children:[z(s.currency)?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:s.source==="bank"?Ie(s.account)||"Cuenta bancaria":Me[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"expenses-table__note",children:s.note??"-"}),e.jsx("td",{className:"expenses-table__actions",children:e.jsx("button",{onClick:()=>ye(s),className:"expenses-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,E==="add"?e.jsx(we,{...Z,children:e.jsxs("form",{onSubmit:ue(ge),className:"expenses-card expenses-form",children:[e.jsxs("div",{className:"expenses-form__intro",children:[e.jsx("h2",{children:"Registrar gasto"}),e.jsx("p",{children:"Incluye gastos operativos, pagos recurrentes y compras puntuales."})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...v("amount"),className:"expenses-input"})]}),e.jsx(Le,{sourceField:"source",accountField:"account_id",label:"Origen del gasto",accountLabel:"Cuenta bancaria",fieldClass:"expenses-field",accountFieldClass:"expenses-field",sourceSelectClass:"expenses-select",accountSelectClass:"expenses-select",containerClass:"expenses-account-selector",onAccountChange:pe}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...v("currency"),className:"expenses-select",disabled:!!he,children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...v("date"),className:"expenses-input"})]}),e.jsxs("label",{className:"expenses-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...v("category_id"),className:"expenses-select",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),p.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"expenses-field expenses-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Describe el gasto",...v("note"),className:"expenses-textarea"})]}),e.jsx("button",{type:"submit",disabled:G,className:`expenses-button expenses-button--primary ${G?"is-disabled":""}`,children:G?"Guardando...":"Guardar gasto"})]})}):null,E==="category"?e.jsxs("section",{className:"expenses-card expenses-category",children:[e.jsxs("div",{className:"expenses-category__intro",children:[e.jsx("h2",{children:"Nueva categor√≠a de gasto"}),e.jsx("p",{children:"Clasifica tus egresos para obtener reportes m√°s claros."})]}),e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const a=s.currentTarget,c=`${new FormData(a).get("name")??""}`.trim();if(c)try{X(!0);const o=await y("/categories",{method:"POST",body:{name:c,type:"expense"}});a.reset(),o?x(m=>[o,...m.filter(g=>g.id!==o.id)]):await de(),d(null)}catch(o){console.error(o);const m=o.payload?.message??o.message??"No se pudo crear la categor√≠a";d(m)}finally{X(!1)}},className:"expenses-category__form",children:[e.jsxs("label",{className:"expenses-field expenses-category__field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Servicios, suministros, renta...",required:!0,className:"expenses-input"})]}),e.jsx("button",{type:"submit",disabled:A,className:`expenses-button expenses-button--primary ${A?"is-disabled":""}`,children:A?"Creando...":"Crear categor√≠a"})]}),e.jsxs("div",{className:"expenses-category__list",children:[e.jsxs("div",{className:"expenses-category__list-header",children:[e.jsx("h3",{children:"Mis categor√≠as"}),e.jsx("p",{children:"Administra la lista que usas al registrar tus gastos."})]}),p.length===0?e.jsx("p",{className:"expenses-category__empty",children:"A√∫n no tienes categor√≠as registradas. Crea una para comenzar."}):e.jsx("ul",{className:"expenses-category__items",children:p.map(s=>e.jsx("li",{className:"expenses-category__item",children:_===s.id?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:R,onChange:a=>$(a.target.value),className:"expenses-input expenses-category__input",autoFocus:!0}),e.jsxs("div",{className:"expenses-category__actions",children:[e.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--primary",onClick:Ne,disabled:b,children:b?"Guardando‚Ä¶":"Guardar"}),e.jsx("button",{type:"button",className:"expenses-category__button",onClick:je,disabled:b,children:"Cancelar"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"expenses-category__name",children:s.name}),e.jsxs("div",{className:"expenses-category__actions",children:[e.jsx("button",{type:"button",className:"expenses-category__button",onClick:()=>_e(s),disabled:b||j,children:"Editar"}),e.jsx("button",{type:"button",className:"expenses-category__button expenses-category__button--danger",onClick:()=>Ce(s),disabled:b||j,children:"Eliminar"})]})]})},s.id))})]})]}):null,e.jsx(ne,{open:ce,title:"Eliminar gasto",message:h?`Eliminar√°s el gasto del ${re(h.date)} por ${h.currency==="NIO"?"C$":"$"}${Number(h.amount??0).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})}. Esta acci√≥n no se puede deshacer.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:k?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:k,onConfirm:fe,onCancel:be}),e.jsx(ne,{open:ie,title:"Eliminar categor√≠a",message:f?`¬øDeseas eliminar la categor√≠a ‚Äú${f.name}‚Äù? Los gastos asociados conservar√°n el movimiento pero quedar√°n sin categor√≠a.`:"Esta acci√≥n no se puede deshacer.",confirmLabel:j?"Eliminando‚Ä¶":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:j,onConfirm:De,onCancel:Se})]})}export{Ge as default};
