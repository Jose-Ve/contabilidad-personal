import{r as o,s as L,j as e}from"./index-CUw-GnBp.js";const T=36.7,a=(c,_="NIO")=>new Intl.NumberFormat("es-NI",{style:"currency",currency:_,maximumFractionDigits:2}).format(Number(c??0)),t=c=>Number(c??0)/T||0,G=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),C=new Date,z=new Date(C.getFullYear(),0,1).toISOString().slice(0,10),H=C.toISOString().slice(0,10),k=c=>{if(!c)return"";const[_,m]=c.split("-"),g=new Date(Number(_),Number(m)-1,1),h=G.format(g);return h.charAt(0).toUpperCase()+h.slice(1)};function Y(){const[c,_]=o.useState({from:z,to:H}),[m,g]=o.useState({incomes:0,expenses:0,balance:0,series:[]}),[h,S]=o.useState(!1),[E,F]=o.useState(!1),[v,j]=o.useState(null),[b,R]=o.useState([]),I=o.useRef(!1),M=o.useCallback(s=>{const{name:n,value:r}=s.target;_(u=>({...u,[n]:r})),(n==="from"||n==="to")&&j(null)},[]),y=o.useCallback(async(s,{preserveMonths:n=!1}={})=>{S(!0);const r=s??c,x=(await L.auth.getSession()).data.session?.access_token;if(!x){S(!1);return}try{const d=new URLSearchParams(r),N=await fetch(`http://localhost:4000/balance?${d.toString()}`,{headers:{Authorization:`Bearer ${x}`}});if(!N.ok)throw new Error("No se pudo calcular el balance");const D=await N.json();if(g(D),!n){const A=Array.isArray(D?.series?.byMonth)?D.series.byMonth.map(p=>{const f=Number(p.incomes??0),w=Number(p.expenses??0),O=f-w;return{month:p.month,label:k(p.month),incomesNio:f,incomesUsd:t(f),expensesNio:w,expensesUsd:t(w),netNio:O,netUsd:t(O)}}):[];R(A.sort((p,f)=>p.month<f.month?1:-1))}}catch(d){console.error(d)}finally{S(!1),F(!0)}},[c]);o.useEffect(()=>{I.current||(I.current=!0,y(c))},[c,y]),o.useEffect(()=>{if(!b.length){j(null);return}j(s=>s&&b.some(n=>n.month===s)?s:b[0].month)},[b]);const i=o.useMemo(()=>v?b.find(s=>s.month===v)??null:null,[b,v]),$=s=>{const[n,r]=s.split("-"),u=new Date(Number(n),Number(r)-1,1),x=new Date(Number(n),Number(r),0),d=u.toISOString().slice(0,10),N=x.toISOString().slice(0,10);return{from:d,to:N}},B=o.useCallback(s=>{const n=$(s),r={...c,from:n.from,to:n.to};j(s),_(r),y(r,{preserveMonths:!0})},[c,y]),l=o.useMemo(()=>{const s=n=>n&&typeof n=="object"?{total:Number(n.total??0),bank:Number(n.bank??0),cash:Number(n.cash??0)}:{total:Number(n??0),bank:0,cash:0};return{incomes:s(m.incomes),expenses:s(m.expenses),balance:Number(m.balance??0)}},[m]),U=o.useMemo(()=>{const s=m?.series?.byMonth??[];let n=0;return s.map(r=>{const u=Number(r.incomes??0),x=Number(r.expenses??0),d=u-x,N=n;return n+=d,{month:r.month,label:k(r.month),incomesNio:u,incomesUsd:t(u),expensesNio:x,expensesUsd:t(x),netNio:d,netUsd:t(d),carryInNio:N,carryInUsd:t(N),carryOutNio:n,carryOutUsd:t(n)}})},[m?.series]);return e.jsxs("section",{className:"balance",children:[e.jsxs("header",{className:"balance__header",children:[e.jsxs("div",{className:"balance__intro",children:[e.jsx("h1",{children:"Balance"}),e.jsx("p",{children:"Filtra por rango de fechas para comparar tus ingresos y gastos."})]}),e.jsxs("div",{className:"balance__overview",children:[e.jsx("span",{className:"balance__overview-label",children:"Balance general"}),e.jsx("strong",{className:`balance__overview-value ${l.balance>=0?"is-positive":"is-negative"}`,children:a(l.balance)}),e.jsxs("span",{className:"balance__overview-detail",children:["Ingresos: ",a(l.incomes.total)," (≈ ",a(t(l.incomes.total),"USD"),")"]}),e.jsxs("span",{className:"balance__overview-detail",children:["Gastos: ",a(l.expenses.total)," (≈ ",a(t(l.expenses.total),"USD"),")"]})]})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),j(null),y(c)},className:"balance-filters",children:[e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{type:"date",name:"from",value:c.from,onChange:M,className:"balance-input"})]}),e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{type:"date",name:"to",value:c.to,onChange:M,className:"balance-input"})]}),e.jsx("button",{type:"submit",className:"balance-button",disabled:h,children:h?"Calculando...":"Aplicar filtros"})]}),h?e.jsx("p",{className:"balance__loading",children:"Calculando balance..."}):e.jsxs("div",{className:"balance-grid",children:[e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Ingresos"}),e.jsx("p",{className:"balance-card__value is-positive",children:a(l.incomes.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(t(l.incomes.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(l.incomes.bank)," (≈ ",a(t(l.incomes.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(l.incomes.cash)," (≈ ",a(t(l.incomes.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Gastos"}),e.jsx("p",{className:"balance-card__value is-negative",children:a(l.expenses.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(t(l.expenses.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(l.expenses.bank)," (≈ ",a(t(l.expenses.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(l.expenses.cash)," (≈ ",a(t(l.expenses.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Resultado"}),e.jsx("p",{className:`balance-card__value ${l.balance>=0?"is-positive":"is-negative"}`,children:a(l.balance)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(t(l.balance),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Actualizado al ",new Date(c.to).toLocaleDateString()]})]})]}),!h&&U.length>0?e.jsxs("section",{className:"balance-monthly",children:[e.jsxs("header",{className:"balance-monthly__header",children:[e.jsx("h2",{children:"Movimientos mensuales"}),e.jsx("p",{children:"Revisa cómo se comporta tu flujo de efectivo cada mes y cuánto saldo arrastras al siguiente."}),b.length>0?e.jsx("div",{className:"balance-monthly__selector",children:b.map(s=>e.jsxs("button",{type:"button",className:`balance-monthly__chip${s.month===v?" is-active":""}`,onClick:()=>B(s.month),children:[e.jsx("span",{className:"balance-monthly__chip-label",children:s.label}),e.jsxs("span",{className:"balance-monthly__chip-count",children:[s.netUsd>=0?"+":"",a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]},s.month))}):null]}),i?e.jsxs("article",{className:"balance-monthly__card balance-monthly__card--focus",children:[e.jsxs("div",{className:"balance-monthly__card-header",children:[e.jsx("h3",{children:i.label}),e.jsxs("span",{className:"balance-monthly__chip-count",children:["Ingresos: ",a(i.incomesNio)," (≈ ",a(i.incomesUsd,"USD"),") · Gastos: ",a(i.expensesNio)," (≈ ",a(i.expensesUsd,"USD"),")"]})]}),e.jsxs("p",{className:`balance-monthly__number ${i.netUsd>=0?"is-positive":"is-negative"}`,children:["Resultado: ",a(i.netNio)," (≈ ",a(i.netUsd,"USD"),")"]})]}):null,e.jsx("div",{className:"balance-monthly__grid",children:U.map(s=>e.jsxs("article",{className:"balance-monthly__card",children:[e.jsx("h3",{children:s.label}),e.jsxs("dl",{className:"balance-monthly__details",children:[e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo inicial"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryInUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryInNio)," (≈ ",a(s.carryInUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Ingresos"}),e.jsxs("dd",{className:"balance-monthly__number is-positive",children:[a(s.incomesNio)," (≈ ",a(s.incomesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Gastos"}),e.jsxs("dd",{className:"balance-monthly__number is-negative",children:[a(s.expensesNio)," (≈ ",a(s.expensesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Resultado del mes"}),e.jsxs("dd",{className:`balance-monthly__number ${s.netUsd>=0?"is-positive":"is-negative"}`,children:[a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo arrastrado"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryOutUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryOutNio)," (≈ ",a(s.carryOutUsd,"USD"),")"]})]})]})]},s.month))})]}):null,!h&&E&&U.length===0?e.jsx("p",{className:"balance-monthly__empty",children:"Registra ingresos y gastos para ver cómo se comporta tu balance mensual."}):null]})}export{Y as default};
