import{r as t,a as N,j as e}from"./index-BqUALvqG.js";import{u as X}from"./index.esm-B71hXAus.js";const A=o=>Number(o??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),J=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),Q=o=>{if(!o)return"";const[d,b]=o.split("-"),C=new Date(Number(d),Number(b)-1,1),f=J.format(C);return f.charAt(0).toUpperCase()+f.slice(1)},D=36.7,T=[{value:"bank",label:"Cuenta bancaria"},{value:"cash",label:"Efectivo"}],W=T.reduce((o,d)=>(o[d.value]=d.label,o),{});function q(){const[o,d]=t.useState([]),[b,C]=t.useState([]),[f,$]=t.useState(!0),[O,h]=t.useState(null),[c,y]=t.useState({from:"",to:"",category_id:""}),[v,F]=t.useState("list"),[w,I]=t.useState(!1),[S,g]=t.useState(null),[l,R]=t.useState([]),L=t.useRef(!1),{register:x,handleSubmit:U,reset:P,formState:{isSubmitting:k}}=X({defaultValues:{amount:"",currency:"NIO",source:"bank",date:new Date().toISOString().slice(0,10),category_id:"",note:""}}),u=t.useCallback(async(s={})=>{$(!0);try{const n=new URLSearchParams;s.from&&n.set("from",s.from),s.to&&n.set("to",s.to),s.category_id&&n.set("category_id",s.category_id);const[a,i]=await Promise.all([N(`/incomes${n.toString()?`?${n.toString()}`:""}`),N("/categories?type=income")]);d(a??[]),C(i??[]),h(null)}catch(n){console.error(n);const a=n.payload?.message??n.message??"No se pudieron cargar los ingresos";h(a)}finally{$(!1)}},[]);t.useEffect(()=>{L.current||(L.current=!0,u(c))},[c,u]);const V=async s=>{try{await N("/incomes",{method:"POST",body:{amount:Number(s.amount),currency:s.currency,source:s.source,date:s.date,category_id:s.category_id||null,note:s.note??null}}),P({amount:"",currency:s.currency,source:s.source,date:s.date,category_id:s.category_id,note:""}),await u(c),F("list")}catch(n){console.error(n);const a=n.payload?.message??n.message??"No se pudo registrar el ingreso";h(a)}},G=async s=>{if(window.confirm("¬øEliminar este ingreso?"))try{await N(`/incomes/${s}`,{method:"DELETE"}),d(n=>n.filter(a=>a.id!==s))}catch(n){console.error(n);const a=n.payload?.message??n.message??"No se pudo eliminar el ingreso";h(a)}},j=t.useMemo(()=>o.reduce((s,n)=>{const a=Number(n.amount??0),i=n.currency==="NIO",r=i?a/D:a,m=i?a:a*D;s.usd+=r,s.nio+=m;const _=n.source==="bank"?"bank":"cash";return s[_].usd+=r,s[_].nio+=m,s},{usd:0,nio:0,bank:{usd:0,nio:0},cash:{usd:0,nio:0}}),[o]),M=t.useMemo(()=>{if(!o.length)return[];const s=new Map;for(const n of o){if(!n?.date)continue;const a=n.date.slice(0,7);s.has(a)||s.set(a,{usd:0,nio:0,count:0});const i=s.get(a),r=Number(n.amount??0),m=n.currency==="NIO",_=m?r/D:r,K=m?r:r*D;i.usd+=_,i.nio+=K,i.count+=1}return Array.from(s.entries()).map(([n,a])=>({month:n,label:Q(n),usd:a.usd,nio:a.nio,count:a.count})).sort((n,a)=>n.month<a.month?1:-1)},[o]);t.useEffect(()=>{!c.from&&!c.to&&!c.category_id&&R(M)},[M,c]),t.useEffect(()=>{if(!l.length){g(null);return}g(s=>s&&l.some(n=>n.month===s)?s:l[0].month)},[l]);const p=t.useMemo(()=>S?l.find(s=>s.month===S)??null:null,[l,S]),B=t.useMemo(()=>l.map(s=>({value:s.month,label:`${s.label} ¬∑ ${s.count} ${s.count===1?"mov.":"movs."}`})),[l]),E=t.useCallback(s=>{const{name:n,value:a}=s.target;y(i=>({...i,[n]:a})),(n==="from"||n==="to")&&g(null)},[y,g]),H=s=>{const[n,a]=s.split("-"),i=new Date(Number(n),Number(a)-1,1),r=new Date(Number(n),Number(a),0),m=i.toISOString().slice(0,10),_=r.toISOString().slice(0,10);return{from:m,to:_}},z=t.useCallback(s=>{const n=H(s),a={from:n.from,to:n.to,category_id:c.category_id};g(s),y(a),u(a)},[c.category_id,u,y]);return e.jsxs("section",{className:"incomes",children:[e.jsxs("header",{className:"incomes__header",children:[e.jsxs("div",{className:"incomes__heading",children:[e.jsx("h1",{children:"Ingresos"}),e.jsx("p",{children:"Consulta, registra y organiza tus ingresos."}),e.jsx("nav",{className:"incomes__tabs incomes__actions",children:[{id:"list",label:"Lista de ingresos",icon:"üìã"},{id:"add",label:"Agregar ingreso",icon:"‚ûï"},{id:"category",label:"Agregar categor√≠a",icon:"üóÇÔ∏è"}].map(s=>e.jsxs("button",{type:"button",onClick:()=>F(s.id),className:`incomes__tab ${v===s.id?"incomes__tab--active":""}`,children:[e.jsx("span",{"aria-hidden":!0,children:s.icon}),s.label]},s.id))})]}),e.jsxs("div",{className:"incomes__summary",children:[e.jsx("span",{className:"incomes__summary-label",children:"Total estimado"}),e.jsxs("strong",{className:"incomes__summary-value incomes__summary-value--nio",children:["C$",j.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("strong",{className:"incomes__summary-value",children:["$",j.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Cuenta bancaria: C$",j.bank.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",j.bank.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]}),e.jsxs("span",{className:"incomes__summary-detail",children:["Efectivo: C$",j.cash.nio.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ¬∑ $",j.cash.usd.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]}),O?e.jsx("p",{className:"incomes__error",children:O}):null,v==="list"?e.jsxs("article",{className:"incomes-card",children:[e.jsx("header",{className:"incomes-card__header",children:e.jsxs("div",{className:"incomes-card__heading",children:[e.jsxs("h2",{children:[e.jsx("span",{role:"img","aria-hidden":!0,children:"üìë"}),"Lista de ingresos"]}),e.jsx("p",{children:"Filtra por fechas o categor√≠as para encontrar movimientos espec√≠ficos."})]})}),e.jsxs("section",{className:`incomes-monthly${l.length>0?" incomes-monthly--with-summary":""}`,children:[e.jsxs("div",{className:"incomes-monthly__info",children:[l.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Totales por mes"}),e.jsx("p",{children:"Consulta c√≥mo evolucionan tus ingresos y cu√°ntos movimientos registraste cada mes."})]}):null,e.jsxs("form",{onSubmit:s=>{s.preventDefault(),g(null),u({...c})},className:"incomes-filters",children:[e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{name:"from",type:"date",value:c.from,onChange:E,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{name:"to",type:"date",value:c.to,onChange:E,className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{name:"category_id",value:c.category_id,onChange:E,className:"incomes-input",children:[e.jsx("option",{value:"",children:"Todas"}),b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("button",{type:"submit",className:"incomes-button",children:"Aplicar filtros"})]})]}),l.length>0?e.jsxs("div",{className:"incomes-monthly__aside",children:[e.jsxs("label",{className:"incomes-monthly__picker",children:[e.jsx("span",{children:"Mes y a√±o"}),e.jsx("select",{className:"incomes-monthly__select",value:S??"",onChange:s=>{const{value:n}=s.target;n&&z(n)},children:B.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),p?e.jsxs("article",{className:"incomes-monthly__card incomes-monthly__card--focus",children:[e.jsxs("div",{className:"incomes-monthly__card-header",children:[e.jsx("h4",{children:p.label}),e.jsxs("span",{className:"incomes-monthly__hint",children:[p.count," ",p.count===1?"movimiento":"movimientos"]})]}),e.jsxs("p",{className:"incomes-monthly__value incomes-monthly__value--nio",children:[e.jsx("span",{children:"NIO"}),e.jsxs("strong",{children:["C$",A(p.nio)]})]}),e.jsxs("p",{className:"incomes-monthly__value",children:[e.jsx("span",{children:"USD"}),e.jsxs("strong",{children:["$",A(p.usd)]})]})]}):e.jsx("p",{className:"incomes-card__placeholder incomes-monthly__placeholder",children:"Selecciona un mes para ver el resumen."})]}):null]}),f?e.jsx("p",{className:"incomes-card__placeholder",children:"Cargando ingresos..."}):o.length===0?e.jsx("p",{className:"incomes-card__placeholder",children:"No hay ingresos registrados con los filtros actuales."}):e.jsx("div",{className:"incomes-table__wrapper",children:e.jsxs("table",{className:"incomes-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Categor√≠a"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{className:"incomes-table__actions",children:"Acciones"})]})}),e.jsx("tbody",{children:o.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(s.date).toLocaleDateString()}),e.jsxs("td",{className:"incomes-table__amount",children:[s.currency==="NIO"?"C$":"$",Number(s.amount).toLocaleString("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:W[s.source??"cash"]}),e.jsx("td",{children:s.category_name??"Sin categor√≠a"}),e.jsx("td",{className:"incomes-table__note",children:s.note??"-"}),e.jsx("td",{className:"incomes-table__actions",children:e.jsx("button",{onClick:()=>G(s.id),className:"incomes-table__delete",children:"Eliminar"})})]},s.id))})]})})]}):null,v==="add"?e.jsxs("form",{onSubmit:U(V),className:"incomes-card incomes-form",children:[e.jsxs("div",{className:"incomes-form__intro",children:[e.jsx("h2",{children:"Registrar ingreso"}),e.jsx("p",{children:"Completa el formulario para registrar un nuevo movimiento."})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Monto"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"0.00",required:!0,...x("amount"),className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Moneda"}),e.jsxs("select",{...x("currency"),className:"incomes-input",children:[e.jsx("option",{value:"NIO",children:"C√≥rdoba nicarag√ºense (C$)"}),e.jsx("option",{value:"USD",children:"D√≥lar estadounidense ($)"})]})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Origen del ingreso"}),e.jsx("select",{...x("source"),className:"incomes-input",children:T.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Fecha"}),e.jsx("input",{type:"date",required:!0,...x("date"),className:"incomes-input"})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Categor√≠a"}),e.jsxs("select",{...x("category_id"),className:"incomes-input",children:[e.jsx("option",{value:"",children:"Sin categor√≠a"}),b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{className:"incomes-field incomes-field--full",children:[e.jsx("span",{children:"Nota"}),e.jsx("textarea",{rows:3,placeholder:"Detalles opcionales",...x("note"),className:"incomes-textarea"})]}),e.jsx("button",{type:"submit",disabled:k,className:"incomes-button incomes-button--primary",children:k?"Guardando...":"Guardar ingreso"})]}):null,v==="category"?e.jsxs("form",{onSubmit:async s=>{s.preventDefault();const n=s.currentTarget,i=new FormData(n).get("name");if(i)try{I(!0),await N("/categories",{method:"POST",body:{name:i,type:"income"}}),n.reset(),await u(c),F("list"),h(null)}catch(r){console.error(r);const m=r.payload?.message??r.message??"No se pudo crear la categor√≠a";h(m)}finally{I(!1)}},className:"incomes-card incomes-category",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Nueva categor√≠a de ingreso"}),e.jsx("p",{children:"Agrupa tus movimientos con categor√≠as creadas a medida."})]}),e.jsxs("label",{className:"incomes-field",children:[e.jsx("span",{children:"Nombre"}),e.jsx("input",{name:"name",type:"text",placeholder:"Salarios, ventas, freelance...",required:!0,className:"incomes-input"})]}),e.jsx("button",{type:"submit",disabled:w,className:`incomes-button incomes-button--primary ${w?"is-disabled":""}`,children:w?"Creando...":"Crear categor√≠a"})]}):null]})}export{q as default};
