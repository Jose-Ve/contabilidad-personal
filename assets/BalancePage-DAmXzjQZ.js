import{r as t,s as k,m as R,j as e}from"./index-B-LMJLZx.js";const H=36.7,a=(l,N="NIO")=>new Intl.NumberFormat("es-NI",{style:"currency",currency:N,maximumFractionDigits:2}).format(Number(l??0)),r=l=>Number(l??0)/H||0,P=new Intl.DateTimeFormat("es-ES",{month:"long",year:"numeric"}),F=new Date,Y=new Date(F.getFullYear(),0,1).toISOString().slice(0,10),q=F.toISOString().slice(0,10),E=l=>{if(!l)return"";const[N,d]=l.split("-"),S=new Date(Number(N),Number(d)-1,1),m=P.format(S);return m.charAt(0).toUpperCase()+m.slice(1)};function Q(){const[l,N]=t.useState({from:Y,to:q}),[d,S]=t.useState({incomes:0,expenses:0,balance:0,series:[]}),[m,U]=t.useState(!1),[T,$]=t.useState(!1),[g,f]=t.useState(null),[_,A]=t.useState([]),M=t.useRef(!1),b=t.useRef(null),O=t.useCallback(s=>{const{name:n,value:o}=s.target;N(h=>({...h,[n]:o})),(n==="from"||n==="to")&&f(null)},[]),p=t.useCallback(async(s,{preserveMonths:n=!1}={})=>{U(!0);const o=s??l,u=(await k.auth.getSession()).data.session?.access_token;if(!u){U(!1);return}try{const i=new URLSearchParams(o),x=await fetch(`http://contabilidad-personal.onrender.com/balance?${i.toString()}`,{headers:{Authorization:`Bearer ${u}`}});if(!x.ok)throw new Error("No se pudo calcular el balance");const D=await x.json();if(S(D),!n){const G=Array.isArray(D?.series?.byMonth)?D.series.byMonth.map(j=>{const v=Number(j.incomes??0),I=Number(j.expenses??0),C=v-I;return{month:j.month,label:E(j.month),incomesNio:v,incomesUsd:r(v),expensesNio:I,expensesUsd:r(I),netNio:C,netUsd:r(C)}}):[];A(G.sort((j,v)=>j.month<v.month?1:-1))}}catch(i){console.error(i)}finally{U(!1),$(!0)}},[l]),w=t.useCallback(()=>{b.current&&window.clearTimeout(b.current),b.current=window.setTimeout(()=>{b.current=null,p(void 0,{preserveMonths:!1})},300)},[p]);t.useEffect(()=>{M.current||(M.current=!0,p(l))},[l,p]),t.useEffect(()=>{const s=k.channel("balance-updates").on("postgres_changes",{event:"*",schema:"public",table:"incomes"},()=>{R(),w()}).on("postgres_changes",{event:"*",schema:"public",table:"expenses"},()=>{R(),w()}).subscribe();return()=>{b.current&&(window.clearTimeout(b.current),b.current=null),k.removeChannel(s)}},[w]),t.useEffect(()=>{if(!_.length){f(null);return}f(s=>s&&_.some(n=>n.month===s)?s:_[0].month)},[_]);const B=s=>{const[n,o]=s.split("-"),h=new Date(Number(n),Number(o)-1,1),u=new Date(Number(n),Number(o),0),i=h.toISOString().slice(0,10),x=u.toISOString().slice(0,10);return{from:i,to:x}},L=t.useCallback(s=>{const n=B(s),o={...l,from:n.from,to:n.to};f(s),N(o),p(o,{preserveMonths:!0})},[l,p]),c=t.useMemo(()=>{const s=n=>n&&typeof n=="object"?{total:Number(n.total??0),bank:Number(n.bank??0),cash:Number(n.cash??0)}:{total:Number(n??0),bank:0,cash:0};return{incomes:s(d.incomes),expenses:s(d.expenses),balance:Number(d.balance??0)}},[d]),y=t.useMemo(()=>{const s=d?.series?.byMonth??[];let n=0;return s.map(o=>{const h=Number(o.incomes??0),u=Number(o.expenses??0),i=h-u,x=n;return n+=i,{month:o.month,label:E(o.month),incomesNio:h,incomesUsd:r(h),expensesNio:u,expensesUsd:r(u),netNio:i,netUsd:r(i),carryInNio:x,carryInUsd:r(x),carryOutNio:n,carryOutUsd:r(n)}})},[d?.series]),z=t.useMemo(()=>g?y.filter(s=>s.month===g):y,[y,g]);return e.jsxs("section",{className:"balance",children:[e.jsxs("header",{className:"balance__header",children:[e.jsxs("div",{className:"balance__intro",children:[e.jsx("h1",{children:"Balance"}),e.jsx("p",{children:"Filtra por rango de fechas para comparar tus ingresos y gastos."})]}),e.jsxs("div",{className:"balance__overview",children:[e.jsx("span",{className:"balance__overview-label",children:"Balance general"}),e.jsx("strong",{className:`balance__overview-value ${c.balance>=0?"is-positive":"is-negative"}`,children:a(c.balance)}),e.jsxs("span",{className:"balance__overview-detail",children:["Ingresos: ",a(c.incomes.total)," (≈ ",a(r(c.incomes.total),"USD"),")"]}),e.jsxs("span",{className:"balance__overview-detail",children:["Gastos: ",a(c.expenses.total)," (≈ ",a(r(c.expenses.total),"USD"),")"]})]})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),f(null),p(l)},className:"balance-filters",children:[e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{type:"date",name:"from",value:l.from,onChange:O,className:"balance-input"})]}),e.jsxs("label",{className:"balance-field",children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{type:"date",name:"to",value:l.to,onChange:O,className:"balance-input"})]}),e.jsx("button",{type:"submit",className:"balance-button",disabled:m,children:m?"Calculando...":"Aplicar filtros"})]}),m?e.jsx("p",{className:"balance__loading",children:"Calculando balance..."}):e.jsxs("div",{className:"balance-grid",children:[e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Ingresos"}),e.jsx("p",{className:"balance-card__value is-positive",children:a(c.incomes.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(r(c.incomes.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(c.incomes.bank)," (≈ ",a(r(c.incomes.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(c.incomes.cash)," (≈ ",a(r(c.incomes.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Gastos"}),e.jsx("p",{className:"balance-card__value is-negative",children:a(c.expenses.total)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(r(c.expenses.total),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Banco: ",a(c.expenses.bank)," (≈ ",a(r(c.expenses.bank),"USD"),")"]}),e.jsxs("p",{className:"balance-card__detail",children:["Efectivo: ",a(c.expenses.cash)," (≈ ",a(r(c.expenses.cash),"USD"),")"]})]}),e.jsxs("article",{className:"balance-card",children:[e.jsx("p",{className:"balance-card__title",children:"Resultado"}),e.jsx("p",{className:`balance-card__value ${c.balance>=0?"is-positive":"is-negative"}`,children:a(c.balance)}),e.jsxs("p",{className:"balance-card__detail",children:["≈ ",a(r(c.balance),"USD")]}),e.jsxs("p",{className:"balance-card__detail",children:["Actualizado al ",new Date(l.to).toLocaleDateString()]})]})]}),!m&&y.length>0?e.jsxs("section",{className:"balance-monthly",children:[e.jsxs("header",{className:"balance-monthly__header",children:[e.jsx("h2",{children:"Movimientos mensuales"}),e.jsx("p",{children:"Revisa cómo se comporta tu flujo de efectivo cada mes y cuánto saldo arrastras al siguiente."}),_.length>0?e.jsx("div",{className:"balance-monthly__selector",children:_.map(s=>e.jsxs("button",{type:"button",className:`balance-monthly__chip${s.month===g?" is-active":""}`,onClick:()=>L(s.month),children:[e.jsx("span",{className:"balance-monthly__chip-label",children:s.label}),e.jsxs("span",{className:"balance-monthly__chip-count",children:[s.netUsd>=0?"+":"",a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]},s.month))}):null]}),e.jsx("div",{className:"balance-monthly__grid",children:z.map(s=>e.jsxs("article",{className:"balance-monthly__card",children:[e.jsx("h3",{children:s.label}),e.jsxs("dl",{className:"balance-monthly__details",children:[e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo inicial"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryInUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryInNio)," (≈ ",a(s.carryInUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Ingresos"}),e.jsxs("dd",{className:"balance-monthly__number is-positive",children:[a(s.incomesNio)," (≈ ",a(s.incomesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Gastos"}),e.jsxs("dd",{className:"balance-monthly__number is-negative",children:[a(s.expensesNio)," (≈ ",a(s.expensesUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Resultado del mes"}),e.jsxs("dd",{className:`balance-monthly__number ${s.netUsd>=0?"is-positive":"is-negative"}`,children:[a(s.netNio)," (≈ ",a(s.netUsd,"USD"),")"]})]}),e.jsxs("div",{className:"balance-monthly__row",children:[e.jsx("dt",{children:"Saldo arrastrado"}),e.jsxs("dd",{className:`balance-monthly__number ${s.carryOutUsd>=0?"is-positive":"is-negative"}`,children:[a(s.carryOutNio)," (≈ ",a(s.carryOutUsd,"USD"),")"]})]})]})]},s.month))})]}):null,!m&&T&&y.length===0?e.jsx("p",{className:"balance-monthly__empty",children:"Registra ingresos y gastos para ver cómo se comporta tu balance mensual."}):null]})}export{Q as default};
