import{r as s,a as w,j as e}from"./index-BnMz-dVJ.js";import{u as ce,F as ie}from"./index.esm-BOEet2oi.js";import{A as Y,C as oe}from"./AccountSelector-CoiZYhMJ.js";import{f as ue}from"./accounts-62zbDqcc.js";const F={bank:"Cuenta bancaria",cash:"Efectivo"},de=[{value:"NIO",label:"CÃ³rdobas (NIO)"},{value:"USD",label:"DÃ³lares (USD)"}],z=t=>Number(t??0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),G=t=>{if(!t)return"";const c=/^([0-9]{4})-([0-9]{2})-([0-9]{2})/.exec(t);if(!c)return new Date(t).toLocaleDateString("es-NI");const[,p,f,i]=c;return new Date(Number(p),Number(f)-1,Number(i)).toLocaleDateString("es-NI")},H=(t=new Date)=>{const c=t.getFullYear(),p=String(t.getMonth()+1).padStart(2,"0"),f=String(t.getDate()).padStart(2,"0");return`${c}-${p}-${f}`};function J(t,c){return t==="cash"?F.cash:c?ue(c):F.bank}function pe(){const[t,c]=s.useState([]),[p,f]=s.useState(!0),[i,r]=s.useState(null),[D,x]=s.useState("list"),[y,o]=s.useState(null),[j,u]=s.useState(null),[d,I]=s.useState(null),[k,O]=s.useState(null),[K,M]=s.useState(!1),[E,R]=s.useState(!1),h=s.useCallback(()=>({amount:"",currency:"NIO",date:H(),source_type:"cash",source_account_id:"",destination_type:"bank",destination_account_id:"",note:""}),[]),l=ce({defaultValues:h()}),{handleSubmit:Q,reset:m,watch:g,setValue:V,formState:{isSubmitting:$}}=l,A=g("source_type"),L=g("destination_type"),q=g("source_account_id"),P=g("destination_account_id"),B=g("currency"),_=s.useCallback(async()=>{f(!0);try{const a=await w("/transfers");c(a??[]),r(null)}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudieron cargar las transferencias";r(n)}finally{f(!1)}},[]);s.useEffect(()=>{_()},[_]);const b=s.useMemo(()=>y?.currency??j?.currency??null,[y,j]);s.useEffect(()=>{if(!b){B||V("currency","NIO",{shouldDirty:!1,shouldValidate:!0});return}V("currency",b,{shouldDirty:!0,shouldValidate:!0})},[b,B,V]);const W=s.useCallback(({source:a,account:n})=>{o(a==="bank"&&n?n:null)},[]),X=s.useCallback(({source:a,account:n})=>{u(a==="bank"&&n?n:null)},[]);s.useEffect(()=>{A!=="bank"&&o(null)},[A]),s.useEffect(()=>{L!=="bank"&&u(null)},[L]);const N=s.useMemo(()=>!y||!j?!1:y.currency!==j.currency,[y,j]),S=s.useMemo(()=>A!=="bank"||L!=="bank"||!q||!P?!1:q===P,[q,P,A,L]);s.useEffect(()=>{!N&&i==="Las cuentas seleccionadas deben manejar la misma moneda."&&r(null)},[N,i]),s.useEffect(()=>{!S&&i==="Selecciona cuentas diferentes para origen y destino."&&r(null)},[S,i]);const U=s.useMemo(()=>t.reduce((a,n)=>{const T=n.currency??"NIO";return a[T]=(a[T]??0)+Number(n.amount??0),a},{}),[t]),Z=s.useCallback(a=>{x("create"),I(a),m({amount:a.amount!==void 0?String(a.amount):"",currency:a.currency??"NIO",date:a.date??H(),source_type:a.source_type??"cash",source_account_id:a.source_type==="bank"?a.source_account_id??"":"",destination_type:a.destination_type??"bank",destination_account_id:a.destination_type==="bank"?a.destination_account_id??"":"",note:a.note??""}),o(a.source_type==="bank"?a.source_account??null:null),u(a.destination_type==="bank"?a.destination_account??null:null),r(null)},[m]),v=s.useCallback(()=>{I(null),m(h()),o(null),u(null),r(null)},[h,m]),ee=s.useCallback(a=>{O(a),M(!0)},[]),ae=s.useCallback(()=>{E||(M(!1),O(null))},[E]),se=s.useCallback(async()=>{if(k){R(!0);try{await w(`/transfers/${k.id}`,{method:"DELETE"}),M(!1),O(null),r(null),d&&d.id===k.id&&v(),x("list"),await _()}catch(a){console.error(a);const n=a.payload?.message??a.message??"No se pudo eliminar la transferencia";r(n)}finally{R(!1)}}},[k,d,v,_]),C=!!d,ne=C?"Actualizar transferencia":"Registrar transferencia",te=C?"Cancelar ediciÃ³n":"Limpiar formulario",re=async a=>{if(S){r("Selecciona cuentas diferentes para origen y destino.");return}if(N){r("Las cuentas seleccionadas deben manejar la misma moneda.");return}try{const n={amount:Number(a.amount),currency:b??a.currency,date:a.date,source_type:a.source_type,source_account_id:a.source_type==="bank"&&a.source_account_id||null,destination_type:a.destination_type,destination_account_id:a.destination_type==="bank"&&a.destination_account_id||null,note:a.note?a.note.trim():null};d?await w(`/transfers/${d.id}`,{method:"PUT",body:n}):await w("/transfers",{method:"POST",body:n}),m(h()),o(null),u(null),r(null),I(null),x("list"),await _()}catch(n){console.error(n);const T=n.payload?.message??n.message??"No se pudo registrar la transferencia";r(T)}},le=$||N||S;return e.jsxs("div",{className:"transfers-page",children:[e.jsxs("header",{className:"transfers-header",children:[e.jsxs("div",{className:"transfers-heading",children:[e.jsx("h1",{children:"Transferencias"}),e.jsx("p",{children:"Registra movimientos internos entre tus cuentas y consulta el historial."})]}),e.jsxs("div",{className:"transfers-actions",children:[e.jsxs("button",{type:"button",className:`transfers-tab${D==="list"?" transfers-tab--active":""}`,onClick:()=>{x("list"),r(null)},children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ“‹"}),"Historial"]}),e.jsxs("button",{type:"button",className:`transfers-tab${D==="create"?" transfers-tab--active":""}`,onClick:()=>{x("create"),C?v():(m(h()),o(null),u(null),r(null))},children:[e.jsx("span",{"aria-hidden":!0,children:"âž•"}),"Nueva transferencia"]})]})]}),Object.keys(U).length?e.jsx("section",{className:"transfers-summary",children:Object.entries(U).map(([a,n])=>e.jsxs("article",{className:"transfers-summary-card",children:[e.jsxs("span",{className:"transfers-summary-label",children:["Total registrado (",a,")"]}),e.jsxs("strong",{className:"transfers-summary-amount",children:[z(n)," ",a]})]},a))}):null,i?e.jsx("p",{className:"transfers-error",children:i}):null,e.jsxs("div",{className:"transfers-content",children:[D==="create"?e.jsx(ie,{...l,children:e.jsxs("form",{className:"transfers-form",onSubmit:Q(re),children:[C?e.jsx("div",{className:"transfers-form-banner",children:e.jsxs("span",{children:["Editando transferencia registrada el ",G(d?.date),"."]})}):null,e.jsxs("div",{className:"transfers-form-grid",children:[e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Monto"}),e.jsx("input",{type:"number",min:"0",step:"0.01",inputMode:"decimal",...l.register("amount",{required:"Ingresa el monto a transferir.",min:{value:.01,message:"El monto debe ser mayor que cero."}})}),l.formState.errors.amount?e.jsx("small",{className:"field-error",children:l.formState.errors.amount.message}):null]}),e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Fecha"}),e.jsx("input",{type:"date",...l.register("date",{required:"Selecciona la fecha de la transferencia."})}),l.formState.errors.date?e.jsx("small",{className:"field-error",children:l.formState.errors.date.message}):null]}),e.jsxs("label",{className:"transfers-field",children:[e.jsx("span",{className:"transfers-field__label",children:"Moneda"}),e.jsxs("select",{...l.register("currency",{required:"Selecciona la moneda del movimiento."}),disabled:!!b,children:[e.jsx("option",{value:"",children:"Elige una moneda"}),de.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]}),l.formState.errors.currency?e.jsx("small",{className:"field-error",children:l.formState.errors.currency.message}):null,b?e.jsx("small",{className:"transfers-field__hint",children:"Moneda definida por la cuenta seleccionada."}):null]})]}),e.jsxs("div",{className:"transfers-selectors",children:[e.jsxs("div",{className:"transfers-selector",children:[e.jsx("h2",{children:"Cuenta de origen"}),e.jsx(Y,{sourceField:"source_type",accountField:"source_account_id",label:"Origen",accountLabel:"Cuenta bancaria origen",onAccountChange:W,containerClass:"transfers-account-selector"})]}),e.jsxs("div",{className:"transfers-selector",children:[e.jsx("h2",{children:"Cuenta de destino"}),e.jsx(Y,{sourceField:"destination_type",accountField:"destination_account_id",label:"Destino",accountLabel:"Cuenta bancaria destino",onAccountChange:X,containerClass:"transfers-account-selector",requiredAccountMessage:"Selecciona la cuenta bancaria de destino."})]})]}),N?e.jsx("p",{className:"transfers-warning",children:"Las cuentas de origen y destino deben compartir la misma moneda."}):null,S?e.jsx("p",{className:"transfers-warning",children:"No puedes transferir entre la misma cuenta bancaria."}):null,e.jsxs("label",{className:"transfers-field transfers-field--full",children:[e.jsx("span",{className:"transfers-field__label",children:"Nota (opcional)"}),e.jsx("textarea",{rows:3,placeholder:"Describe la transferencia para futuras referencias",...l.register("note",{maxLength:{value:255,message:"La nota no debe superar los 255 caracteres."}})}),l.formState.errors.note?e.jsx("small",{className:"field-error",children:l.formState.errors.note.message}):null]}),e.jsxs("div",{className:"transfers-form-actions",children:[e.jsx("button",{type:"submit",className:"transfers-submit",disabled:le,children:$?"Guardando...":ne}),e.jsx("button",{type:"button",className:"transfers-cancel",onClick:()=>{C?v():(m(h()),o(null),u(null),r(null))},disabled:$,children:te})]})]})}):null,D==="list"?e.jsx("section",{className:"transfers-list",children:p?e.jsx("p",{className:"transfers-placeholder",children:"Cargando transferencias..."}):t.length?e.jsx("div",{className:"transfers-table-wrapper",children:e.jsxs("table",{className:"transfers-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Origen"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Monto"}),e.jsx("th",{children:"Nota"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:t.map(a=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Fecha",children:G(a.date)}),e.jsxs("td",{"data-label":"Origen",children:[e.jsx("span",{className:"transfers-table-label",children:F[a.source_type]??a.source_type}),a.source_type==="bank"&&a.source_account?e.jsx("span",{className:"transfers-table-account",children:J(a.source_type,a.source_account)}):null]}),e.jsxs("td",{"data-label":"Destino",children:[e.jsx("span",{className:"transfers-table-label",children:F[a.destination_type]??a.destination_type}),a.destination_type==="bank"&&a.destination_account?e.jsx("span",{className:"transfers-table-account",children:J(a.destination_type,a.destination_account)}):null]}),e.jsxs("td",{"data-label":"Monto",className:"transfers-table-amount",children:[e.jsx("strong",{children:z(a.amount)}),e.jsx("span",{children:a.currency})]}),e.jsx("td",{"data-label":"Nota",children:a.note||"â€”"}),e.jsxs("td",{"data-label":"Acciones",className:"transfers-table-actions",children:[e.jsx("button",{type:"button",onClick:()=>Z(a),children:"Editar"}),e.jsx("button",{type:"button",onClick:()=>ee(a),children:"Eliminar"})]})]},a.id))})]})}):e.jsx("p",{className:"transfers-placeholder",children:"AÃºn no has registrado transferencias."})}):null]}),e.jsx(oe,{open:K,title:"Eliminar transferencia",message:"Esta acciÃ³n no se puede deshacer. Â¿Deseas eliminar la transferencia seleccionada?",confirmLabel:E?"Eliminando...":"Eliminar",cancelLabel:"Cancelar",confirmDisabled:E,onConfirm:se,onCancel:ae})]})}export{pe as default};
